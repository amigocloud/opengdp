<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>dwh: crefl/crefl.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.7.2 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li id="searchli">
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<h1>crefl/crefl.c</h1>  </div>
</div>
<div class="contents">
<a href="crefl_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment">Linux</span>
<a name="l00003"></a>00003 <span class="comment">  cc -O crefl.c -o crefl -I$HDFINC -L$HDFLIB -lmfhdf -ldf -lz -lm -ljpeg</span>
<a name="l00004"></a>00004 <span class="comment">*/</span>
<a name="l00005"></a>00005 
<a name="l00006"></a>00006 <span class="comment">/*************************************************************************</span>
<a name="l00007"></a>00007 <span class="comment">Description:</span>
<a name="l00008"></a>00008 <span class="comment"></span>
<a name="l00009"></a>00009 <span class="comment">  Simplified atmospheric correction algorithm that transforms MODIS</span>
<a name="l00010"></a>00010 <span class="comment">  top-of-the-atmosphere level-1B radiance data into corrected reflectance</span>
<a name="l00011"></a>00011 <span class="comment">  for Rapid Response applications.</span>
<a name="l00012"></a>00012 <span class="comment">  Required ancillary data: coarse resolution DEM tbase.hdf</span>
<a name="l00013"></a>00013 <span class="comment"></span>
<a name="l00014"></a>00014 <span class="comment">References and Credits:</span>
<a name="l00015"></a>00015 <span class="comment"></span>
<a name="l00016"></a>00016 <span class="comment">  Jacques Descloitres, MODIS Rapid Response Project, NASA/GSFC/SSAI</span>
<a name="l00017"></a>00017 <span class="comment">  http://rapidfire.sci.gsfc.nasa.gov</span>
<a name="l00018"></a>00018 <span class="comment"></span>
<a name="l00019"></a>00019 <span class="comment">Revision history:</span>
<a name="l00020"></a>00020 <span class="comment"></span>
<a name="l00021"></a>00021 <span class="comment">  Version 1.0   08/24/01</span>
<a name="l00022"></a>00022 <span class="comment">  Version 1.1   01/25/02</span>
<a name="l00023"></a>00023 <span class="comment">  Version 1.2   05/30/02</span>
<a name="l00024"></a>00024 <span class="comment">  Version 1.3   09/06/02</span>
<a name="l00025"></a>00025 <span class="comment">  Version 1.4   09/02/03</span>
<a name="l00026"></a>00026 <span class="comment">  Version 1.4.1 01/22/04</span>
<a name="l00027"></a>00027 <span class="comment">  Version 1.5   02/17/04</span>
<a name="l00028"></a>00028 <span class="comment">  Version 1.5.1 03/08/07 (not run in RR production)</span>
<a name="l00029"></a>00029 <span class="comment">  Version 1.5.2 06/07/07</span>
<a name="l00030"></a>00030 <span class="comment">  Version 1.6   08/18/09 (Be sure to update PROCESS_VERSION_NUMBER also)</span>
<a name="l00031"></a>00031 <span class="comment">                         Started with Version 1.5.2, version run in Rapid Response for several years,</span>
<a name="l00032"></a>00032 <span class="comment">                         this had several differences from 1.4.2, the DRL version, including the addition</span>
<a name="l00033"></a>00033 <span class="comment">                         of band 8 and a number of small, but perhaps important, computational changes</span>
<a name="l00034"></a>00034 <span class="comment">                         1) removed most code within #ifdef DEBUG clauses</span>
<a name="l00035"></a>00035 <span class="comment">                         2) left command line options for nearest, TOA, and sealevel; note that these options</span>
<a name="l00036"></a>00036 <span class="comment">                            were in Version 1.4.2 but were not available from the command line</span>
<a name="l00037"></a>00037 <span class="comment">                         3) changes by DRL to 1.4.2 to write scale factor and offset has already been </span>
<a name="l00038"></a>00038 <span class="comment">                            incorporated into 1.5.2</span>
<a name="l00039"></a>00039 <span class="comment">                         4) Added in the modifications from Chuanmin Hu &amp; Brock Murch of Univ South Florida</span>
<a name="l00040"></a>00040 <span class="comment">                            IMaRS to add bands 9-16.  The aO3 and taur0 parameters came &quot;from SeaDAS codes&quot;</span>
<a name="l00041"></a>00041 <span class="comment">                            and &quot;The H2O parameters can be assumed 0 for bands 8-16 because those bands were</span>
<a name="l00042"></a>00042 <span class="comment">                            designed to avoid water vapor absorption.&quot;</span>
<a name="l00043"></a>00043 <span class="comment">                         Disclaimer: the nearest, TOA, and sealevel options and bands 9-16 are not used</span>
<a name="l00044"></a>00044 <span class="comment">                                     by Rapid Response so I cannot consider them tested/validated - JES</span>
<a name="l00045"></a>00045 <span class="comment"></span>
<a name="l00046"></a>00046 <span class="comment">*************************************************************************/</span>
<a name="l00047"></a>00047 
<a name="l00048"></a><a class="code" href="crefl_8c.html#ae2ceec62d3c6999bcb8db8df4d44a6d0">00048</a> <span class="preprocessor">#define PROCESS_VERSION_NUMBER &quot;1.7.1&quot;</span>
<a name="l00049"></a>00049 <span class="preprocessor"></span>
<a name="l00050"></a>00050 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include &lt;math.h&gt;</span>
<a name="l00053"></a>00053 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00054"></a>00054 <span class="preprocessor">#include &lt;getopt.h&gt;</span>
<a name="l00055"></a>00055 <span class="preprocessor">#include &quot;mfhdf.h&quot;</span>
<a name="l00056"></a>00056 
<a name="l00057"></a><a class="code" href="crefl_8c.html#a259ba7f6d71802538b624c40cda673f9">00057</a> <span class="preprocessor">#define MAXNAMELENGTH 200</span>
<a name="l00058"></a><a class="code" href="crefl_8c.html#a4f9b6b07384112c4eb1ee3b543a08a62">00058</a> <span class="preprocessor"></span><span class="preprocessor">#define Nbands 16</span>
<a name="l00059"></a><a class="code" href="crefl_8c.html#af7e8592d0a634bd3642e9fd508ea8022">00059</a> <span class="preprocessor"></span><span class="preprocessor">#define DEG2RAD 0.0174532925199         </span><span class="comment">/* PI/180 */</span>
<a name="l00060"></a><a class="code" href="crefl_8c.html#a9f68c2ad43642fe98df91b43835d6f2e">00060</a> <span class="preprocessor">#define UO3     0.319</span>
<a name="l00061"></a><a class="code" href="crefl_8c.html#abde039e8a3c3c7b0b6fc9764cc901470">00061</a> <span class="preprocessor"></span><span class="preprocessor">#define UH2O    2.93</span>
<a name="l00062"></a><a class="code" href="crefl_8c.html#a8ad1a159ebf33df169fbdc20cc94571c">00062</a> <span class="preprocessor"></span><span class="preprocessor">#define REFLMIN -0.01</span>
<a name="l00063"></a><a class="code" href="crefl_8c.html#a4589297297b7c4f6867c80dfdb004018">00063</a> <span class="preprocessor"></span><span class="preprocessor">#define REFLMAX  1.6</span>
<a name="l00064"></a><a class="code" href="crefl_8c.html#aa8ea6218db4861be2905405d42c99f42">00064</a> <span class="preprocessor"></span><span class="preprocessor">#define ANCPATH         &quot;.&quot;</span>
<a name="l00065"></a><a class="code" href="crefl_8c.html#a00bbca4f07b1f8f4cd06106a945bc61e">00065</a> <span class="preprocessor"></span><span class="preprocessor">#define DEMFILENAME     &quot;tbase.hdf&quot;</span>
<a name="l00066"></a><a class="code" href="crefl_8c.html#a1eb8991a722c9cecf996fd0e85e47892">00066</a> <span class="preprocessor"></span><span class="preprocessor">#define DEMSDSNAME      &quot;Elevation&quot;</span>
<a name="l00067"></a><a class="code" href="crefl_8c.html#a4fa71a95176afc5b14dbdd117890cd4c">00067</a> <span class="preprocessor"></span><span class="preprocessor">#define REFSDS  SOLZ</span>
<a name="l00068"></a><a class="code" href="crefl_8c.html#a1ef400bc1b6d2383b782aec27e4b4c73">00068</a> <span class="preprocessor"></span><span class="preprocessor">#define MISSING -2</span>
<a name="l00069"></a><a class="code" href="crefl_8c.html#a0ab2dcca54f03c77aac9fb4592e671bc">00069</a> <span class="preprocessor"></span><span class="preprocessor">#define SATURATED       -3</span>
<a name="l00070"></a><a class="code" href="crefl_8c.html#a44faa6cba7ac0e034635d2cc667fbb7e">00070</a> <span class="preprocessor"></span><span class="preprocessor">#define MAXSOLZ 86.5</span>
<a name="l00071"></a><a class="code" href="crefl_8c.html#aee905362b059f0c9d4466977c7a3407a">00071</a> <span class="preprocessor"></span><span class="preprocessor">#define MAXAIRMASS 18</span>
<a name="l00072"></a><a class="code" href="crefl_8c.html#a551b147394989bc98f19d35ce3a14717">00072</a> <span class="preprocessor"></span><span class="preprocessor">#define SCALEHEIGHT 8000</span>
<a name="l00073"></a><a class="code" href="crefl_8c.html#a9f4ec3e2b6961eb728a0972dd558076c">00073</a> <span class="preprocessor"></span><span class="preprocessor">#define FILL_INT16      -32768</span>
<a name="l00074"></a><a class="code" href="crefl_8c.html#ac73cf6d49edeb864e94ba04a5917fa90">00074</a> <span class="preprocessor"></span><span class="preprocessor">#define NUM1KMCOLPERSCAN        1354</span>
<a name="l00075"></a><a class="code" href="crefl_8c.html#abde84ab82c507dacae8601d156422db2">00075</a> <span class="preprocessor"></span><span class="preprocessor">#define NUM1KMROWPERSCAN        10</span>
<a name="l00076"></a><a class="code" href="crefl_8c.html#a5a1be37d2274dad16693d290ece9c4b3">00076</a> <span class="preprocessor"></span><span class="preprocessor">#define TAUSTEP4SPHALB          0.0001</span>
<a name="l00077"></a><a class="code" href="crefl_8c.html#af6a2d2bec94fbd9fdb4cd1d2819e0c98">00077</a> <span class="preprocessor"></span><span class="preprocessor">#define MAXNUMSPHALBVALUES      4000            </span><span class="comment">/* with no aerosol taur &lt;= 0.4 in all bands everywhere */</span>
<a name="l00078"></a>00078 
<a name="l00079"></a>00079 <span class="comment">/**************************************************************************/</span>
<a name="l00083"></a><a class="code" href="struct_s_d_s.html">00083</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00084"></a><a class="code" href="struct_s_d_s.html#a5ac083a645d964373f022d03df4849c8">00084</a>     <span class="keywordtype">char</span> *<a class="code" href="struct_s_d_s.html#a5ac083a645d964373f022d03df4849c8">name</a>;
<a name="l00085"></a><a class="code" href="struct_s_d_s.html#aeac90097f29f7529968697163cea5c18">00085</a>     <span class="keywordtype">char</span> *<a class="code" href="struct_s_d_s.html#aeac90097f29f7529968697163cea5c18">filename</a>;
<a name="l00086"></a><a class="code" href="struct_s_d_s.html#a797dbc1344311c85615adc59b0070867">00086</a>     int32 <a class="code" href="struct_s_d_s.html#a797dbc1344311c85615adc59b0070867">file_id</a>;
<a name="l00087"></a><a class="code" href="struct_s_d_s.html#a51be18c1422c1f14d31c199caf6642e6">00087</a>     int32 <a class="code" href="struct_s_d_s.html#a51be18c1422c1f14d31c199caf6642e6">id</a>;
<a name="l00088"></a><a class="code" href="struct_s_d_s.html#a15e1b067c35ac56aa9973ab69ddb0cd3">00088</a>     int32 <a class="code" href="struct_s_d_s.html#a15e1b067c35ac56aa9973ab69ddb0cd3">index</a>;
<a name="l00089"></a><a class="code" href="struct_s_d_s.html#a0e5f7647ec94a04f8e306e7a5db2facd">00089</a>     int32 <a class="code" href="struct_s_d_s.html#a0e5f7647ec94a04f8e306e7a5db2facd">num_type</a>;
<a name="l00090"></a><a class="code" href="struct_s_d_s.html#a06c075abcc246ce8cb3a327f90002328">00090</a>     int32 <a class="code" href="struct_s_d_s.html#a06c075abcc246ce8cb3a327f90002328">rank</a>;
<a name="l00091"></a><a class="code" href="struct_s_d_s.html#a1fb7c3b2401f8c72d84afd97d87442ee">00091</a>     int32 <a class="code" href="struct_s_d_s.html#a1fb7c3b2401f8c72d84afd97d87442ee">n_attr</a>;
<a name="l00092"></a><a class="code" href="struct_s_d_s.html#a5c6d246108e3d9140aa1d36727343589">00092</a>     int32 <a class="code" href="struct_s_d_s.html#a5c6d246108e3d9140aa1d36727343589">Nl</a>;
<a name="l00093"></a><a class="code" href="struct_s_d_s.html#a0ebeb3f80372d82ebedc44076e6b7809">00093</a>     int32 <a class="code" href="struct_s_d_s.html#a0ebeb3f80372d82ebedc44076e6b7809">Np</a>;
<a name="l00094"></a><a class="code" href="struct_s_d_s.html#a03b3ea497dc38ec2e797ce2b2058dafe">00094</a>     int32 *<a class="code" href="struct_s_d_s.html#a03b3ea497dc38ec2e797ce2b2058dafe">plane</a>;
<a name="l00095"></a><a class="code" href="struct_s_d_s.html#a4856b2eb38d69b8ac5e0a1fb32609b6f">00095</a>     int32 <a class="code" href="struct_s_d_s.html#a4856b2eb38d69b8ac5e0a1fb32609b6f">Nplanes</a>;
<a name="l00096"></a><a class="code" href="struct_s_d_s.html#a94bb1507581010e63fe8f8d380a964dc">00096</a>     int32 <a class="code" href="struct_s_d_s.html#a94bb1507581010e63fe8f8d380a964dc">rowsperscan</a>;
<a name="l00097"></a><a class="code" href="struct_s_d_s.html#af79d8d684d5badfef6d6a5e50c970c18">00097</a>     int32 <a class="code" href="somfor_8c.html#a45314566a84a31f43e6435d1eb24d4ec">start</a>[MAX_VAR_DIMS];
<a name="l00098"></a><a class="code" href="struct_s_d_s.html#ae4e2e1f4bcbc4bee7383f9bfb0c7efe4">00098</a>     int32 edges[MAX_VAR_DIMS];
<a name="l00099"></a><a class="code" href="struct_s_d_s.html#a6adc2e571f8eea012d219d86ef529e3f">00099</a>     int32 dim_sizes[MAX_VAR_DIMS];
<a name="l00100"></a><a class="code" href="struct_s_d_s.html#a735984d41155bc1032e09bece8f8d66d">00100</a>     <span class="keywordtype">void</span> *<a class="code" href="struct_s_d_s.html#a735984d41155bc1032e09bece8f8d66d">data</a>;
<a name="l00101"></a><a class="code" href="struct_s_d_s.html#ac5abb67b2d2204c1dba5fd732876b853">00101</a>     <span class="keywordtype">void</span> *<a class="code" href="struct_s_d_s.html#ac5abb67b2d2204c1dba5fd732876b853">fillvalue</a>;
<a name="l00102"></a><a class="code" href="struct_s_d_s.html#a807c87944de39fa4f4f27272ce63cd14">00102</a>     float64 <a class="code" href="struct_s_d_s.html#a807c87944de39fa4f4f27272ce63cd14">factor</a>;
<a name="l00103"></a><a class="code" href="struct_s_d_s.html#aa24cece8b1c8bcc4268ed11c89fcda91">00103</a>     float64 <a class="code" href="struct_s_d_s.html#aa24cece8b1c8bcc4268ed11c89fcda91">offset</a>;
<a name="l00104"></a>00104 } <a class="code" href="struct_s_d_s.html">SDS</a>;
<a name="l00105"></a>00105 
<a name="l00106"></a>00106 <span class="comment">/**************************************************************************/</span>
<a name="l00110"></a><a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba112ff6b056e2dbe15e707410768324b8">00110</a> <span class="keyword">enum</span> {<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba9fbad3dfb641b1136d4d8d687d95cd6b">BAND1</a>, <a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba810e3a7a148b98f1ddf594439e165583">BAND2</a>, <a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba10ffd1b40afc860b05637567b4252032">BAND3</a>, <a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55baaad5ed9d733ddb56030fd974aeba5c2b">BAND4</a>, <a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba018d60ba72eb679100259c19f81cf687">BAND5</a>, <a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55baa7fff757ecd5854378b206732608fb9c">BAND6</a>, <a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba4e34f17c478d52f16abdd42f4dcb7981">BAND7</a>, <a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba3a905a86ba7635d02535561e1e0b21ad">BAND8</a>, <a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba112ff6b056e2dbe15e707410768324b8">BAND9</a>, <a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba7eca15ec1234cf4ac2a5cff2c908d2f4">BAND10</a>,
<a name="l00111"></a><a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55bad8f798e8c6187b0f954f8e1c5242676c">00111</a>     <a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba244c126e4f73780c411a057931eadcf8">BAND11</a>, <a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba511ff877c25560fb73952651b272c5f7">BAND12</a>, <a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba8c254a2be094a72cac40ff3b12c5bcc4">BAND13</a>, <a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55bab0776b3892318b8d9badfb256b84cca3">BAND14</a>, <a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba1c399d152e63f8fb4ea0c719d44b30e4">BAND15</a>, <a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55babd51a0ee442a2fadcd18d769efcaf80a">BAND16</a>, <a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55bad8f798e8c6187b0f954f8e1c5242676c">SOLZ</a>, <a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55bacc111a7dd4eead6275985b9364cd1acf">SENZ</a>, <a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba121b0531d586fd21bc238b45301e91e6">SOLA</a>, <a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba5beedd32e3c0e217293f68703b0791ad">SENA</a>,
<a name="l00112"></a><a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba8b602b8b0906ba2c4717e163f1478c8f">00112</a>     <a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba99d3d71739b89a1e680a59b017d8ab5a">LON</a>, <a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba40df096e8ca19a820dbd94de79e97b3b">LAT</a>, <a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba8b602b8b0906ba2c4717e163f1478c8f">Nitems</a>};
<a name="l00113"></a>00113 
<a name="l00114"></a>00114 <span class="comment">/**************************************************************************/</span>
<a name="l00118"></a><a class="code" href="crefl_8c.html#adf764cbdea00d65edcd07bb9953ad2b7ab68b8c7682e25ef3e8811b477033ff71">00118</a> <span class="keyword">enum</span> {<a class="code" href="crefl_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a452c3898e38e3afd59ea4e5f301f93e4">INPUT_1KM</a>, <a class="code" href="crefl_8c.html#adf764cbdea00d65edcd07bb9953ad2b7ac30114f16e63da819602bbff904da486">INPUT_500M</a>, <a class="code" href="crefl_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a471d277dddd138c78232bb6fef807a8e">INPUT_250M</a>, <a class="code" href="crefl_8c.html#adf764cbdea00d65edcd07bb9953ad2b7ab68b8c7682e25ef3e8811b477033ff71">INPUT_UNKNOWN</a>};
<a name="l00119"></a>00119 
<a name="l00120"></a>00120 
<a name="l00121"></a>00121 
<a name="l00122"></a>00122 <span class="keywordtype">void</span> <a class="code" href="crefl_8c.html#ae8605e2b78cd4a81b6c6b5c30cb7366a">usage</a>(<span class="keywordtype">void</span>);
<a name="l00123"></a>00123 <span class="keywordtype">int</span> <a class="code" href="crefl_8c.html#ace1410b6373bee65bb550f176eebb328">input_file_type</a>(<span class="keywordtype">char</span> *file);
<a name="l00124"></a>00124 <span class="keywordtype">int</span> <a class="code" href="crefl_8c.html#ac168e5666e1a7b5a0d8212db5d8ea2f2">parse_bands</a>(<span class="keywordtype">char</span> *bandstr, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> process[<a class="code" href="crefl_8c.html#a4f9b6b07384112c4eb1ee3b543a08a62">Nbands</a>]);
<a name="l00125"></a>00125 <span class="keywordtype">int</span> <a class="code" href="crefl_8c.html#afaf023b21ea740b2575e5d3bb2b84ccf">range_check</a>(<span class="keywordtype">float</span> x, <span class="keywordtype">float</span> xmin, <span class="keywordtype">float</span> xmax);
<a name="l00126"></a>00126 
<a name="l00127"></a>00127 <span class="keywordtype">void</span> <a class="code" href="crefl_8c.html#a6866fc1eecb97cefe4e1cc38c302f18a">set_dimnames</a>(<span class="keywordtype">int</span> samples, <span class="keywordtype">char</span> **dimname1, <span class="keywordtype">char</span> **dimname2);
<a name="l00128"></a>00128 
<a name="l00129"></a>00129 <span class="keywordtype">int</span> <a class="code" href="crefl_8c.html#a0d5302aebefded49b66860d05d1724e5">init_output_sds</a>(int32 sd_id, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *process, <a class="code" href="struct_s_d_s.html">SDS</a> outsds[<a class="code" href="crefl_8c.html#a4f9b6b07384112c4eb1ee3b543a08a62">Nbands</a>], <a class="code" href="struct_s_d_s.html">SDS</a> sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba8b602b8b0906ba2c4717e163f1478c8f">Nitems</a>],
<a name="l00130"></a>00130                     <span class="keywordtype">int</span> gzip, <span class="keywordtype">int</span> verbose);
<a name="l00131"></a>00131 <span class="keywordtype">int</span> <a class="code" href="crefl_8c.html#a589b7cfecc8c4364dac950d290feaf78">write_scan</a>(<span class="keywordtype">int</span> iscan, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *process, <a class="code" href="struct_s_d_s.html">SDS</a> outsds[<a class="code" href="crefl_8c.html#a4f9b6b07384112c4eb1ee3b543a08a62">Nbands</a>]);
<a name="l00132"></a>00132 <span class="keywordtype">int</span> <a class="code" href="crefl_8c.html#a643f58417a2090718c068e57aade5fec">read_scan</a>(<span class="keywordtype">int</span> iscan, <a class="code" href="struct_s_d_s.html">SDS</a> sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba8b602b8b0906ba2c4717e163f1478c8f">Nitems</a>]);
<a name="l00133"></a>00133 <span class="keywordtype">int</span> <a class="code" href="crefl_8c.html#a3637dc4696007f69ab959a1389462340">write_global_attributes</a>(int32 sd_id, <span class="keywordtype">char</span> *MOD021KMfile,
<a name="l00134"></a>00134                             <span class="keywordtype">char</span> *MOD02HKMfile, <span class="keywordtype">char</span> *MOD02QKMfile, <span class="keywordtype">float</span> maxsolz,
<a name="l00135"></a>00135                             <span class="keywordtype">int</span> sealevel, <span class="keywordtype">int</span> TOA, <span class="keywordtype">int</span> nearest);
<a name="l00136"></a>00136 
<a name="l00137"></a>00137 <span class="keywordtype">int</span> <a class="code" href="crefl_8c.html#a27b2413ebdde89ebd0754edb8876f760">getatmvariables</a>(<span class="keywordtype">float</span> mus, <span class="keywordtype">float</span> muv, <span class="keywordtype">float</span> phi, int16 height,
<a name="l00138"></a>00138                     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *process, <span class="keywordtype">float</span> *sphalb, <span class="keywordtype">float</span> *rhoray, <span class="keywordtype">float</span> *TtotraytH2O, <span class="keywordtype">float</span> *tOG);
<a name="l00139"></a>00139 <span class="keywordtype">void</span> <a class="code" href="crefl_8c.html#abbfcb540f5fce9793ba5dba5999c2faa">chand</a>(<span class="keywordtype">float</span> phi, <span class="keywordtype">float</span> muv, <span class="keywordtype">float</span> mus, <span class="keywordtype">float</span> *tau, <span class="keywordtype">float</span> *rhoray, <span class="keywordtype">float</span> *trup,
<a name="l00140"></a>00140            <span class="keywordtype">float</span> *trdown, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *process);
<a name="l00141"></a>00141 <span class="keywordtype">float</span> <a class="code" href="crefl_8c.html#ab9705155ea4f0c46072efc3aa00b5dee">csalbr</a>(<span class="keywordtype">float</span> tau);
<a name="l00142"></a>00142 <span class="keywordtype">double</span> <a class="code" href="crefl_8c.html#a01e2f31f276b24f9ee12213c491f5a0a">fintexp1</a>(<span class="keywordtype">float</span> tau);
<a name="l00143"></a>00143 <span class="keywordtype">double</span> <a class="code" href="crefl_8c.html#ac95fa41b280daf374c11feb460974857">fintexp3</a>(<span class="keywordtype">float</span> tau);
<a name="l00144"></a>00144 <span class="keywordtype">float</span> <a class="code" href="crefl_8c.html#aced7c98f03682fc136412cfea6a13d10">correctedrefl</a>(<span class="keywordtype">float</span> refl, <span class="keywordtype">float</span> TtotraytH2O, <span class="keywordtype">float</span> tOG, <span class="keywordtype">float</span> rhoray, <span class="keywordtype">float</span> sphalb);
<a name="l00145"></a>00145 <span class="keywordtype">int</span> <a class="code" href="crefl_8c.html#a64cbe8c9b98670a4a456f0ff29fc3abe">interp_dem</a>(<span class="keywordtype">float</span> lat, <span class="keywordtype">float</span> lon, <a class="code" href="struct_s_d_s.html">SDS</a> *dem);
<a name="l00146"></a>00146 
<a name="l00147"></a>00147 <span class="comment">/******************************************************************************</span>
<a name="l00148"></a>00148 <span class="comment"></span>
<a name="l00149"></a>00149 <span class="comment">main</span>
<a name="l00150"></a>00150 <span class="comment">******************************************************************************/</span>
<a name="l00151"></a>00151 
<a name="l00152"></a><a class="code" href="crefl_8c.html#a0ddf1224851353fc92bfbff6f499fa97">00152</a> <span class="keywordtype">int</span> <a class="code" href="crefl_8c.html#a0ddf1224851353fc92bfbff6f499fa97">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l00153"></a>00153 {
<a name="l00154"></a>00154     <span class="keywordtype">char</span> *MOD021KMfile, *MOD02HKMfile, *MOD02QKMfile;
<a name="l00155"></a>00155     <span class="keywordtype">char</span> *filename;     <span class="comment">/* output file */</span>
<a name="l00156"></a>00156 
<a name="l00157"></a>00157     FILE *fp;
<a name="l00158"></a>00158     <span class="keywordtype">int</span> outfile_exists;
<a name="l00159"></a>00159 
<a name="l00160"></a>00160     <span class="keywordtype">char</span> *ancpath;
<a name="l00161"></a>00161     <a class="code" href="struct_s_d_s.html">SDS</a> sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba8b602b8b0906ba2c4717e163f1478c8f">Nitems</a>], outsds[<a class="code" href="crefl_8c.html#a4f9b6b07384112c4eb1ee3b543a08a62">Nbands</a>], dem, height;
<a name="l00162"></a>00162     int32 MOD02QKMfile_id, MOD02HKMfile_id, MOD021KMfile_id;
<a name="l00163"></a>00163     int32 sd_id, attr_index, count, num_type;
<a name="l00164"></a>00164 
<a name="l00165"></a>00165     <span class="keywordtype">int</span> ib, j, iscan, Nscans, irow, jcol, idx, crsidx;
<a name="l00166"></a>00166     <span class="keywordtype">int</span> nbands;
<a name="l00167"></a>00167 
<a name="l00168"></a>00168     <span class="keywordtype">char</span> *SDSlocatorQKM[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba8b602b8b0906ba2c4717e163f1478c8f">Nitems</a>] = {<span class="stringliteral">&quot;EV_250_RefSB&quot;</span>, <span class="stringliteral">&quot;EV_250_RefSB&quot;</span>,
<a name="l00169"></a>00169         <span class="stringliteral">&quot;EV_500_RefSB&quot;</span>, <span class="stringliteral">&quot;EV_500_RefSB&quot;</span>, <span class="stringliteral">&quot;EV_500_RefSB&quot;</span>,
<a name="l00170"></a>00170         <span class="stringliteral">&quot;EV_500_RefSB&quot;</span>, <span class="stringliteral">&quot;EV_500_RefSB&quot;</span>,<span class="stringliteral">&quot;EV_1KM_RefSB&quot;</span>, <span class="stringliteral">&quot;EV_1KM_RefSB&quot;</span>,
<a name="l00171"></a>00171         <span class="stringliteral">&quot;EV_1KM_RefSB&quot;</span>, <span class="stringliteral">&quot;EV_1KM_RefSB&quot;</span>, <span class="stringliteral">&quot;EV_1KM_RefSB&quot;</span>, <span class="stringliteral">&quot;EV_1KM_RefSB&quot;</span>,
<a name="l00172"></a>00172         <span class="stringliteral">&quot;EV_1KM_RefSB&quot;</span>, <span class="stringliteral">&quot;EV_1KM_RefSB&quot;</span>, <span class="stringliteral">&quot;EV_1KM_RefSB&quot;</span>, <span class="stringliteral">&quot;SolarZenith&quot;</span>,
<a name="l00173"></a>00173         <span class="stringliteral">&quot;SensorZenith&quot;</span>, <span class="stringliteral">&quot;SolarAzimuth&quot;</span>, <span class="stringliteral">&quot;SensorAzimuth&quot;</span>, <span class="stringliteral">&quot;Longitude&quot;</span>,
<a name="l00174"></a>00174         <span class="stringliteral">&quot;Latitude&quot;</span>};
<a name="l00175"></a>00175 
<a name="l00176"></a>00176     <span class="keywordtype">char</span> *SDSlocatorHKM[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba8b602b8b0906ba2c4717e163f1478c8f">Nitems</a>] = {<span class="stringliteral">&quot;EV_250_Aggr500_RefSB&quot;</span>,
<a name="l00177"></a>00177         <span class="stringliteral">&quot;EV_250_Aggr500_RefSB&quot;</span>, <span class="stringliteral">&quot;EV_500_RefSB&quot;</span>, <span class="stringliteral">&quot;EV_500_RefSB&quot;</span>,
<a name="l00178"></a>00178         <span class="stringliteral">&quot;EV_500_RefSB&quot;</span>, <span class="stringliteral">&quot;EV_500_RefSB&quot;</span>, <span class="stringliteral">&quot;EV_500_RefSB&quot;</span>,
<a name="l00179"></a>00179         <span class="stringliteral">&quot;EV_1KM_RefSB&quot;</span>,<span class="stringliteral">&quot;EV_1KM_RefSB&quot;</span>,<span class="stringliteral">&quot;EV_1KM_RefSB&quot;</span>,
<a name="l00180"></a>00180         <span class="stringliteral">&quot;EV_1KM_RefSB&quot;</span>,<span class="stringliteral">&quot;EV_1KM_RefSB&quot;</span>,<span class="stringliteral">&quot;EV_1KM_RefSB&quot;</span>, <span class="stringliteral">&quot;EV_1KM_RefSB&quot;</span>,
<a name="l00181"></a>00181         <span class="stringliteral">&quot;EV_1KM_RefSB&quot;</span>, <span class="stringliteral">&quot;EV_1KM_RefSB&quot;</span>, <span class="stringliteral">&quot;SolarZenith&quot;</span>,
<a name="l00182"></a>00182         <span class="stringliteral">&quot;SensorZenith&quot;</span>, <span class="stringliteral">&quot;SolarAzimuth&quot;</span>, <span class="stringliteral">&quot;SensorAzimuth&quot;</span>, <span class="stringliteral">&quot;Longitude&quot;</span>,
<a name="l00183"></a>00183         <span class="stringliteral">&quot;Latitude&quot;</span>};
<a name="l00184"></a>00184 
<a name="l00185"></a>00185     <span class="keywordtype">char</span> *SDSlocator1KM[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba8b602b8b0906ba2c4717e163f1478c8f">Nitems</a>] = {<span class="stringliteral">&quot;EV_250_Aggr1km_RefSB&quot;</span>,
<a name="l00186"></a>00186         <span class="stringliteral">&quot;EV_250_Aggr1km_RefSB&quot;</span>, <span class="stringliteral">&quot;EV_500_Aggr1km_RefSB&quot;</span>,
<a name="l00187"></a>00187         <span class="stringliteral">&quot;EV_500_Aggr1km_RefSB&quot;</span>, <span class="stringliteral">&quot;EV_500_Aggr1km_RefSB&quot;</span>,
<a name="l00188"></a>00188         <span class="stringliteral">&quot;EV_500_Aggr1km_RefSB&quot;</span>,  <span class="stringliteral">&quot;EV_500_Aggr1km_RefSB&quot;</span>,
<a name="l00189"></a>00189         <span class="stringliteral">&quot;EV_1KM_RefSB&quot;</span>, <span class="stringliteral">&quot;EV_1KM_RefSB&quot;</span>, <span class="stringliteral">&quot;EV_1KM_RefSB&quot;</span>, <span class="stringliteral">&quot;EV_1KM_RefSB&quot;</span>,
<a name="l00190"></a>00190         <span class="stringliteral">&quot;EV_1KM_RefSB&quot;</span>, <span class="stringliteral">&quot;EV_1KM_RefSB&quot;</span>,
<a name="l00191"></a>00191         <span class="stringliteral">&quot;EV_1KM_RefSB&quot;</span>, <span class="stringliteral">&quot;EV_1KM_RefSB&quot;</span>, <span class="stringliteral">&quot;EV_1KM_RefSB&quot;</span>, <span class="stringliteral">&quot;SolarZenith&quot;</span>,
<a name="l00192"></a>00192         <span class="stringliteral">&quot;SensorZenith&quot;</span>, <span class="stringliteral">&quot;SolarAzimuth&quot;</span>, <span class="stringliteral">&quot;SensorAzimuth&quot;</span>, <span class="stringliteral">&quot;Longitude&quot;</span>,
<a name="l00193"></a>00193         <span class="stringliteral">&quot;Latitude&quot;</span>};
<a name="l00194"></a>00194 
<a name="l00195"></a>00195     <span class="keywordtype">char</span> indexlocator[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba8b602b8b0906ba2c4717e163f1478c8f">Nitems</a>] = {0, 1, 0, 1, 2, 3, 4, 0, 1, 2, 3, 4, 5, 7,
<a name="l00196"></a>00196         9, 10, 0, 0, 0, 0, 0, 0};
<a name="l00197"></a>00197 
<a name="l00198"></a>00198     <span class="keywordtype">char</span> numtypelocator[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba8b602b8b0906ba2c4717e163f1478c8f">Nitems</a>] = {DFNT_UINT16, DFNT_UINT16, DFNT_UINT16,
<a name="l00199"></a>00199         DFNT_UINT16, DFNT_UINT16, DFNT_UINT16, DFNT_UINT16,
<a name="l00200"></a>00200         DFNT_UINT16, DFNT_UINT16, DFNT_UINT16, DFNT_UINT16,
<a name="l00201"></a>00201         DFNT_UINT16, DFNT_UINT16, DFNT_UINT16, DFNT_UINT16,
<a name="l00202"></a>00202         DFNT_UINT16, DFNT_INT16, DFNT_INT16, DFNT_INT16, DFNT_INT16,
<a name="l00203"></a>00203         DFNT_FLOAT32, DFNT_FLOAT32};
<a name="l00204"></a>00204 
<a name="l00205"></a>00205     int16 *l1bdata[<a class="code" href="crefl_8c.html#a4f9b6b07384112c4eb1ee3b543a08a62">Nbands</a>], *sola, *solz, *sena, *senz, *solzfill;
<a name="l00206"></a>00206     float32 *lon, *lat, *lonfill, *latfill;
<a name="l00207"></a>00207     <span class="keywordtype">char</span> *attr_name;
<a name="l00208"></a>00208     float64 scale_factor[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba8b602b8b0906ba2c4717e163f1478c8f">Nitems</a>], add_offset[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba8b602b8b0906ba2c4717e163f1478c8f">Nitems</a>];
<a name="l00209"></a>00209 
<a name="l00210"></a>00210     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> process[<a class="code" href="crefl_8c.html#a4f9b6b07384112c4eb1ee3b543a08a62">Nbands</a>];
<a name="l00211"></a>00211 
<a name="l00212"></a>00212     <span class="keywordtype">float</span> refl, *mus, muv, phi;
<a name="l00213"></a>00213     <span class="keywordtype">float</span> *rhoray, *sphalb, *TtotraytH2O, *tOG;
<a name="l00214"></a>00214     <span class="keywordtype">int</span> aggfactor, crsrow1, crsrow2, crscol1, crscol2;
<a name="l00215"></a>00215     <span class="keywordtype">int</span> crsidx11, crsidx12, crsidx21, crsidx22;
<a name="l00216"></a>00216     <span class="keywordtype">float</span> mus0, mus11, mus12, mus21, mus22;
<a name="l00217"></a>00217     <span class="keywordtype">float</span> fractrow, fractcol, <a class="code" href="somfor_8c.html#a87accd1af8e0aff4b818d891374f7cec">t</a>, <a class="code" href="omerfor_8c.html#aed08c8478a62910aab06ba708a0e5b5f">u</a>;
<a name="l00218"></a>00218     <span class="keywordtype">float</span> rhoray0, rhoray11, rhoray12, rhoray21, rhoray22;
<a name="l00219"></a>00219     <span class="keywordtype">float</span> sphalb0, sphalb11, sphalb12, sphalb21, sphalb22;
<a name="l00220"></a>00220     <span class="keywordtype">float</span> reflmin=<a class="code" href="crefl_8c.html#a8ad1a159ebf33df169fbdc20cc94571c">REFLMIN</a>, reflmax=<a class="code" href="crefl_8c.html#a4589297297b7c4f6867c80dfdb004018">REFLMAX</a>, maxsolz=<a class="code" href="crefl_8c.html#a44faa6cba7ac0e034635d2cc667fbb7e">MAXSOLZ</a>;
<a name="l00221"></a>00221     <span class="keywordtype">int</span> bad;
<a name="l00222"></a>00222 
<a name="l00223"></a>00223     <span class="keywordtype">int</span> write_mode = DFACC_CREATE;
<a name="l00224"></a>00224 
<a name="l00225"></a>00225     <span class="keywordtype">int</span> st;
<a name="l00226"></a>00226 
<a name="l00227"></a>00227     <span class="keywordtype">size_t</span> nbytes;
<a name="l00228"></a>00228 
<a name="l00229"></a>00229     <span class="keywordtype">int</span> ftype;
<a name="l00230"></a>00230 
<a name="l00231"></a>00231     <span class="keyword">extern</span> <span class="keywordtype">char</span> *optarg;
<a name="l00232"></a>00232     <span class="keyword">extern</span> <span class="keywordtype">int</span> optind, opterr;
<a name="l00233"></a>00233     <span class="keywordtype">int</span> option_index = 0;
<a name="l00234"></a>00234 
<a name="l00235"></a>00235     <span class="keyword">static</span> <span class="keywordtype">int</span> verbose, overwrite;
<a name="l00236"></a>00236     <span class="keyword">static</span> <span class="keywordtype">int</span> gzip, append;
<a name="l00237"></a>00237 
<a name="l00238"></a>00238     <span class="keyword">static</span> <span class="keywordtype">int</span> output500m, output1km;
<a name="l00239"></a>00239     <span class="keyword">static</span> <span class="keywordtype">int</span> sealevel, TOA, nearest;
<a name="l00240"></a>00240 
<a name="l00241"></a>00241     <span class="keywordtype">char</span> dummy[MAX_NC_NAME];
<a name="l00242"></a>00242 
<a name="l00243"></a>00243     <span class="keyword">enum</span>{OPT_BANDS = 1, OPT_RANGE, OPT_OUTFILE, OPT_MAXSOLZ};
<a name="l00244"></a>00244 
<a name="l00245"></a>00245     <span class="keyword">static</span> <span class="keyword">struct </span>option long_options[] = {
<a name="l00246"></a>00246         {<span class="stringliteral">&quot;1km&quot;</span>,         no_argument,            &amp;output1km, 1},
<a name="l00247"></a>00247         {<span class="stringliteral">&quot;500m&quot;</span>,        no_argument,            &amp;output500m, 1},
<a name="l00248"></a>00248         {<span class="stringliteral">&quot;append&quot;</span>,      no_argument,            &amp;append, 1},
<a name="l00249"></a>00249         {<span class="stringliteral">&quot;bands&quot;</span>,       required_argument,      (<span class="keywordtype">int</span> *) NULL, OPT_BANDS},
<a name="l00250"></a>00250         {<span class="stringliteral">&quot;gzip&quot;</span>,        no_argument,            &amp;gzip,  1},
<a name="l00251"></a>00251         {<span class="stringliteral">&quot;maxsolz&quot;</span>,     required_argument,      (<span class="keywordtype">int</span> *) NULL, OPT_MAXSOLZ},
<a name="l00252"></a>00252         {<span class="stringliteral">&quot;nearest&quot;</span>,     no_argument,            &amp;nearest, 1},
<a name="l00253"></a>00253         {<span class="stringliteral">&quot;of&quot;</span>,          required_argument,      (<span class="keywordtype">int</span> *) NULL, OPT_OUTFILE},
<a name="l00254"></a>00254         {<span class="stringliteral">&quot;overwrite&quot;</span>,   no_argument,            &amp;overwrite, 1},
<a name="l00255"></a>00255         {<span class="stringliteral">&quot;range&quot;</span>,       required_argument,      (<span class="keywordtype">int</span> *) NULL, OPT_RANGE},
<a name="l00256"></a>00256         {<span class="stringliteral">&quot;sealevel&quot;</span>,    no_argument,            &amp;sealevel, 1},
<a name="l00257"></a>00257         {<span class="stringliteral">&quot;toa&quot;</span>,         no_argument,            &amp;TOA, 1},
<a name="l00258"></a>00258         {<span class="stringliteral">&quot;verbose&quot;</span>,     no_argument,            &amp;verbose, 1},
<a name="l00259"></a>00259         {(<span class="keywordtype">char</span> *) NULL, 0, (<span class="keywordtype">int</span> *) NULL, 0}
<a name="l00260"></a>00260     };
<a name="l00261"></a>00261 
<a name="l00262"></a>00262     <span class="keywordtype">int</span> c;
<a name="l00263"></a>00263 
<a name="l00264"></a>00264     <span class="keyword">static</span> <span class="keywordtype">char</span> dem_filename_buff[<a class="code" href="crefl_8c.html#a259ba7f6d71802538b624c40cda673f9">MAXNAMELENGTH</a>];
<a name="l00265"></a>00265 
<a name="l00266"></a>00266 
<a name="l00267"></a>00267     MOD021KMfile = MOD02HKMfile = MOD02QKMfile = (<span class="keywordtype">char</span> *) NULL;
<a name="l00268"></a>00268     filename = (<span class="keywordtype">char</span> *) NULL;
<a name="l00269"></a>00269 
<a name="l00270"></a>00270     <span class="keywordflow">for</span> (ib = 0; ib &lt; <a class="code" href="crefl_8c.html#a4f9b6b07384112c4eb1ee3b543a08a62">Nbands</a>; ib++) process[ib] = <a class="code" href="gctp_8c.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00271"></a>00271 
<a name="l00272"></a>00272     <span class="comment">/* default settings */</span>
<a name="l00273"></a>00273     output500m = output1km = 0;
<a name="l00274"></a>00274     append = gzip = nearest = sealevel = TOA = verbose = overwrite = 0;
<a name="l00275"></a>00275 
<a name="l00276"></a>00276 
<a name="l00277"></a>00277     <span class="keywordflow">while</span> ((c = getopt_long(argc, argv, <span class="stringliteral">&quot;&quot;</span>, long_options,
<a name="l00278"></a>00278                             &amp;option_index)) &gt;= 0)
<a name="l00279"></a>00279     {
<a name="l00280"></a>00280 
<a name="l00281"></a>00281         <span class="keywordflow">switch</span> (c) {
<a name="l00282"></a>00282             <span class="keywordflow">case</span> 0:
<a name="l00283"></a>00283                 <span class="comment">/* do nothing for options which will have a</span>
<a name="l00284"></a>00284 <span class="comment">                 flag set automatically by getopt_long() */</span>
<a name="l00285"></a>00285                 <span class="keywordflow">break</span>;
<a name="l00286"></a>00286 
<a name="l00287"></a>00287             <span class="keywordflow">case</span> OPT_BANDS:
<a name="l00288"></a>00288                 <span class="keywordflow">if</span> (<a class="code" href="crefl_8c.html#ac168e5666e1a7b5a0d8212db5d8ea2f2">parse_bands</a>(optarg, process)) {
<a name="l00289"></a>00289                     fputs(<span class="stringliteral">&quot;Invalid band(s) specified.\n&quot;</span>,
<a name="l00290"></a>00290                           stderr);
<a name="l00291"></a>00291                     exit(1);
<a name="l00292"></a>00292                 }
<a name="l00293"></a>00293                 <span class="keywordflow">break</span>;
<a name="l00294"></a>00294 
<a name="l00295"></a>00295             <span class="keywordflow">case</span> OPT_RANGE:
<a name="l00296"></a>00296                 <span class="keywordflow">if</span> (sscanf(optarg, <span class="stringliteral">&quot;%g,%g&quot;</span>, &amp;reflmin, &amp;reflmax) != 2) {
<a name="l00297"></a>00297                     fputs(<span class="stringliteral">&quot;Error parsing reflectance range.\n&quot;</span>, stderr);
<a name="l00298"></a>00298                     exit(1);
<a name="l00299"></a>00299                 }
<a name="l00300"></a>00300 
<a name="l00301"></a>00301                 <span class="keywordflow">if</span> ( <a class="code" href="crefl_8c.html#afaf023b21ea740b2575e5d3bb2b84ccf">range_check</a>(reflmin, 0.0F, 1.0F) ||
<a name="l00302"></a>00302                     <a class="code" href="crefl_8c.html#afaf023b21ea740b2575e5d3bb2b84ccf">range_check</a>(reflmax, 0.0F, 1.0F) ||
<a name="l00303"></a>00303                     (reflmin &gt;= reflmax) ) {
<a name="l00304"></a>00304                         fputs(<span class="stringliteral">&quot;Invalid reflectance range.\n&quot;</span>, stderr);
<a name="l00305"></a>00305                         exit(1);
<a name="l00306"></a>00306                     }
<a name="l00307"></a>00307 
<a name="l00308"></a>00308                 printf(<span class="stringliteral">&quot;Output reflectance range [%.3f,%.3f] requested.\n&quot;</span>,
<a name="l00309"></a>00309                        reflmin, reflmax);
<a name="l00310"></a>00310                 <span class="keywordflow">break</span>;
<a name="l00311"></a>00311 
<a name="l00312"></a>00312             <span class="keywordflow">case</span> OPT_MAXSOLZ:
<a name="l00313"></a>00313                 maxsolz = (float) atof(optarg);
<a name="l00314"></a>00314                 <span class="keywordflow">if</span> (<a class="code" href="crefl_8c.html#afaf023b21ea740b2575e5d3bb2b84ccf">range_check</a>(maxsolz, 0.0F, 90.0F)) {
<a name="l00315"></a>00315                     fputs(<span class="stringliteral">&quot;Invalid max. solar zenith angle.\n&quot;</span>, stderr);
<a name="l00316"></a>00316                     exit(1);
<a name="l00317"></a>00317                 }
<a name="l00318"></a>00318                 <span class="keywordflow">break</span>;
<a name="l00319"></a>00319 
<a name="l00320"></a>00320             <span class="keywordflow">case</span> OPT_OUTFILE:
<a name="l00321"></a>00321                 filename = optarg;
<a name="l00322"></a>00322                 <span class="keywordflow">break</span>;
<a name="l00323"></a>00323 
<a name="l00324"></a>00324             <span class="keywordflow">default</span>:
<a name="l00325"></a>00325                 <a class="code" href="crefl_8c.html#ae8605e2b78cd4a81b6c6b5c30cb7366a">usage</a>();
<a name="l00326"></a>00326                 exit(1);
<a name="l00327"></a>00327         }
<a name="l00328"></a>00328     }
<a name="l00329"></a>00329     
<a name="l00330"></a>00330     <span class="keywordflow">if</span> (append) write_mode = DFACC_RDWR;
<a name="l00331"></a>00331 
<a name="l00332"></a>00332     <span class="comment">/* at least one input file must follow */</span>
<a name="l00333"></a>00333     <span class="keywordflow">if</span> (optind &gt;= argc) {
<a name="l00334"></a>00334         <a class="code" href="crefl_8c.html#ae8605e2b78cd4a81b6c6b5c30cb7366a">usage</a>();
<a name="l00335"></a>00335         exit(1);
<a name="l00336"></a>00336     }
<a name="l00337"></a>00337 
<a name="l00338"></a>00338 
<a name="l00339"></a>00339     <span class="comment">/* check for conflicting options */</span>
<a name="l00340"></a>00340     <span class="keywordflow">if</span> (overwrite &amp;&amp; append) {
<a name="l00341"></a>00341         fputs(<span class="stringliteral">&quot;Options --overwrite and --append are mutually exclusive.\n&quot;</span>,
<a name="l00342"></a>00342               stderr);
<a name="l00343"></a>00343         exit(1);
<a name="l00344"></a>00344     }
<a name="l00345"></a>00345     <span class="keywordflow">if</span> (sealevel &amp;&amp; TOA) {
<a name="l00346"></a>00346         fputs(<span class="stringliteral">&quot;Options --sealevel and --toa are mutually exclusive.\n&quot;</span>,
<a name="l00347"></a>00347               stderr);
<a name="l00348"></a>00348         exit(1);
<a name="l00349"></a>00349     }
<a name="l00350"></a>00350 
<a name="l00351"></a>00351 <span class="preprocessor">#ifdef DEBUG</span>
<a name="l00352"></a>00352 <span class="preprocessor"></span>    printf(<span class="stringliteral">&quot;append = %d\n&quot;</span>, append);
<a name="l00353"></a>00353     <span class="keywordflow">if</span> (filename) printf(<span class="stringliteral">&quot;output filename = %s\n&quot;</span>, filename);
<a name="l00354"></a>00354     printf(<span class="stringliteral">&quot;output1km = %d\n&quot;</span>, (<span class="keywordtype">int</span>) output1km);
<a name="l00355"></a>00355     printf(<span class="stringliteral">&quot;output500m = %d\n&quot;</span>, (<span class="keywordtype">int</span>) output500m);
<a name="l00356"></a>00356     printf(<span class="stringliteral">&quot;gzip = %d\n&quot;</span>, gzip);
<a name="l00357"></a>00357     printf(<span class="stringliteral">&quot;nearest = %d\n&quot;</span>, nearest);
<a name="l00358"></a>00358     printf(<span class="stringliteral">&quot;sealevel = %d\n&quot;</span>, sealevel);
<a name="l00359"></a>00359     printf(<span class="stringliteral">&quot;TOA = %d\n&quot;</span>, TOA);
<a name="l00360"></a>00360     printf(<span class="stringliteral">&quot;Max. solar zenith angle: %g degrees\n&quot;</span>, maxsolz);
<a name="l00361"></a>00361     <span class="keywordflow">if</span> (filename) printf(<span class="stringliteral">&quot;Output file: %s.&quot;</span>, filename);
<a name="l00362"></a>00362 <span class="preprocessor">#endif</span>
<a name="l00363"></a>00363 <span class="preprocessor"></span>
<a name="l00364"></a>00364 
<a name="l00365"></a>00365 
<a name="l00366"></a>00366     <span class="keywordflow">if</span> (verbose) puts(<span class="stringliteral">&quot;Verbose mode requested.&quot;</span>);
<a name="l00367"></a>00367     <span class="keywordflow">if</span> (overwrite) puts(<span class="stringliteral">&quot;Overwriting existing output file.&quot;</span>);
<a name="l00368"></a>00368     <span class="keywordflow">if</span> (gzip) puts(<span class="stringliteral">&quot;Gzip compression requested.&quot;</span>);
<a name="l00369"></a>00369     <span class="keywordflow">if</span> (sealevel) puts(<span class="stringliteral">&quot;Sea-level atmospheric correction requested. Terrain height ignored.&quot;</span>);
<a name="l00370"></a>00370     <span class="keywordflow">if</span> (TOA) puts(<span class="stringliteral">&quot;Top-of-the-atmosphere reflectance requested. No atmospheric correction.&quot;</span>);
<a name="l00371"></a>00371     <span class="keywordflow">if</span> (output1km) puts(<span class="stringliteral">&quot;1km-resolution output requested.&quot;</span>);
<a name="l00372"></a>00372     <span class="keywordflow">if</span> (nearest) puts(<span class="stringliteral">&quot;Interpolation disabled.&quot;</span>);
<a name="l00373"></a>00373 
<a name="l00374"></a>00374 
<a name="l00375"></a>00375 
<a name="l00376"></a>00376     <span class="comment">/* parse input file names */</span>
<a name="l00377"></a>00377     <span class="keywordflow">for</span> (j = optind; j &lt; argc; j++) {
<a name="l00378"></a>00378         ftype = <a class="code" href="crefl_8c.html#ace1410b6373bee65bb550f176eebb328">input_file_type</a>(argv[j]);
<a name="l00379"></a>00379 
<a name="l00380"></a>00380         <span class="keywordflow">switch</span> (ftype) {
<a name="l00381"></a>00381             <span class="keywordflow">case</span> <a class="code" href="crefl_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a452c3898e38e3afd59ea4e5f301f93e4">INPUT_1KM</a>:
<a name="l00382"></a>00382                 MOD021KMfile = argv[j];
<a name="l00383"></a>00383                 <span class="keywordflow">break</span>;
<a name="l00384"></a>00384 
<a name="l00385"></a>00385             <span class="keywordflow">case</span> <a class="code" href="crefl_8c.html#adf764cbdea00d65edcd07bb9953ad2b7ac30114f16e63da819602bbff904da486">INPUT_500M</a>:
<a name="l00386"></a>00386                 MOD02HKMfile = argv[j];
<a name="l00387"></a>00387                 <span class="keywordflow">break</span>;
<a name="l00388"></a>00388 
<a name="l00389"></a>00389             <span class="keywordflow">case</span> <a class="code" href="crefl_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a471d277dddd138c78232bb6fef807a8e">INPUT_250M</a>:
<a name="l00390"></a>00390                 MOD02QKMfile = argv[j];
<a name="l00391"></a>00391                 <span class="keywordflow">break</span>;
<a name="l00392"></a>00392 
<a name="l00393"></a>00393             <span class="keywordflow">default</span>:
<a name="l00394"></a>00394                 fprintf(stderr,
<a name="l00395"></a>00395                         <span class="stringliteral">&quot;Unrecognized input file \&quot;%s\&quot;.\n&quot;</span>,
<a name="l00396"></a>00396                         argv[j]);
<a name="l00397"></a>00397                 exit(1);
<a name="l00398"></a>00398                 <span class="keywordflow">break</span>;
<a name="l00399"></a>00399         }
<a name="l00400"></a>00400     }
<a name="l00401"></a>00401 
<a name="l00402"></a>00402 
<a name="l00403"></a>00403 
<a name="l00404"></a>00404     <span class="keywordflow">if</span> (verbose &amp;&amp; MOD021KMfile)
<a name="l00405"></a>00405         printf(<span class="stringliteral">&quot;Input geolocation file: %s\n&quot;</span>, MOD021KMfile);
<a name="l00406"></a>00406 
<a name="l00407"></a>00407 
<a name="l00408"></a>00408     <span class="comment">/* output file name is mandatory */</span>
<a name="l00409"></a>00409     <span class="keywordflow">if</span> (!filename) {
<a name="l00410"></a>00410         fputs(<span class="stringliteral">&quot;Missing output file name.\n&quot;</span>, stderr);
<a name="l00411"></a>00411         exit(1);
<a name="l00412"></a>00412     }
<a name="l00413"></a>00413 
<a name="l00414"></a>00414 <span class="preprocessor">#ifdef DEBUG</span>
<a name="l00415"></a>00415 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (MOD021KMfile) printf(<span class="stringliteral">&quot;MOD/MYD021KMfile = %s\n&quot;</span>, MOD021KMfile);
<a name="l00416"></a>00416     <span class="keywordflow">if</span> (MOD02HKMfile) printf(<span class="stringliteral">&quot;MOD/MYD02HKMfile = %s\n&quot;</span>, MOD02HKMfile);
<a name="l00417"></a>00417     <span class="keywordflow">if</span> (MOD02QKMfile) printf(<span class="stringliteral">&quot;MOD/MYD02QKMfile = %s\n&quot;</span>, MOD02QKMfile);
<a name="l00418"></a>00418 <span class="preprocessor">#endif</span>
<a name="l00419"></a>00419 <span class="preprocessor"></span>
<a name="l00420"></a>00420 
<a name="l00421"></a>00421         <span class="comment">/*</span>
<a name="l00422"></a>00422 <span class="comment">         1KM file is mandatory for angles.</span>
<a name="l00423"></a>00423 <span class="comment">         HKM file is mandatory unless 1-km output is requested.</span>
<a name="l00424"></a>00424 <span class="comment">         QKM file is mandatory unless 500-m or 1-km output is requested.</span>
<a name="l00425"></a>00425 <span class="comment">         */</span>
<a name="l00426"></a>00426         <span class="keywordflow">if</span> ( (!MOD021KMfile) ||
<a name="l00427"></a>00427             (!MOD02HKMfile &amp;&amp; !output1km) ||
<a name="l00428"></a>00428             (!MOD02QKMfile &amp;&amp; !output500m &amp;&amp; !output1km) ) {
<a name="l00429"></a>00429                 fputs(<span class="stringliteral">&quot;Invalid combination of input files.\n&quot;</span>, stderr);
<a name="l00430"></a>00430                 exit(1);
<a name="l00431"></a>00431             }
<a name="l00432"></a>00432 
<a name="l00433"></a>00433 
<a name="l00434"></a>00434     <span class="comment">/* count number of bands to process */</span>
<a name="l00435"></a>00435     <span class="keywordflow">for</span> (ib = nbands = 0; ib &lt; <a class="code" href="crefl_8c.html#a4f9b6b07384112c4eb1ee3b543a08a62">Nbands</a>; ib++) <span class="keywordflow">if</span> (process[ib]) nbands++;
<a name="l00436"></a>00436     <span class="keywordflow">if</span> (nbands &lt; 1) {
<a name="l00437"></a>00437         process[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba9fbad3dfb641b1136d4d8d687d95cd6b">BAND1</a>] = process[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba10ffd1b40afc860b05637567b4252032">BAND3</a>] = process[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55baaad5ed9d733ddb56030fd974aeba5c2b">BAND4</a>] = <a class="code" href="gctp_8c.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00438"></a>00438         <span class="keywordflow">if</span> (verbose)
<a name="l00439"></a>00439             puts(<span class="stringliteral">&quot;No band(s) specified.  Default is bands 1, 3, and 4.&quot;</span>);
<a name="l00440"></a>00440     }
<a name="l00441"></a>00441 
<a name="l00442"></a>00442 
<a name="l00443"></a>00443     <span class="comment">/* open input files */</span>
<a name="l00444"></a>00444     <span class="keywordflow">if</span> ( MOD02QKMfile &amp;&amp; (!output500m)  &amp;&amp;
<a name="l00445"></a>00445         !output1km &amp;&amp;
<a name="l00446"></a>00446         (MOD02QKMfile_id = SDstart(MOD02QKMfile, DFACC_READ)) == -1 ) {
<a name="l00447"></a>00447             fprintf(stderr, <span class="stringliteral">&quot;Cannot open input file %s.\n&quot;</span>, MOD02QKMfile);
<a name="l00448"></a>00448             exit(1);
<a name="l00449"></a>00449         }
<a name="l00450"></a>00450     <span class="keywordflow">if</span> ( MOD02HKMfile &amp;&amp; (!output1km) &amp;&amp;
<a name="l00451"></a>00451         (MOD02HKMfile_id = SDstart(MOD02HKMfile, DFACC_READ)) == -1 ) {
<a name="l00452"></a>00452             fprintf(stderr, <span class="stringliteral">&quot;Cannot open input file %s.\n&quot;</span>, MOD02HKMfile);
<a name="l00453"></a>00453             exit(1);
<a name="l00454"></a>00454         }
<a name="l00455"></a>00455     <span class="keywordflow">if</span> ( MOD021KMfile &amp;&amp;
<a name="l00456"></a>00456         (MOD021KMfile_id = SDstart(MOD021KMfile, DFACC_READ)) == -1 ) {
<a name="l00457"></a>00457             fprintf(stderr, <span class="stringliteral">&quot;Cannot open input file %s.\n&quot;</span>, MOD021KMfile);
<a name="l00458"></a>00458             exit(1);
<a name="l00459"></a>00459         }
<a name="l00460"></a>00460 
<a name="l00461"></a>00461 
<a name="l00462"></a>00462     <span class="keywordflow">if</span> (!sealevel &amp;&amp; !TOA) {
<a name="l00463"></a>00463         dem.<a class="code" href="struct_s_d_s.html#aeac90097f29f7529968697163cea5c18">filename</a> = dem_filename_buff;
<a name="l00464"></a>00464 
<a name="l00465"></a>00465         <span class="keywordflow">if</span> ((ancpath = getenv(<span class="stringliteral">&quot;ANCPATH&quot;</span>)) == NULL) {
<a name="l00466"></a>00466 <span class="preprocessor">#ifdef CREFL_DATA_DIR</span>
<a name="l00467"></a>00467 <span class="preprocessor"></span>            sprintf(dem.<a class="code" href="struct_s_d_s.html#aeac90097f29f7529968697163cea5c18">filename</a>, <span class="stringliteral">&quot;%s/%s&quot;</span>, CREFL_DATA_DIR, <a class="code" href="crefl_8c.html#a00bbca4f07b1f8f4cd06106a945bc61e">DEMFILENAME</a>);
<a name="l00468"></a>00468 <span class="preprocessor">#else            </span>
<a name="l00469"></a>00469 <span class="preprocessor"></span>            sprintf(dem.<a class="code" href="struct_s_d_s.html#aeac90097f29f7529968697163cea5c18">filename</a>, <span class="stringliteral">&quot;%s/%s&quot;</span>, <a class="code" href="crefl_8c.html#aa8ea6218db4861be2905405d42c99f42">ANCPATH</a>, <a class="code" href="crefl_8c.html#a00bbca4f07b1f8f4cd06106a945bc61e">DEMFILENAME</a>);
<a name="l00470"></a>00470 <span class="preprocessor">#endif</span>
<a name="l00471"></a>00471 <span class="preprocessor"></span>        }
<a name="l00472"></a>00472 
<a name="l00473"></a>00473         <span class="keywordflow">else</span>
<a name="l00474"></a>00474             sprintf(dem.<a class="code" href="struct_s_d_s.html#aeac90097f29f7529968697163cea5c18">filename</a>, <span class="stringliteral">&quot;%s/%s&quot;</span>, ancpath, <a class="code" href="crefl_8c.html#a00bbca4f07b1f8f4cd06106a945bc61e">DEMFILENAME</a>);
<a name="l00475"></a>00475 
<a name="l00476"></a>00476 
<a name="l00477"></a>00477         <span class="keywordflow">if</span> ( (dem.<a class="code" href="struct_s_d_s.html#a797dbc1344311c85615adc59b0070867">file_id</a> = SDstart(dem.<a class="code" href="struct_s_d_s.html#aeac90097f29f7529968697163cea5c18">filename</a>, DFACC_READ)) == -1 ) {
<a name="l00478"></a>00478             fprintf(stderr, <span class="stringliteral">&quot;Cannot open file %s.\n&quot;</span>, dem.<a class="code" href="struct_s_d_s.html#aeac90097f29f7529968697163cea5c18">filename</a>);
<a name="l00479"></a>00479             exit(1);
<a name="l00480"></a>00480         }
<a name="l00481"></a>00481     }
<a name="l00482"></a>00482 
<a name="l00483"></a>00483 
<a name="l00484"></a>00484     <span class="keywordflow">if</span> ( (fp = fopen(filename, <span class="stringliteral">&quot;r&quot;</span>)) ) {
<a name="l00485"></a>00485         (void) fclose(fp);
<a name="l00486"></a>00486         outfile_exists = 1;
<a name="l00487"></a>00487     }
<a name="l00488"></a>00488     <span class="keywordflow">else</span>
<a name="l00489"></a>00489         outfile_exists = 0;
<a name="l00490"></a>00490 
<a name="l00491"></a>00491     <span class="keywordflow">if</span> ((write_mode == DFACC_CREATE)  &amp;&amp;  !overwrite  &amp;&amp; outfile_exists) {
<a name="l00492"></a>00492         fprintf(stderr, <span class="stringliteral">&quot;File \&quot;%s\&quot; already exits.\n&quot;</span>, filename);
<a name="l00493"></a>00493         exit(1);
<a name="l00494"></a>00494     }
<a name="l00495"></a>00495 
<a name="l00496"></a>00496     <span class="keywordflow">if</span> (output500m) {
<a name="l00497"></a>00497         sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba9fbad3dfb641b1136d4d8d687d95cd6b">BAND1</a>].<a class="code" href="struct_s_d_s.html#a797dbc1344311c85615adc59b0070867">file_id</a> = sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba810e3a7a148b98f1ddf594439e165583">BAND2</a>].<a class="code" href="struct_s_d_s.html#a797dbc1344311c85615adc59b0070867">file_id</a> = MOD02HKMfile_id;
<a name="l00498"></a>00498         sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba9fbad3dfb641b1136d4d8d687d95cd6b">BAND1</a>].<a class="code" href="struct_s_d_s.html#aeac90097f29f7529968697163cea5c18">filename</a> = sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba810e3a7a148b98f1ddf594439e165583">BAND2</a>].<a class="code" href="struct_s_d_s.html#aeac90097f29f7529968697163cea5c18">filename</a> = MOD02HKMfile;
<a name="l00499"></a>00499     }
<a name="l00500"></a>00500     <span class="keywordflow">else</span> {
<a name="l00501"></a>00501         <span class="keywordflow">if</span> (output1km) {
<a name="l00502"></a>00502             sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba9fbad3dfb641b1136d4d8d687d95cd6b">BAND1</a>].<a class="code" href="struct_s_d_s.html#a797dbc1344311c85615adc59b0070867">file_id</a> = sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba810e3a7a148b98f1ddf594439e165583">BAND2</a>].<a class="code" href="struct_s_d_s.html#a797dbc1344311c85615adc59b0070867">file_id</a> = MOD021KMfile_id;
<a name="l00503"></a>00503             sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba9fbad3dfb641b1136d4d8d687d95cd6b">BAND1</a>].<a class="code" href="struct_s_d_s.html#aeac90097f29f7529968697163cea5c18">filename</a> = sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba810e3a7a148b98f1ddf594439e165583">BAND2</a>].<a class="code" href="struct_s_d_s.html#aeac90097f29f7529968697163cea5c18">filename</a> = MOD021KMfile;
<a name="l00504"></a>00504         }
<a name="l00505"></a>00505         <span class="keywordflow">else</span> {
<a name="l00506"></a>00506             sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba9fbad3dfb641b1136d4d8d687d95cd6b">BAND1</a>].<a class="code" href="struct_s_d_s.html#a797dbc1344311c85615adc59b0070867">file_id</a> = sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba810e3a7a148b98f1ddf594439e165583">BAND2</a>].<a class="code" href="struct_s_d_s.html#a797dbc1344311c85615adc59b0070867">file_id</a> = MOD02QKMfile_id;
<a name="l00507"></a>00507             sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba9fbad3dfb641b1136d4d8d687d95cd6b">BAND1</a>].<a class="code" href="struct_s_d_s.html#aeac90097f29f7529968697163cea5c18">filename</a> = sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba810e3a7a148b98f1ddf594439e165583">BAND2</a>].<a class="code" href="struct_s_d_s.html#aeac90097f29f7529968697163cea5c18">filename</a> = MOD02QKMfile;
<a name="l00508"></a>00508         }
<a name="l00509"></a>00509     }
<a name="l00510"></a>00510 
<a name="l00511"></a>00511     <span class="keywordflow">if</span> (output1km) {
<a name="l00512"></a>00512         sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba10ffd1b40afc860b05637567b4252032">BAND3</a>].<a class="code" href="struct_s_d_s.html#a797dbc1344311c85615adc59b0070867">file_id</a> = sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55baaad5ed9d733ddb56030fd974aeba5c2b">BAND4</a>].<a class="code" href="struct_s_d_s.html#a797dbc1344311c85615adc59b0070867">file_id</a> =
<a name="l00513"></a>00513             sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba018d60ba72eb679100259c19f81cf687">BAND5</a>].<a class="code" href="struct_s_d_s.html#a797dbc1344311c85615adc59b0070867">file_id</a> = sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55baa7fff757ecd5854378b206732608fb9c">BAND6</a>].<a class="code" href="struct_s_d_s.html#a797dbc1344311c85615adc59b0070867">file_id</a> =
<a name="l00514"></a>00514             sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba4e34f17c478d52f16abdd42f4dcb7981">BAND7</a>].<a class="code" href="struct_s_d_s.html#a797dbc1344311c85615adc59b0070867">file_id</a> = MOD021KMfile_id;
<a name="l00515"></a>00515         sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba10ffd1b40afc860b05637567b4252032">BAND3</a>].<a class="code" href="struct_s_d_s.html#aeac90097f29f7529968697163cea5c18">filename</a> = sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55baaad5ed9d733ddb56030fd974aeba5c2b">BAND4</a>].<a class="code" href="struct_s_d_s.html#aeac90097f29f7529968697163cea5c18">filename</a> =
<a name="l00516"></a>00516             sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba018d60ba72eb679100259c19f81cf687">BAND5</a>].<a class="code" href="struct_s_d_s.html#aeac90097f29f7529968697163cea5c18">filename</a> = sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55baa7fff757ecd5854378b206732608fb9c">BAND6</a>].<a class="code" href="struct_s_d_s.html#aeac90097f29f7529968697163cea5c18">filename</a> =
<a name="l00517"></a>00517             sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba4e34f17c478d52f16abdd42f4dcb7981">BAND7</a>].<a class="code" href="struct_s_d_s.html#aeac90097f29f7529968697163cea5c18">filename</a> = MOD021KMfile;
<a name="l00518"></a>00518     }
<a name="l00519"></a>00519     <span class="keywordflow">else</span> {
<a name="l00520"></a>00520         sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba10ffd1b40afc860b05637567b4252032">BAND3</a>].<a class="code" href="struct_s_d_s.html#a797dbc1344311c85615adc59b0070867">file_id</a> = sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55baaad5ed9d733ddb56030fd974aeba5c2b">BAND4</a>].<a class="code" href="struct_s_d_s.html#a797dbc1344311c85615adc59b0070867">file_id</a> =
<a name="l00521"></a>00521             sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba018d60ba72eb679100259c19f81cf687">BAND5</a>].<a class="code" href="struct_s_d_s.html#a797dbc1344311c85615adc59b0070867">file_id</a> = sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55baa7fff757ecd5854378b206732608fb9c">BAND6</a>].<a class="code" href="struct_s_d_s.html#a797dbc1344311c85615adc59b0070867">file_id</a> =
<a name="l00522"></a>00522             sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba4e34f17c478d52f16abdd42f4dcb7981">BAND7</a>].<a class="code" href="struct_s_d_s.html#a797dbc1344311c85615adc59b0070867">file_id</a> = MOD02HKMfile_id;
<a name="l00523"></a>00523         sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba10ffd1b40afc860b05637567b4252032">BAND3</a>].<a class="code" href="struct_s_d_s.html#aeac90097f29f7529968697163cea5c18">filename</a> = sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55baaad5ed9d733ddb56030fd974aeba5c2b">BAND4</a>].<a class="code" href="struct_s_d_s.html#aeac90097f29f7529968697163cea5c18">filename</a> =
<a name="l00524"></a>00524             sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba018d60ba72eb679100259c19f81cf687">BAND5</a>].<a class="code" href="struct_s_d_s.html#aeac90097f29f7529968697163cea5c18">filename</a> = sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55baa7fff757ecd5854378b206732608fb9c">BAND6</a>].<a class="code" href="struct_s_d_s.html#aeac90097f29f7529968697163cea5c18">filename</a> =
<a name="l00525"></a>00525             sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba4e34f17c478d52f16abdd42f4dcb7981">BAND7</a>].<a class="code" href="struct_s_d_s.html#aeac90097f29f7529968697163cea5c18">filename</a> = MOD02HKMfile;
<a name="l00526"></a>00526     }
<a name="l00527"></a>00527 
<a name="l00528"></a>00528     sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba3a905a86ba7635d02535561e1e0b21ad">BAND8</a>].<a class="code" href="struct_s_d_s.html#a797dbc1344311c85615adc59b0070867">file_id</a> = sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55bad8f798e8c6187b0f954f8e1c5242676c">SOLZ</a>].<a class="code" href="struct_s_d_s.html#a797dbc1344311c85615adc59b0070867">file_id</a> = sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba121b0531d586fd21bc238b45301e91e6">SOLA</a>].<a class="code" href="struct_s_d_s.html#a797dbc1344311c85615adc59b0070867">file_id</a> =
<a name="l00529"></a>00529         sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55bacc111a7dd4eead6275985b9364cd1acf">SENZ</a>].<a class="code" href="struct_s_d_s.html#a797dbc1344311c85615adc59b0070867">file_id</a> = sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba5beedd32e3c0e217293f68703b0791ad">SENA</a>].<a class="code" href="struct_s_d_s.html#a797dbc1344311c85615adc59b0070867">file_id</a> = sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba99d3d71739b89a1e680a59b017d8ab5a">LON</a>].<a class="code" href="struct_s_d_s.html#a797dbc1344311c85615adc59b0070867">file_id</a> =
<a name="l00530"></a>00530         sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba40df096e8ca19a820dbd94de79e97b3b">LAT</a>].<a class="code" href="struct_s_d_s.html#a797dbc1344311c85615adc59b0070867">file_id</a> = MOD021KMfile_id;
<a name="l00531"></a>00531     sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba3a905a86ba7635d02535561e1e0b21ad">BAND8</a>].<a class="code" href="struct_s_d_s.html#aeac90097f29f7529968697163cea5c18">filename</a> = sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55bad8f798e8c6187b0f954f8e1c5242676c">SOLZ</a>].<a class="code" href="struct_s_d_s.html#aeac90097f29f7529968697163cea5c18">filename</a> = sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba121b0531d586fd21bc238b45301e91e6">SOLA</a>].<a class="code" href="struct_s_d_s.html#aeac90097f29f7529968697163cea5c18">filename</a> =
<a name="l00532"></a>00532         sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55bacc111a7dd4eead6275985b9364cd1acf">SENZ</a>].<a class="code" href="struct_s_d_s.html#aeac90097f29f7529968697163cea5c18">filename</a> = sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba5beedd32e3c0e217293f68703b0791ad">SENA</a>].<a class="code" href="struct_s_d_s.html#aeac90097f29f7529968697163cea5c18">filename</a> = sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba99d3d71739b89a1e680a59b017d8ab5a">LON</a>].<a class="code" href="struct_s_d_s.html#aeac90097f29f7529968697163cea5c18">filename</a> =
<a name="l00533"></a>00533         sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba40df096e8ca19a820dbd94de79e97b3b">LAT</a>].<a class="code" href="struct_s_d_s.html#aeac90097f29f7529968697163cea5c18">filename</a> = MOD021KMfile;
<a name="l00534"></a>00534 
<a name="l00535"></a>00535     sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba112ff6b056e2dbe15e707410768324b8">BAND9</a>].<a class="code" href="struct_s_d_s.html#a797dbc1344311c85615adc59b0070867">file_id</a> = sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba7eca15ec1234cf4ac2a5cff2c908d2f4">BAND10</a>].<a class="code" href="struct_s_d_s.html#a797dbc1344311c85615adc59b0070867">file_id</a> = sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba244c126e4f73780c411a057931eadcf8">BAND11</a>].<a class="code" href="struct_s_d_s.html#a797dbc1344311c85615adc59b0070867">file_id</a> =
<a name="l00536"></a>00536         sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba511ff877c25560fb73952651b272c5f7">BAND12</a>].<a class="code" href="struct_s_d_s.html#a797dbc1344311c85615adc59b0070867">file_id</a> = sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba8c254a2be094a72cac40ff3b12c5bcc4">BAND13</a>].<a class="code" href="struct_s_d_s.html#a797dbc1344311c85615adc59b0070867">file_id</a> =
<a name="l00537"></a>00537         sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55bab0776b3892318b8d9badfb256b84cca3">BAND14</a>].<a class="code" href="struct_s_d_s.html#a797dbc1344311c85615adc59b0070867">file_id</a> = sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba1c399d152e63f8fb4ea0c719d44b30e4">BAND15</a>].<a class="code" href="struct_s_d_s.html#a797dbc1344311c85615adc59b0070867">file_id</a> =
<a name="l00538"></a>00538         sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55babd51a0ee442a2fadcd18d769efcaf80a">BAND16</a>].<a class="code" href="struct_s_d_s.html#a797dbc1344311c85615adc59b0070867">file_id</a> = MOD021KMfile_id;
<a name="l00539"></a>00539     sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba112ff6b056e2dbe15e707410768324b8">BAND9</a>].<a class="code" href="struct_s_d_s.html#aeac90097f29f7529968697163cea5c18">filename</a> = sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba7eca15ec1234cf4ac2a5cff2c908d2f4">BAND10</a>].<a class="code" href="struct_s_d_s.html#aeac90097f29f7529968697163cea5c18">filename</a> = sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba244c126e4f73780c411a057931eadcf8">BAND11</a>].<a class="code" href="struct_s_d_s.html#aeac90097f29f7529968697163cea5c18">filename</a> =
<a name="l00540"></a>00540         sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba511ff877c25560fb73952651b272c5f7">BAND12</a>].<a class="code" href="struct_s_d_s.html#aeac90097f29f7529968697163cea5c18">filename</a> = sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba8c254a2be094a72cac40ff3b12c5bcc4">BAND13</a>].<a class="code" href="struct_s_d_s.html#aeac90097f29f7529968697163cea5c18">filename</a> =
<a name="l00541"></a>00541         sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55bab0776b3892318b8d9badfb256b84cca3">BAND14</a>].<a class="code" href="struct_s_d_s.html#aeac90097f29f7529968697163cea5c18">filename</a> = sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba1c399d152e63f8fb4ea0c719d44b30e4">BAND15</a>].<a class="code" href="struct_s_d_s.html#aeac90097f29f7529968697163cea5c18">filename</a> =
<a name="l00542"></a>00542         sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55babd51a0ee442a2fadcd18d769efcaf80a">BAND16</a>].<a class="code" href="struct_s_d_s.html#aeac90097f29f7529968697163cea5c18">filename</a> = MOD021KMfile;
<a name="l00543"></a>00543 
<a name="l00544"></a>00544     <span class="keywordflow">for</span> (ib=0; ib &lt; <a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba8b602b8b0906ba2c4717e163f1478c8f">Nitems</a>; ib++) {
<a name="l00545"></a>00545         <span class="comment">/* initializing these fields will simplify releasing memory later */</span>
<a name="l00546"></a>00546         sds[ib].<a class="code" href="struct_s_d_s.html#a735984d41155bc1032e09bece8f8d66d">data</a> = sds[ib].<a class="code" href="struct_s_d_s.html#ac5abb67b2d2204c1dba5fd732876b853">fillvalue</a> = (<span class="keywordtype">void</span> *) NULL;
<a name="l00547"></a>00547 
<a name="l00548"></a>00548         <span class="keywordflow">if</span> ( ib &lt; Nbands  &amp;&amp;
<a name="l00549"></a>00549             ! process[ib] ) {
<a name="l00550"></a>00550                 sds[ib].<a class="code" href="struct_s_d_s.html#a51be18c1422c1f14d31c199caf6642e6">id</a> = -1;
<a name="l00551"></a>00551                 <span class="keywordflow">continue</span>;
<a name="l00552"></a>00552             }
<a name="l00553"></a>00553         <span class="keywordflow">if</span> (output500m)
<a name="l00554"></a>00554             sds[ib].<a class="code" href="struct_s_d_s.html#a5ac083a645d964373f022d03df4849c8">name</a> = SDSlocatorHKM[ib];
<a name="l00555"></a>00555         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (output1km)
<a name="l00556"></a>00556             sds[ib].<a class="code" href="struct_s_d_s.html#a5ac083a645d964373f022d03df4849c8">name</a> = SDSlocator1KM[ib];
<a name="l00557"></a>00557         <span class="keywordflow">else</span>
<a name="l00558"></a>00558             sds[ib].<a class="code" href="struct_s_d_s.html#a5ac083a645d964373f022d03df4849c8">name</a> = SDSlocatorQKM[ib];
<a name="l00559"></a>00559 
<a name="l00560"></a>00560         <span class="keywordflow">if</span> ( (sds[ib].index = SDnametoindex(sds[ib].file_id, sds[ib].name)) == -1 ) {
<a name="l00561"></a>00561             fprintf(stderr, <span class="stringliteral">&quot;Cannot find SDS %s in file %s.\n&quot;</span>, sds[ib].name, sds[ib].filename);
<a name="l00562"></a>00562             <span class="keywordflow">continue</span>;
<a name="l00563"></a>00563         }
<a name="l00564"></a>00564         <span class="keywordflow">if</span> ( (sds[ib].<span class="keywordtype">id</span> = SDselect(sds[ib].file_id, sds[ib].index)) == -1 ) {
<a name="l00565"></a>00565             fprintf(stderr, <span class="stringliteral">&quot;Cannot select SDS no. %d\n&quot;</span>, sds[ib].index);
<a name="l00566"></a>00566             <span class="keywordflow">if</span> (ib &lt; Nbands)
<a name="l00567"></a>00567                 process[ib] = <a class="code" href="gctp_8c.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00568"></a>00568             <span class="keywordflow">continue</span>;
<a name="l00569"></a>00569         }
<a name="l00570"></a>00570 
<a name="l00571"></a>00571         <span class="comment">/*</span>
<a name="l00572"></a>00572 <span class="comment">         Original code passed sds[ib].name as destination for SDS name in call to SDgetinfo().</span>
<a name="l00573"></a>00573 <span class="comment">         This was causing a core dump, apparently because SDgetinfo() writes some additional</span>
<a name="l00574"></a>00574 <span class="comment">         characters beyond the terminating null at the end of the SDS name, so I replaced</span>
<a name="l00575"></a>00575 <span class="comment">         the argument with a dummy character array.</span>
<a name="l00576"></a>00576 <span class="comment">        */</span>
<a name="l00577"></a>00577         <span class="keywordflow">if</span> (SDgetinfo(sds[ib].<span class="keywordtype">id</span>, dummy, &amp;sds[ib].rank, sds[ib].dim_sizes, &amp;sds[ib].num_type, &amp;sds[ib].n_attr) == -1) {
<a name="l00578"></a>00578             fprintf(stderr, <span class="stringliteral">&quot;Can&#39;t get info from SDS \&quot;%s\&quot; in file %s.\n&quot;</span>, sds[ib].name, sds[ib].filename);
<a name="l00579"></a>00579             SDendaccess(sds[ib].<span class="keywordtype">id</span>);
<a name="l00580"></a>00580             sds[ib].<a class="code" href="struct_s_d_s.html#a51be18c1422c1f14d31c199caf6642e6">id</a> = -1;
<a name="l00581"></a>00581             <span class="keywordflow">if</span> (ib &lt; Nbands)
<a name="l00582"></a>00582                 process[ib] = <a class="code" href="gctp_8c.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00583"></a>00583             <span class="keywordflow">continue</span>;
<a name="l00584"></a>00584         }
<a name="l00585"></a>00585 
<a name="l00586"></a>00586 
<a name="l00587"></a>00587         sds[ib].<a class="code" href="struct_s_d_s.html#a807c87944de39fa4f4f27272ce63cd14">factor</a> = 1;
<a name="l00588"></a>00588         attr_name = <span class="stringliteral">&quot;reflectance_scales&quot;</span>;
<a name="l00589"></a>00589         <span class="keywordflow">if</span> ( (attr_index = SDfindattr(sds[ib].<span class="keywordtype">id</span>, attr_name)) != -1  &amp;&amp;
<a name="l00590"></a>00590             SDattrinfo(sds[ib].<span class="keywordtype">id</span>, attr_index, dummy, &amp;num_type, &amp;count) != -1  &amp;&amp;
<a name="l00591"></a>00591             SDreadattr(sds[ib].<span class="keywordtype">id</span>, attr_index, scale_factor) != -1 )
<a name="l00592"></a>00592             sds[ib].<a class="code" href="struct_s_d_s.html#a807c87944de39fa4f4f27272ce63cd14">factor</a> = ((float32 *)scale_factor)[indexlocator[ib]];
<a name="l00593"></a>00593         <span class="keywordflow">else</span> {
<a name="l00594"></a>00594             attr_name = <span class="stringliteral">&quot;scale_factor&quot;</span>;
<a name="l00595"></a>00595             <span class="keywordflow">if</span> ((attr_index = SDfindattr(sds[ib].<span class="keywordtype">id</span>, attr_name)) != -1  &amp;&amp;
<a name="l00596"></a>00596                 SDattrinfo(sds[ib].<span class="keywordtype">id</span>, attr_index, dummy, &amp;num_type, &amp;count) != -1  &amp;&amp;
<a name="l00597"></a>00597                 SDreadattr(sds[ib].<span class="keywordtype">id</span>, attr_index, scale_factor) != -1 )
<a name="l00598"></a>00598                 sds[ib].factor = *scale_factor;
<a name="l00599"></a>00599         }
<a name="l00600"></a>00600 
<a name="l00601"></a>00601         sds[ib].<a class="code" href="struct_s_d_s.html#aa24cece8b1c8bcc4268ed11c89fcda91">offset</a> = 0;
<a name="l00602"></a>00602         attr_name = <span class="stringliteral">&quot;reflectance_offsets&quot;</span>;
<a name="l00603"></a>00603         <span class="keywordflow">if</span> ( (attr_index = SDfindattr(sds[ib].<span class="keywordtype">id</span>, attr_name)) != -1  &amp;&amp;
<a name="l00604"></a>00604             SDattrinfo(sds[ib].<span class="keywordtype">id</span>, attr_index, dummy, &amp;num_type, &amp;count) != -1  &amp;&amp;
<a name="l00605"></a>00605             SDreadattr(sds[ib].<span class="keywordtype">id</span>, attr_index, add_offset) != -1 )
<a name="l00606"></a>00606             sds[ib].offset = ((float32 *)add_offset)[indexlocator[ib]];
<a name="l00607"></a>00607         <span class="keywordflow">else</span> {
<a name="l00608"></a>00608             attr_name = <span class="stringliteral">&quot;add_offset&quot;</span>;
<a name="l00609"></a>00609             <span class="keywordflow">if</span> ( (attr_index = SDfindattr(sds[ib].<span class="keywordtype">id</span>, attr_name)) != -1  &amp;&amp;
<a name="l00610"></a>00610                 SDattrinfo(sds[ib].<span class="keywordtype">id</span>, attr_index, dummy, &amp;num_type, &amp;count) != -1  &amp;&amp;
<a name="l00611"></a>00611                 SDreadattr(sds[ib].<span class="keywordtype">id</span>, attr_index, add_offset) != -1 )
<a name="l00612"></a>00612                 sds[ib].offset = *add_offset;
<a name="l00613"></a>00613         }
<a name="l00614"></a>00614 
<a name="l00615"></a>00615 
<a name="l00616"></a>00616         sds[ib].<a class="code" href="struct_s_d_s.html#ac5abb67b2d2204c1dba5fd732876b853">fillvalue</a> = (<span class="keywordtype">void</span> *) malloc(1 * DFKNTsize(sds[ib].num_type));
<a name="l00617"></a>00617         <span class="keywordflow">if</span> ( SDgetfillvalue(sds[ib].<span class="keywordtype">id</span>, sds[ib].fillvalue) != 0 ) {
<a name="l00618"></a>00618             fprintf(stderr, <span class="stringliteral">&quot;Cannot read fill value of SDS \&quot;%s\&quot;.\n&quot;</span>, sds[ib].name);
<a name="l00619"></a>00619             exit(1);
<a name="l00620"></a>00620         }
<a name="l00621"></a>00621 
<a name="l00622"></a>00622         <span class="keywordflow">switch</span> (sds[ib].rank) {
<a name="l00623"></a>00623             <span class="keywordflow">case</span> 2:
<a name="l00624"></a>00624                 sds[ib].<a class="code" href="struct_s_d_s.html#a5c6d246108e3d9140aa1d36727343589">Nl</a> = sds[ib].<a class="code" href="struct_s_d_s.html#a6adc2e571f8eea012d219d86ef529e3f">dim_sizes</a>[0];
<a name="l00625"></a>00625                 sds[ib].<a class="code" href="struct_s_d_s.html#a0ebeb3f80372d82ebedc44076e6b7809">Np</a> = sds[ib].<a class="code" href="struct_s_d_s.html#a6adc2e571f8eea012d219d86ef529e3f">dim_sizes</a>[1];
<a name="l00626"></a>00626                 sds[ib].<a class="code" href="struct_s_d_s.html#a94bb1507581010e63fe8f8d380a964dc">rowsperscan</a> = (int)(<a class="code" href="crefl_8c.html#abde84ab82c507dacae8601d156422db2">NUM1KMROWPERSCAN</a> * sds[ib].Np / (<span class="keywordtype">float</span>)<a class="code" href="crefl_8c.html#ac73cf6d49edeb864e94ba04a5917fa90">NUM1KMCOLPERSCAN</a> + 0.5);
<a name="l00627"></a>00627                 sds[ib].<a class="code" href="struct_s_d_s.html#af79d8d684d5badfef6d6a5e50c970c18">start</a>[1] = 0;
<a name="l00628"></a>00628                 sds[ib].<a class="code" href="struct_s_d_s.html#ae4e2e1f4bcbc4bee7383f9bfb0c7efe4">edges</a>[0] = sds[ib].<a class="code" href="struct_s_d_s.html#a94bb1507581010e63fe8f8d380a964dc">rowsperscan</a>;
<a name="l00629"></a>00629                 sds[ib].<a class="code" href="struct_s_d_s.html#ae4e2e1f4bcbc4bee7383f9bfb0c7efe4">edges</a>[1] = sds[ib].<a class="code" href="struct_s_d_s.html#a0ebeb3f80372d82ebedc44076e6b7809">Np</a>;
<a name="l00630"></a>00630                 <span class="keywordflow">break</span>;
<a name="l00631"></a>00631             <span class="keywordflow">case</span> 3:
<a name="l00632"></a>00632                 sds[ib].<a class="code" href="struct_s_d_s.html#a5c6d246108e3d9140aa1d36727343589">Nl</a> = sds[ib].<a class="code" href="struct_s_d_s.html#a6adc2e571f8eea012d219d86ef529e3f">dim_sizes</a>[1];
<a name="l00633"></a>00633                 sds[ib].<a class="code" href="struct_s_d_s.html#a0ebeb3f80372d82ebedc44076e6b7809">Np</a> = sds[ib].<a class="code" href="struct_s_d_s.html#a6adc2e571f8eea012d219d86ef529e3f">dim_sizes</a>[2];
<a name="l00634"></a>00634                 sds[ib].<a class="code" href="struct_s_d_s.html#a94bb1507581010e63fe8f8d380a964dc">rowsperscan</a> = (int)(<a class="code" href="crefl_8c.html#abde84ab82c507dacae8601d156422db2">NUM1KMROWPERSCAN</a> * sds[ib].Np / (<span class="keywordtype">float</span>)<a class="code" href="crefl_8c.html#ac73cf6d49edeb864e94ba04a5917fa90">NUM1KMCOLPERSCAN</a> + 0.5);
<a name="l00635"></a>00635                 sds[ib].<a class="code" href="struct_s_d_s.html#af79d8d684d5badfef6d6a5e50c970c18">start</a>[0] = indexlocator[ib];
<a name="l00636"></a>00636                 sds[ib].<a class="code" href="struct_s_d_s.html#af79d8d684d5badfef6d6a5e50c970c18">start</a>[2] = 0;
<a name="l00637"></a>00637                 sds[ib].<a class="code" href="struct_s_d_s.html#ae4e2e1f4bcbc4bee7383f9bfb0c7efe4">edges</a>[0] = 1;
<a name="l00638"></a>00638                 sds[ib].<a class="code" href="struct_s_d_s.html#ae4e2e1f4bcbc4bee7383f9bfb0c7efe4">edges</a>[1] = sds[ib].<a class="code" href="struct_s_d_s.html#a94bb1507581010e63fe8f8d380a964dc">rowsperscan</a>;
<a name="l00639"></a>00639                 sds[ib].<a class="code" href="struct_s_d_s.html#ae4e2e1f4bcbc4bee7383f9bfb0c7efe4">edges</a>[2] = sds[ib].<a class="code" href="struct_s_d_s.html#a0ebeb3f80372d82ebedc44076e6b7809">Np</a>;
<a name="l00640"></a>00640                 <span class="keywordflow">break</span>;
<a name="l00641"></a>00641             <span class="keywordflow">default</span>:
<a name="l00642"></a>00642                 fprintf(stderr, <span class="stringliteral">&quot;SDS rank must be 2 or 3.\n&quot;</span>);
<a name="l00643"></a>00643                 <span class="keywordflow">continue</span>;
<a name="l00644"></a>00644         }
<a name="l00645"></a>00645         <span class="keywordflow">if</span> (verbose)
<a name="l00646"></a>00646             printf(<span class="stringliteral">&quot;SDS \&quot;%s\&quot;: %dx%d   scale factor: %g  offset: %g\n&quot;</span>, sds[ib].name, sds[ib].Np, sds[ib].Nl, sds[ib].factor, sds[ib].offset);
<a name="l00647"></a>00647         <span class="keywordflow">if</span> (sds[ib].num_type != numtypelocator[ib]) {
<a name="l00648"></a>00648             fprintf(stderr, <span class="stringliteral">&quot;SDS \&quot;%s\&quot; has not the expected data type.\n&quot;</span>, sds[ib].name);
<a name="l00649"></a>00649             exit(-1);
<a name="l00650"></a>00650         }
<a name="l00651"></a>00651         sds[ib].<a class="code" href="struct_s_d_s.html#a735984d41155bc1032e09bece8f8d66d">data</a> = malloc(sds[ib].Np * sds[ib].rowsperscan * DFKNTsize(sds[ib].num_type));
<a name="l00652"></a>00652         <span class="keywordflow">if</span> (!sds[ib].data) {
<a name="l00653"></a>00653             (void) fputs(<span class="stringliteral">&quot;Error allocating memory.\n&quot;</span>, stderr);
<a name="l00654"></a>00654             exit(1);
<a name="l00655"></a>00655         }
<a name="l00656"></a>00656     }
<a name="l00657"></a>00657 
<a name="l00658"></a>00658     <span class="keywordflow">if</span> (sealevel || TOA) {
<a name="l00659"></a>00659         dem.<a class="code" href="struct_s_d_s.html#a51be18c1422c1f14d31c199caf6642e6">id</a> = -1;
<a name="l00660"></a>00660         dem.<a class="code" href="struct_s_d_s.html#a5c6d246108e3d9140aa1d36727343589">Nl</a> = dem.<a class="code" href="struct_s_d_s.html#a0ebeb3f80372d82ebedc44076e6b7809">Np</a> = 0;
<a name="l00661"></a>00661     }
<a name="l00662"></a>00662     <span class="keywordflow">else</span> {
<a name="l00663"></a>00663         <span class="comment">/* dem.name = strdup(DEMSDSNAME); */</span>
<a name="l00664"></a>00664         dem.<a class="code" href="struct_s_d_s.html#a5ac083a645d964373f022d03df4849c8">name</a> = <a class="code" href="crefl_8c.html#a1eb8991a722c9cecf996fd0e85e47892">DEMSDSNAME</a>;
<a name="l00665"></a>00665 
<a name="l00666"></a>00666         <span class="keywordflow">if</span> ( (dem.<a class="code" href="struct_s_d_s.html#a15e1b067c35ac56aa9973ab69ddb0cd3">index</a> = SDnametoindex(dem.<a class="code" href="struct_s_d_s.html#a797dbc1344311c85615adc59b0070867">file_id</a>, dem.<a class="code" href="struct_s_d_s.html#a5ac083a645d964373f022d03df4849c8">name</a>)) == -1 ) {
<a name="l00667"></a>00667             fprintf(stderr, <span class="stringliteral">&quot;Cannot find SDS %s in file %s.\n&quot;</span>, dem.<a class="code" href="struct_s_d_s.html#a5ac083a645d964373f022d03df4849c8">name</a>, dem.<a class="code" href="struct_s_d_s.html#aeac90097f29f7529968697163cea5c18">filename</a>);
<a name="l00668"></a>00668             exit(1);
<a name="l00669"></a>00669         }
<a name="l00670"></a>00670 
<a name="l00671"></a>00671         <span class="keywordflow">if</span> ( (dem.<a class="code" href="struct_s_d_s.html#a51be18c1422c1f14d31c199caf6642e6">id</a> = SDselect(dem.<a class="code" href="struct_s_d_s.html#a797dbc1344311c85615adc59b0070867">file_id</a>, dem.<a class="code" href="struct_s_d_s.html#a15e1b067c35ac56aa9973ab69ddb0cd3">index</a>)) == -1 ) {
<a name="l00672"></a>00672             fprintf(stderr, <span class="stringliteral">&quot;Cannot select SDS no. %d\n&quot;</span>, dem.<a class="code" href="struct_s_d_s.html#a15e1b067c35ac56aa9973ab69ddb0cd3">index</a>);
<a name="l00673"></a>00673             exit(1);
<a name="l00674"></a>00674         }
<a name="l00675"></a>00675         <span class="keywordflow">if</span> (SDgetinfo(dem.<a class="code" href="struct_s_d_s.html#a51be18c1422c1f14d31c199caf6642e6">id</a>, dummy, &amp;dem.<a class="code" href="struct_s_d_s.html#a06c075abcc246ce8cb3a327f90002328">rank</a>, dem.<a class="code" href="struct_s_d_s.html#a6adc2e571f8eea012d219d86ef529e3f">dim_sizes</a>, &amp;dem.<a class="code" href="struct_s_d_s.html#a0e5f7647ec94a04f8e306e7a5db2facd">num_type</a>, &amp;dem.<a class="code" href="struct_s_d_s.html#a1fb7c3b2401f8c72d84afd97d87442ee">n_attr</a>) == -1) {
<a name="l00676"></a>00676             fprintf(stderr, <span class="stringliteral">&quot;Can&#39;t get info from SDS \&quot;%s\&quot; in file %s.\n&quot;</span>, dem.<a class="code" href="struct_s_d_s.html#a5ac083a645d964373f022d03df4849c8">name</a>, dem.<a class="code" href="struct_s_d_s.html#aeac90097f29f7529968697163cea5c18">filename</a>);
<a name="l00677"></a>00677             SDendaccess(dem.<a class="code" href="struct_s_d_s.html#a51be18c1422c1f14d31c199caf6642e6">id</a>);
<a name="l00678"></a>00678             exit(1);
<a name="l00679"></a>00679         }
<a name="l00680"></a>00680 
<a name="l00681"></a>00681         dem.<a class="code" href="struct_s_d_s.html#a5c6d246108e3d9140aa1d36727343589">Nl</a> = dem.<a class="code" href="struct_s_d_s.html#a6adc2e571f8eea012d219d86ef529e3f">dim_sizes</a>[0];
<a name="l00682"></a>00682         dem.<a class="code" href="struct_s_d_s.html#a0ebeb3f80372d82ebedc44076e6b7809">Np</a> = dem.<a class="code" href="struct_s_d_s.html#a6adc2e571f8eea012d219d86ef529e3f">dim_sizes</a>[1];
<a name="l00683"></a>00683         dem.<a class="code" href="struct_s_d_s.html#a94bb1507581010e63fe8f8d380a964dc">rowsperscan</a> = (int)(<a class="code" href="crefl_8c.html#abde84ab82c507dacae8601d156422db2">NUM1KMROWPERSCAN</a> * dem.<a class="code" href="struct_s_d_s.html#a0ebeb3f80372d82ebedc44076e6b7809">Np</a> / (<span class="keywordtype">float</span>)<a class="code" href="crefl_8c.html#ac73cf6d49edeb864e94ba04a5917fa90">NUM1KMCOLPERSCAN</a> + 0.5);
<a name="l00684"></a>00684     }
<a name="l00685"></a>00685 
<a name="l00686"></a>00686     <span class="keywordflow">if</span> ( sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55bad8f798e8c6187b0f954f8e1c5242676c">SOLZ</a>].<span class="keywordtype">id</span> == -1 ||
<a name="l00687"></a>00687         sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba121b0531d586fd21bc238b45301e91e6">SOLA</a>].<span class="keywordtype">id</span> == -1 ||
<a name="l00688"></a>00688         sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55bacc111a7dd4eead6275985b9364cd1acf">SENZ</a>].<span class="keywordtype">id</span> == -1 ||
<a name="l00689"></a>00689         sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba5beedd32e3c0e217293f68703b0791ad">SENA</a>].<span class="keywordtype">id</span> == -1 ||
<a name="l00690"></a>00690         sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba99d3d71739b89a1e680a59b017d8ab5a">LON</a>].<span class="keywordtype">id</span> == -1 ||
<a name="l00691"></a>00691         sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba40df096e8ca19a820dbd94de79e97b3b">LAT</a>].<span class="keywordtype">id</span> == -1 ||
<a name="l00692"></a>00692         ((dem.<a class="code" href="struct_s_d_s.html#a51be18c1422c1f14d31c199caf6642e6">id</a> == -1) &amp;&amp; !sealevel &amp;&amp; !TOA) ) {
<a name="l00693"></a>00693             fprintf(stderr, <span class="stringliteral">&quot;Solar and Sensor angles and DEM are necessary to process granule.\n&quot;</span>);
<a name="l00694"></a>00694             exit(1);
<a name="l00695"></a>00695         }
<a name="l00696"></a>00696 
<a name="l00697"></a>00697     <span class="keywordflow">if</span> ( sds[<a class="code" href="crefl_8c.html#a4fa71a95176afc5b14dbdd117890cd4c">REFSDS</a>].Np != sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55bad8f798e8c6187b0f954f8e1c5242676c">SOLZ</a>].Np ||
<a name="l00698"></a>00698         sds[<a class="code" href="crefl_8c.html#a4fa71a95176afc5b14dbdd117890cd4c">REFSDS</a>].Np != sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba121b0531d586fd21bc238b45301e91e6">SOLA</a>].Np ||
<a name="l00699"></a>00699         sds[<a class="code" href="crefl_8c.html#a4fa71a95176afc5b14dbdd117890cd4c">REFSDS</a>].Np != sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55bacc111a7dd4eead6275985b9364cd1acf">SENZ</a>].Np ||
<a name="l00700"></a>00700         sds[<a class="code" href="crefl_8c.html#a4fa71a95176afc5b14dbdd117890cd4c">REFSDS</a>].Np != sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba5beedd32e3c0e217293f68703b0791ad">SENA</a>].Np ||
<a name="l00701"></a>00701         sds[<a class="code" href="crefl_8c.html#a4fa71a95176afc5b14dbdd117890cd4c">REFSDS</a>].Np != sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba99d3d71739b89a1e680a59b017d8ab5a">LON</a>].Np ||
<a name="l00702"></a>00702         sds[<a class="code" href="crefl_8c.html#a4fa71a95176afc5b14dbdd117890cd4c">REFSDS</a>].Np != sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba40df096e8ca19a820dbd94de79e97b3b">LAT</a>].Np ) {
<a name="l00703"></a>00703             fprintf(stderr, <span class="stringliteral">&quot;Solar and Sensor angles must have identical dimensions.\n&quot;</span>);
<a name="l00704"></a>00704             exit(1);
<a name="l00705"></a>00705         }
<a name="l00706"></a>00706 
<a name="l00707"></a>00707     ib = 0;
<a name="l00708"></a>00708     <span class="keywordflow">while</span> (sds[ib].<span class="keywordtype">id</span> == -1) ib++;
<a name="l00709"></a>00709     <span class="keywordflow">if</span> (ib &gt;= Nbands) {
<a name="l00710"></a>00710         fprintf(stderr, <span class="stringliteral">&quot;No L1B SDS can be read successfully.\n&quot;</span>);
<a name="l00711"></a>00711         exit(1);
<a name="l00712"></a>00712     }
<a name="l00713"></a>00713 
<a name="l00714"></a>00714     Nscans = sds[ib].<a class="code" href="struct_s_d_s.html#a5c6d246108e3d9140aa1d36727343589">Nl</a> / sds[ib].<a class="code" href="struct_s_d_s.html#a94bb1507581010e63fe8f8d380a964dc">rowsperscan</a>;
<a name="l00715"></a>00715 
<a name="l00716"></a>00716 
<a name="l00717"></a>00717     <span class="comment">/* finally, open output file */</span>
<a name="l00718"></a>00718     <span class="keywordflow">if</span> ( (sd_id = SDstart(filename, write_mode)) == -1 ) {
<a name="l00719"></a>00719         fprintf(stderr, <span class="stringliteral">&quot;Cannot open output file %s.\n&quot;</span>, filename);
<a name="l00720"></a>00720         exit(1);
<a name="l00721"></a>00721     }
<a name="l00722"></a>00722 
<a name="l00723"></a>00723     <span class="keywordflow">if</span> (!append) {
<a name="l00724"></a>00724         <span class="keywordflow">if</span> (<a class="code" href="crefl_8c.html#a3637dc4696007f69ab959a1389462340">write_global_attributes</a>(sd_id, MOD021KMfile, MOD02HKMfile,
<a name="l00725"></a>00725                                     MOD02QKMfile, maxsolz, sealevel, TOA, nearest)) {
<a name="l00726"></a>00726                                         fputs(<span class="stringliteral">&quot;Error writing global attributes.\n&quot;</span>, stderr);
<a name="l00727"></a>00727                                         exit(1);
<a name="l00728"></a>00728                                     }
<a name="l00729"></a>00729     }
<a name="l00730"></a>00730 
<a name="l00731"></a>00731     <span class="comment">/* create output SDSs and set SDS-specific attributes and dimension names */</span>
<a name="l00732"></a>00732     <span class="keywordflow">if</span> (<a class="code" href="crefl_8c.html#a0d5302aebefded49b66860d05d1724e5">init_output_sds</a>(sd_id, process, outsds, sds, gzip, verbose)) exit(1);
<a name="l00733"></a>00733 
<a name="l00734"></a>00734 
<a name="l00735"></a>00735     mus = (<span class="keywordtype">float</span> *) malloc(sds[<a class="code" href="crefl_8c.html#a4fa71a95176afc5b14dbdd117890cd4c">REFSDS</a>].rowsperscan * sds[<a class="code" href="crefl_8c.html#a4fa71a95176afc5b14dbdd117890cd4c">REFSDS</a>].Np * <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l00736"></a>00736     height.<a class="code" href="struct_s_d_s.html#a735984d41155bc1032e09bece8f8d66d">data</a> = (int16 *) malloc(sds[<a class="code" href="crefl_8c.html#a4fa71a95176afc5b14dbdd117890cd4c">REFSDS</a>].rowsperscan * sds[<a class="code" href="crefl_8c.html#a4fa71a95176afc5b14dbdd117890cd4c">REFSDS</a>].Np * <span class="keyword">sizeof</span>(int16));
<a name="l00737"></a>00737     <span class="keywordflow">if</span> (!mus || !height.<a class="code" href="struct_s_d_s.html#a735984d41155bc1032e09bece8f8d66d">data</a>) {
<a name="l00738"></a>00738         (void) fputs(<span class="stringliteral">&quot;Error allocating memory.\n&quot;</span>, stderr);
<a name="l00739"></a>00739         exit(1);
<a name="l00740"></a>00740     }
<a name="l00741"></a>00741 
<a name="l00742"></a>00742     <span class="keywordflow">if</span> (sealevel || TOA)
<a name="l00743"></a>00743         dem.<a class="code" href="struct_s_d_s.html#a735984d41155bc1032e09bece8f8d66d">data</a> = (<span class="keywordtype">void</span> *) NULL;
<a name="l00744"></a>00744     <span class="keywordflow">else</span> {
<a name="l00745"></a>00745         dem.<a class="code" href="struct_s_d_s.html#a735984d41155bc1032e09bece8f8d66d">data</a> = (int16 *) malloc(dem.<a class="code" href="struct_s_d_s.html#a5c6d246108e3d9140aa1d36727343589">Nl</a> * dem.<a class="code" href="struct_s_d_s.html#a0ebeb3f80372d82ebedc44076e6b7809">Np</a> * <span class="keyword">sizeof</span>(int16));
<a name="l00746"></a>00746         <span class="keywordflow">if</span> (!dem.<a class="code" href="struct_s_d_s.html#a735984d41155bc1032e09bece8f8d66d">data</a>) {
<a name="l00747"></a>00747             (void) fputs(<span class="stringliteral">&quot;Error allocating memory.\n&quot;</span>, stderr);
<a name="l00748"></a>00748             exit(1);
<a name="l00749"></a>00749         }
<a name="l00750"></a>00750     }
<a name="l00751"></a>00751 
<a name="l00752"></a>00752     <span class="keywordflow">if</span> (!TOA) {
<a name="l00753"></a>00753         nbytes = Nbands * sds[<a class="code" href="crefl_8c.html#a4fa71a95176afc5b14dbdd117890cd4c">REFSDS</a>].<a class="code" href="struct_s_d_s.html#a94bb1507581010e63fe8f8d380a964dc">rowsperscan</a> * sds[<a class="code" href="crefl_8c.html#a4fa71a95176afc5b14dbdd117890cd4c">REFSDS</a>].<a class="code" href="struct_s_d_s.html#a0ebeb3f80372d82ebedc44076e6b7809">Np</a> * <span class="keyword">sizeof</span>(float);
<a name="l00754"></a>00754 
<a name="l00755"></a>00755         rhoray =      (<span class="keywordtype">float</span> *) malloc(nbytes);
<a name="l00756"></a>00756         sphalb =      (<span class="keywordtype">float</span> *) malloc(nbytes);
<a name="l00757"></a>00757         TtotraytH2O = (<span class="keywordtype">float</span> *) malloc(nbytes);
<a name="l00758"></a>00758         tOG =         (<span class="keywordtype">float</span> *) malloc(nbytes);
<a name="l00759"></a>00759 
<a name="l00760"></a>00760         <span class="keywordflow">if</span> (!rhoray || !sphalb || !TtotraytH2O || !tOG) {
<a name="l00761"></a>00761             (void) fputs(<span class="stringliteral">&quot;Error allocating memory.\n&quot;</span>, stderr);
<a name="l00762"></a>00762             exit(1);
<a name="l00763"></a>00763         }
<a name="l00764"></a>00764     }
<a name="l00765"></a>00765 
<a name="l00766"></a>00766     solz = sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55bad8f798e8c6187b0f954f8e1c5242676c">SOLZ</a>].<a class="code" href="struct_s_d_s.html#a735984d41155bc1032e09bece8f8d66d">data</a>;
<a name="l00767"></a>00767     sola = sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba121b0531d586fd21bc238b45301e91e6">SOLA</a>].<a class="code" href="struct_s_d_s.html#a735984d41155bc1032e09bece8f8d66d">data</a>;
<a name="l00768"></a>00768     senz = sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55bacc111a7dd4eead6275985b9364cd1acf">SENZ</a>].<a class="code" href="struct_s_d_s.html#a735984d41155bc1032e09bece8f8d66d">data</a>;
<a name="l00769"></a>00769     sena = sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba5beedd32e3c0e217293f68703b0791ad">SENA</a>].<a class="code" href="struct_s_d_s.html#a735984d41155bc1032e09bece8f8d66d">data</a>;
<a name="l00770"></a>00770     solzfill = sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55bad8f798e8c6187b0f954f8e1c5242676c">SOLZ</a>].<a class="code" href="struct_s_d_s.html#ac5abb67b2d2204c1dba5fd732876b853">fillvalue</a>;
<a name="l00771"></a>00771     lon = sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba99d3d71739b89a1e680a59b017d8ab5a">LON</a>].<a class="code" href="struct_s_d_s.html#a735984d41155bc1032e09bece8f8d66d">data</a>;
<a name="l00772"></a>00772     lat = sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba40df096e8ca19a820dbd94de79e97b3b">LAT</a>].<a class="code" href="struct_s_d_s.html#a735984d41155bc1032e09bece8f8d66d">data</a>;
<a name="l00773"></a>00773     lonfill = sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba99d3d71739b89a1e680a59b017d8ab5a">LON</a>].<a class="code" href="struct_s_d_s.html#ac5abb67b2d2204c1dba5fd732876b853">fillvalue</a>;
<a name="l00774"></a>00774     latfill = sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba40df096e8ca19a820dbd94de79e97b3b">LAT</a>].<a class="code" href="struct_s_d_s.html#ac5abb67b2d2204c1dba5fd732876b853">fillvalue</a>;
<a name="l00775"></a>00775     <span class="keywordflow">for</span> (ib = 0; ib &lt; <a class="code" href="crefl_8c.html#a4f9b6b07384112c4eb1ee3b543a08a62">Nbands</a>; ib++) l1bdata[ib] = sds[ib].data;
<a name="l00776"></a>00776 
<a name="l00777"></a>00777     <span class="comment">/* don&#39;t need DEM if --sealevel or --toa specified */</span>
<a name="l00778"></a>00778     <span class="keywordflow">if</span> (!sealevel &amp;&amp; !TOA) {
<a name="l00779"></a>00779         dem.<a class="code" href="struct_s_d_s.html#af79d8d684d5badfef6d6a5e50c970c18">start</a>[0] = 0;
<a name="l00780"></a>00780         dem.<a class="code" href="struct_s_d_s.html#af79d8d684d5badfef6d6a5e50c970c18">start</a>[1] = 0;
<a name="l00781"></a>00781         dem.<a class="code" href="struct_s_d_s.html#ae4e2e1f4bcbc4bee7383f9bfb0c7efe4">edges</a>[0] = dem.<a class="code" href="struct_s_d_s.html#a5c6d246108e3d9140aa1d36727343589">Nl</a>;
<a name="l00782"></a>00782         dem.<a class="code" href="struct_s_d_s.html#ae4e2e1f4bcbc4bee7383f9bfb0c7efe4">edges</a>[1] = dem.<a class="code" href="struct_s_d_s.html#a0ebeb3f80372d82ebedc44076e6b7809">Np</a>;
<a name="l00783"></a>00783         <span class="keywordflow">if</span> (SDreaddata(dem.<a class="code" href="struct_s_d_s.html#a51be18c1422c1f14d31c199caf6642e6">id</a>, dem.<a class="code" href="struct_s_d_s.html#af79d8d684d5badfef6d6a5e50c970c18">start</a>, NULL, dem.<a class="code" href="struct_s_d_s.html#ae4e2e1f4bcbc4bee7383f9bfb0c7efe4">edges</a>, dem.<a class="code" href="struct_s_d_s.html#a735984d41155bc1032e09bece8f8d66d">data</a>) == -1) {
<a name="l00784"></a>00784             fprintf(stderr, <span class="stringliteral">&quot;  Can&#39;t read DEM SDS \&quot;%s\&quot;\n&quot;</span>, dem.<a class="code" href="struct_s_d_s.html#a5ac083a645d964373f022d03df4849c8">name</a>);
<a name="l00785"></a>00785             exit(-1);
<a name="l00786"></a>00786         }
<a name="l00787"></a>00787         (void) SDendaccess(dem.<a class="code" href="struct_s_d_s.html#a51be18c1422c1f14d31c199caf6642e6">id</a>);
<a name="l00788"></a>00788         (void) SDend(dem.<a class="code" href="struct_s_d_s.html#a797dbc1344311c85615adc59b0070867">file_id</a>);
<a name="l00789"></a>00789     }
<a name="l00790"></a>00790 
<a name="l00791"></a>00791     <span class="comment">/* loop over each MODIS scan */</span>
<a name="l00792"></a>00792     <span class="keywordflow">for</span> (iscan = 0; iscan &lt; Nscans; iscan++) {
<a name="l00793"></a>00793         <span class="keywordflow">if</span> ((iscan % <a class="code" href="crefl_8c.html#abde84ab82c507dacae8601d156422db2">NUM1KMROWPERSCAN</a> == 0) &amp;&amp; verbose)
<a name="l00794"></a>00794             printf(<span class="stringliteral">&quot;Processing scan %d...\n&quot;</span>, iscan);
<a name="l00795"></a>00795 
<a name="l00796"></a>00796         <span class="comment">/* Fill scan buffer for each band to be processed.</span>
<a name="l00797"></a>00797 <span class="comment">         Exit scan loop if error occurred while reading. */</span>
<a name="l00798"></a>00798         <span class="keywordflow">if</span> (<a class="code" href="crefl_8c.html#a643f58417a2090718c068e57aade5fec">read_scan</a>(iscan, sds)) <span class="keywordflow">break</span>;
<a name="l00799"></a>00799 
<a name="l00800"></a>00800         <span class="keywordflow">for</span> (idx = 0; idx &lt; sds[<a class="code" href="crefl_8c.html#a4fa71a95176afc5b14dbdd117890cd4c">REFSDS</a>].<a class="code" href="struct_s_d_s.html#a94bb1507581010e63fe8f8d380a964dc">rowsperscan</a>*sds[<a class="code" href="crefl_8c.html#a4fa71a95176afc5b14dbdd117890cd4c">REFSDS</a>].<a class="code" href="struct_s_d_s.html#a0ebeb3f80372d82ebedc44076e6b7809">Np</a>; idx++) {
<a name="l00801"></a>00801             <span class="keywordflow">if</span> (solz[idx] * sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55bad8f798e8c6187b0f954f8e1c5242676c">SOLZ</a>].factor &gt;= maxsolz)
<a name="l00802"></a>00802                 solz[idx] = *solzfill;
<a name="l00803"></a>00803 
<a name="l00804"></a>00804             <span class="keywordflow">if</span> (!sealevel &amp;&amp;
<a name="l00805"></a>00805                 (lon[idx] == *lonfill || lat[idx] == *latfill))
<a name="l00806"></a>00806                 solz[idx] = *solzfill;
<a name="l00807"></a>00807 
<a name="l00808"></a>00808             <span class="keywordflow">if</span> (solz[idx] != *solzfill) {
<a name="l00809"></a>00809                 mus[idx] = cos(solz[idx] * sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55bad8f798e8c6187b0f954f8e1c5242676c">SOLZ</a>].factor * <a class="code" href="crefl_8c.html#af7e8592d0a634bd3642e9fd508ea8022">DEG2RAD</a>);
<a name="l00810"></a>00810 
<a name="l00811"></a>00811                 <span class="keywordflow">if</span> (sealevel || TOA)
<a name="l00812"></a>00812                     ((int16 *)height.<a class="code" href="struct_s_d_s.html#a735984d41155bc1032e09bece8f8d66d">data</a>)[idx] = 0;
<a name="l00813"></a>00813                 <span class="keywordflow">else</span>
<a name="l00814"></a>00814                     ((int16 *)height.<a class="code" href="struct_s_d_s.html#a735984d41155bc1032e09bece8f8d66d">data</a>)[idx] =
<a name="l00815"></a>00815                     (int16) <a class="code" href="crefl_8c.html#a64cbe8c9b98670a4a456f0ff29fc3abe">interp_dem</a>(lat[idx],
<a name="l00816"></a>00816                                        lon[idx], &amp;dem);
<a name="l00817"></a>00817             }
<a name="l00818"></a>00818         }
<a name="l00819"></a>00819 
<a name="l00820"></a>00820 
<a name="l00821"></a>00821         <span class="keywordflow">if</span> (!TOA) {
<a name="l00822"></a>00822             <span class="keywordflow">for</span> (irow=0; irow&lt;sds[<a class="code" href="crefl_8c.html#a4fa71a95176afc5b14dbdd117890cd4c">REFSDS</a>].<a class="code" href="struct_s_d_s.html#a94bb1507581010e63fe8f8d380a964dc">rowsperscan</a>; irow++) {
<a name="l00823"></a>00823                 <span class="keywordflow">for</span> (jcol=0; jcol&lt;sds[<a class="code" href="crefl_8c.html#a4fa71a95176afc5b14dbdd117890cd4c">REFSDS</a>].<a class="code" href="struct_s_d_s.html#a0ebeb3f80372d82ebedc44076e6b7809">Np</a>; jcol++) {
<a name="l00824"></a>00824                     idx = irow * sds[<a class="code" href="crefl_8c.html#a4fa71a95176afc5b14dbdd117890cd4c">REFSDS</a>].<a class="code" href="struct_s_d_s.html#a0ebeb3f80372d82ebedc44076e6b7809">Np</a> + jcol;
<a name="l00825"></a>00825                     <span class="keywordflow">if</span> (solz[idx] == *solzfill) <span class="keywordflow">continue</span>;
<a name="l00826"></a>00826                     phi = sola[idx] * sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba121b0531d586fd21bc238b45301e91e6">SOLA</a>].<a class="code" href="struct_s_d_s.html#a807c87944de39fa4f4f27272ce63cd14">factor</a> - sena[idx] * sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba5beedd32e3c0e217293f68703b0791ad">SENA</a>].<a class="code" href="struct_s_d_s.html#a807c87944de39fa4f4f27272ce63cd14">factor</a>;
<a name="l00827"></a>00827                     muv = cos(senz[idx] * sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55bacc111a7dd4eead6275985b9364cd1acf">SENZ</a>].factor * <a class="code" href="crefl_8c.html#af7e8592d0a634bd3642e9fd508ea8022">DEG2RAD</a>);
<a name="l00828"></a>00828                     <span class="keywordflow">if</span> ( <a class="code" href="crefl_8c.html#a27b2413ebdde89ebd0754edb8876f760">getatmvariables</a>(mus[idx], muv, phi, ((int16 *)height.<a class="code" href="struct_s_d_s.html#a735984d41155bc1032e09bece8f8d66d">data</a>)[idx],
<a name="l00829"></a>00829                                          process,
<a name="l00830"></a>00830                                          &amp;sphalb[idx * Nbands], &amp;rhoray[idx * Nbands],
<a name="l00831"></a>00831                                          &amp;TtotraytH2O[idx * Nbands], &amp;tOG[idx * Nbands]) == -1 )
<a name="l00832"></a>00832                         solz[idx] = *solzfill;
<a name="l00833"></a>00833                 }
<a name="l00834"></a>00834             }
<a name="l00835"></a>00835         }
<a name="l00836"></a>00836 
<a name="l00837"></a>00837         <span class="keywordflow">for</span> (ib=0; ib&lt;<a class="code" href="crefl_8c.html#a4f9b6b07384112c4eb1ee3b543a08a62">Nbands</a>; ib++) {
<a name="l00838"></a>00838             <span class="keywordflow">if</span> (! process[ib]) <span class="keywordflow">continue</span>;
<a name="l00839"></a>00839             aggfactor = outsds[ib].<a class="code" href="struct_s_d_s.html#a94bb1507581010e63fe8f8d380a964dc">rowsperscan</a> / sds[<a class="code" href="crefl_8c.html#a4fa71a95176afc5b14dbdd117890cd4c">REFSDS</a>].<a class="code" href="struct_s_d_s.html#a94bb1507581010e63fe8f8d380a964dc">rowsperscan</a>;
<a name="l00840"></a>00840             <span class="keywordflow">for</span> (irow=0; irow&lt;outsds[ib].<a class="code" href="struct_s_d_s.html#a94bb1507581010e63fe8f8d380a964dc">rowsperscan</a>; irow++) {
<a name="l00841"></a>00841                 <span class="keywordflow">if</span> (!nearest) {
<a name="l00842"></a>00842                     fractrow = (float)irow / aggfactor - 0.5;   <span class="comment">/* We want fractrow integer on coarse pixel center */</span>
<a name="l00843"></a>00843                     crsrow1 = floor(fractrow);
<a name="l00844"></a>00844                     crsrow2 = crsrow1 + 1;
<a name="l00845"></a>00845                     <span class="keywordflow">if</span> (crsrow1 &lt; 0) crsrow1 = crsrow2 + 1;
<a name="l00846"></a>00846                     <span class="keywordflow">if</span> (crsrow2 &gt; sds[<a class="code" href="crefl_8c.html#a4fa71a95176afc5b14dbdd117890cd4c">REFSDS</a>].rowsperscan - 1) crsrow2 = crsrow1 - 1;
<a name="l00847"></a>00847                     t = (fractrow - crsrow1) / (crsrow2 - crsrow1);
<a name="l00848"></a>00848                 }
<a name="l00849"></a>00849 
<a name="l00850"></a>00850                 <span class="keywordflow">for</span> (jcol=0; jcol&lt;outsds[ib].<a class="code" href="struct_s_d_s.html#a0ebeb3f80372d82ebedc44076e6b7809">Np</a>; jcol++) {
<a name="l00851"></a>00851                     idx = irow * outsds[ib].<a class="code" href="struct_s_d_s.html#a0ebeb3f80372d82ebedc44076e6b7809">Np</a> + jcol;
<a name="l00852"></a>00852                     crsidx = (int)(irow / aggfactor) * sds[<a class="code" href="crefl_8c.html#a4fa71a95176afc5b14dbdd117890cd4c">REFSDS</a>].<a class="code" href="struct_s_d_s.html#a0ebeb3f80372d82ebedc44076e6b7809">Np</a> + (int)(jcol / aggfactor);
<a name="l00853"></a>00853                     <span class="keywordflow">if</span> ( solz[crsidx] == *solzfill  ||  <span class="comment">/* Bad geolocation or night pixel */</span>
<a name="l00854"></a>00854                         l1bdata[ib][idx] &lt; 0 ) {        <span class="comment">/* L1B is read as int16, not uint16, so faulty is negative */</span>
<a name="l00855"></a>00855                             <span class="keywordflow">if</span> (l1bdata[ib][idx] == <a class="code" href="crefl_8c.html#a1ef400bc1b6d2383b782aec27e4b4c73">MISSING</a>)
<a name="l00856"></a>00856                                 ((int16 *)outsds[ib].data)[idx] = 32768 + <a class="code" href="crefl_8c.html#a1ef400bc1b6d2383b782aec27e4b4c73">MISSING</a>;
<a name="l00857"></a>00857                             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (l1bdata[ib][idx] == <a class="code" href="crefl_8c.html#a0ab2dcca54f03c77aac9fb4592e671bc">SATURATED</a>)
<a name="l00858"></a>00858                                 ((int16 *)outsds[ib].data)[idx] = 32768 + <a class="code" href="crefl_8c.html#a0ab2dcca54f03c77aac9fb4592e671bc">SATURATED</a>;
<a name="l00859"></a>00859                             <span class="keywordflow">else</span>
<a name="l00860"></a>00860                                 ((int16 *)outsds[ib].<a class="code" href="struct_s_d_s.html#a735984d41155bc1032e09bece8f8d66d">data</a>)[idx] = *(int16 *)outsds[ib].<a class="code" href="struct_s_d_s.html#ac5abb67b2d2204c1dba5fd732876b853">fillvalue</a>;
<a name="l00861"></a>00861 
<a name="l00862"></a>00862                             <span class="keywordflow">continue</span>;
<a name="l00863"></a>00863                         }
<a name="l00864"></a>00864 
<a name="l00865"></a>00865                     <span class="keywordflow">if</span> (nearest) {
<a name="l00866"></a>00866                         mus0 = mus[crsidx];
<a name="l00867"></a>00867                         <span class="keywordflow">if</span> (! TOA) {
<a name="l00868"></a>00868                             rhoray0 = rhoray[crsidx * Nbands + ib];
<a name="l00869"></a>00869                             sphalb0 = sphalb[crsidx * Nbands + ib];
<a name="l00870"></a>00870                             <span class="keywordflow">if</span> ( sphalb0 &lt;= 0.0F ) {    <span class="comment">/* Atm variables not computed successfully in this band */</span>
<a name="l00871"></a>00871                                 ((int16 *)outsds[ib].data)[idx] = *(int16 *)outsds[ib].fillvalue;
<a name="l00872"></a>00872                                 <span class="keywordflow">continue</span>;
<a name="l00873"></a>00873                             }
<a name="l00874"></a>00874                         }
<a name="l00875"></a>00875                     }
<a name="l00876"></a>00876                     <span class="keywordflow">else</span> {
<a name="l00877"></a>00877                         fractcol = ((float) jcol) / aggfactor - 0.5F;   <span class="comment">/* We want fractcol integer on coarse pixel center */</span>
<a name="l00878"></a>00878                         crscol1 = (int) floor(fractcol);
<a name="l00879"></a>00879                         crscol2 = crscol1 + 1;
<a name="l00880"></a>00880                         <span class="keywordflow">if</span> (crscol1 &lt; 0) crscol1 = crscol2 + 1;
<a name="l00881"></a>00881                         <span class="keywordflow">if</span> (crscol2 &gt; sds[<a class="code" href="crefl_8c.html#a4fa71a95176afc5b14dbdd117890cd4c">REFSDS</a>].Np - 1) crscol2 = crscol1 - 1;
<a name="l00882"></a>00882                         u = (fractcol - crscol1) / (crscol2 - crscol1);         <span class="comment">/* We want u=0 on coarse pixel center */</span>
<a name="l00883"></a>00883                         crsidx11 = crsrow1 * sds[<a class="code" href="crefl_8c.html#a4fa71a95176afc5b14dbdd117890cd4c">REFSDS</a>].<a class="code" href="struct_s_d_s.html#a0ebeb3f80372d82ebedc44076e6b7809">Np</a> + crscol1;
<a name="l00884"></a>00884                         crsidx12 = crsrow1 * sds[<a class="code" href="crefl_8c.html#a4fa71a95176afc5b14dbdd117890cd4c">REFSDS</a>].<a class="code" href="struct_s_d_s.html#a0ebeb3f80372d82ebedc44076e6b7809">Np</a> + crscol2;
<a name="l00885"></a>00885                         crsidx21 = crsrow2 * sds[<a class="code" href="crefl_8c.html#a4fa71a95176afc5b14dbdd117890cd4c">REFSDS</a>].<a class="code" href="struct_s_d_s.html#a0ebeb3f80372d82ebedc44076e6b7809">Np</a> + crscol1;
<a name="l00886"></a>00886                         crsidx22 = crsrow2 * sds[<a class="code" href="crefl_8c.html#a4fa71a95176afc5b14dbdd117890cd4c">REFSDS</a>].<a class="code" href="struct_s_d_s.html#a0ebeb3f80372d82ebedc44076e6b7809">Np</a> + crscol2;
<a name="l00887"></a>00887                         mus0 = t * u * mus[crsidx22] + (1.0F - <a class="code" href="somfor_8c.html#a87accd1af8e0aff4b818d891374f7cec">t</a>) * u * mus[crsidx12] + t * (1.0F - u) * mus[crsidx21] + (1.0F - <a class="code" href="somfor_8c.html#a87accd1af8e0aff4b818d891374f7cec">t</a>) * (1.0F - u) * mus[crsidx11];
<a name="l00888"></a>00888 
<a name="l00889"></a>00889                         bad = (solz[crsidx11] == *solzfill) ||
<a name="l00890"></a>00890                             (solz[crsidx12] == *solzfill) ||
<a name="l00891"></a>00891                             (solz[crsidx21] == *solzfill) ||
<a name="l00892"></a>00892                             (solz[crsidx22] == *solzfill);
<a name="l00893"></a>00893 
<a name="l00894"></a>00894                         <span class="keywordflow">if</span> (bad) {
<a name="l00895"></a>00895                             ((int16 *)outsds[ib].data)[idx] = *(int16 *)outsds[ib].fillvalue;
<a name="l00896"></a>00896                             <span class="keywordflow">continue</span>;
<a name="l00897"></a>00897                         }
<a name="l00898"></a>00898 
<a name="l00899"></a>00899                         <span class="keywordflow">if</span> (! TOA) {
<a name="l00900"></a>00900                             rhoray11 = rhoray[crsidx11 * Nbands + ib];
<a name="l00901"></a>00901                             rhoray12 = rhoray[crsidx12 * Nbands + ib];
<a name="l00902"></a>00902                             rhoray21 = rhoray[crsidx21 * Nbands + ib];
<a name="l00903"></a>00903                             rhoray22 = rhoray[crsidx22 * Nbands + ib];
<a name="l00904"></a>00904                             rhoray0 = t * u * rhoray22 + (1.0F - <a class="code" href="somfor_8c.html#a87accd1af8e0aff4b818d891374f7cec">t</a>) * u * rhoray12 + t * (1.0F - u) * rhoray21 + (1.0F - <a class="code" href="somfor_8c.html#a87accd1af8e0aff4b818d891374f7cec">t</a>) * (1.0F - u) * rhoray11;
<a name="l00905"></a>00905                             sphalb11 = sphalb[crsidx11 * Nbands + ib];
<a name="l00906"></a>00906                             sphalb12 = sphalb[crsidx12 * Nbands + ib];
<a name="l00907"></a>00907                             sphalb21 = sphalb[crsidx21 * Nbands + ib];
<a name="l00908"></a>00908                             sphalb22 = sphalb[crsidx22 * Nbands + ib];
<a name="l00909"></a>00909 
<a name="l00910"></a>00910                             bad = (sphalb11 &lt;= 0.0F) ||
<a name="l00911"></a>00911                                 (sphalb12 &lt;= 0.0F) ||
<a name="l00912"></a>00912                                 (sphalb21 &lt;= 0.0F) ||
<a name="l00913"></a>00913                                 (sphalb22 &lt;= 0.0F);
<a name="l00914"></a>00914 
<a name="l00915"></a>00915                             <span class="keywordflow">if</span> (bad) {
<a name="l00916"></a>00916                                 ((int16 *)outsds[ib].data)[idx] = *(int16 *)outsds[ib].fillvalue;
<a name="l00917"></a>00917                                 <span class="keywordflow">continue</span>;
<a name="l00918"></a>00918                             }
<a name="l00919"></a>00919                             sphalb0 = t * u * sphalb22 + (1.0F - <a class="code" href="somfor_8c.html#a87accd1af8e0aff4b818d891374f7cec">t</a>) * u * sphalb12 + t * (1.0F - u) * sphalb21 + (1.0F - <a class="code" href="somfor_8c.html#a87accd1af8e0aff4b818d891374f7cec">t</a>) * (1.0F - u) * sphalb11;
<a name="l00920"></a>00920                         }
<a name="l00921"></a>00921                     }
<a name="l00922"></a>00922 
<a name="l00923"></a>00923                     <span class="comment">/* TOA reflectance */</span>
<a name="l00924"></a>00924                     refl = (l1bdata[ib][idx] - sds[ib].<a class="code" href="struct_s_d_s.html#aa24cece8b1c8bcc4268ed11c89fcda91">offset</a>) * sds[ib].factor / mus0;
<a name="l00925"></a>00925 
<a name="l00926"></a>00926                     <span class="comment">/* corrected reflectance */</span>
<a name="l00927"></a>00927                     <span class="keywordflow">if</span> (!TOA)
<a name="l00928"></a>00928                         refl = <a class="code" href="crefl_8c.html#aced7c98f03682fc136412cfea6a13d10">correctedrefl</a>(refl, TtotraytH2O[crsidx * Nbands + ib],
<a name="l00929"></a>00929                                              tOG[crsidx * Nbands + ib], rhoray0, sphalb0);
<a name="l00930"></a>00930 
<a name="l00931"></a>00931                     <span class="comment">/* reflectance bounds checking */</span>
<a name="l00932"></a>00932                     <span class="keywordflow">if</span> (refl &gt; reflmax) refl = reflmax;
<a name="l00933"></a>00933                     <span class="keywordflow">if</span> (refl &lt; reflmin) refl = reflmin;
<a name="l00934"></a>00934 
<a name="l00935"></a>00935                     ((int16 *)outsds[ib].data)[idx] = (int16) (refl / outsds[ib].factor + 0.5);
<a name="l00936"></a>00936                 }
<a name="l00937"></a>00937             }
<a name="l00938"></a>00938         }
<a name="l00939"></a>00939 
<a name="l00940"></a>00940 
<a name="l00941"></a>00941         <span class="comment">/* write current scan line for all processed bands */</span>
<a name="l00942"></a>00942         <span class="keywordflow">if</span> (<a class="code" href="crefl_8c.html#a589b7cfecc8c4364dac950d290feaf78">write_scan</a>(iscan, process, outsds)) {
<a name="l00943"></a>00943             fprintf(stderr, <span class="stringliteral">&quot;Cannot write scan %d of SDS %s\n&quot;</span>,
<a name="l00944"></a>00944                     iscan, outsds[ib].name);
<a name="l00945"></a>00945             exit(1);
<a name="l00946"></a>00946         }
<a name="l00947"></a>00947 
<a name="l00948"></a>00948     } <span class="comment">/* end of scan loop */</span>
<a name="l00949"></a>00949 
<a name="l00950"></a>00950 
<a name="l00951"></a>00951     <span class="keywordflow">for</span> (ib = 0; ib &lt; <a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba8b602b8b0906ba2c4717e163f1478c8f">Nitems</a>; ib++)
<a name="l00952"></a>00952         <span class="keywordflow">if</span> (sds[ib].<span class="keywordtype">id</span> != -1) SDendaccess(sds[ib].<span class="keywordtype">id</span>);
<a name="l00953"></a>00953 
<a name="l00954"></a>00954     <span class="keywordflow">for</span> (ib = 0; ib &lt; <a class="code" href="crefl_8c.html#a4f9b6b07384112c4eb1ee3b543a08a62">Nbands</a>; ib++)
<a name="l00955"></a>00955         <span class="keywordflow">if</span> (process[ib]) SDendaccess(outsds[ib].<span class="keywordtype">id</span>);
<a name="l00956"></a>00956 
<a name="l00957"></a>00957     SDend(MOD02QKMfile_id);
<a name="l00958"></a>00958     SDend(MOD02HKMfile_id);
<a name="l00959"></a>00959     SDend(MOD021KMfile_id);
<a name="l00960"></a>00960     SDend(sd_id);
<a name="l00961"></a>00961 
<a name="l00962"></a>00962 
<a name="l00963"></a>00963     <span class="comment">/* ----- free memory ----- */</span>
<a name="l00964"></a>00964 
<a name="l00965"></a>00965     <span class="keywordflow">for</span> (ib = 0; ib &lt; <a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba8b602b8b0906ba2c4717e163f1478c8f">Nitems</a>; ib++) {
<a name="l00966"></a>00966         <span class="keywordflow">if</span> (sds[ib].fillvalue) free(sds[ib].fillvalue);
<a name="l00967"></a>00967         <span class="keywordflow">if</span> (sds[ib].data) free(sds[ib].data);
<a name="l00968"></a>00968     }
<a name="l00969"></a>00969 
<a name="l00970"></a>00970     free(height.<a class="code" href="struct_s_d_s.html#a735984d41155bc1032e09bece8f8d66d">data</a>);
<a name="l00971"></a>00971     free(mus);
<a name="l00972"></a>00972 
<a name="l00973"></a>00973     <span class="keywordflow">if</span> (!TOA) {
<a name="l00974"></a>00974         free(tOG);
<a name="l00975"></a>00975         free(TtotraytH2O);
<a name="l00976"></a>00976         free(sphalb);
<a name="l00977"></a>00977         free(rhoray);
<a name="l00978"></a>00978     }
<a name="l00979"></a>00979 
<a name="l00980"></a>00980     <span class="comment">/* not allocated if --sealevel specified */</span>
<a name="l00981"></a>00981     <span class="keywordflow">if</span> (dem.<a class="code" href="struct_s_d_s.html#a735984d41155bc1032e09bece8f8d66d">data</a>) free(dem.<a class="code" href="struct_s_d_s.html#a735984d41155bc1032e09bece8f8d66d">data</a>);
<a name="l00982"></a>00982 
<a name="l00983"></a>00983 
<a name="l00984"></a>00984     <span class="keywordflow">return</span> 0;
<a name="l00985"></a>00985 }
<a name="l00986"></a>00986 
<a name="l00987"></a>00987 
<a name="l00988"></a>00988 <span class="comment">/**************************************************************************/</span>
<a name="l00993"></a><a class="code" href="crefl_8c.html#ae8605e2b78cd4a81b6c6b5c30cb7366a">00993</a> <span class="keywordtype">void</span> <a class="code" href="crefl_8c.html#ae8605e2b78cd4a81b6c6b5c30cb7366a">usage</a>(<span class="keywordtype">void</span>)
<a name="l00994"></a>00994 {
<a name="l00995"></a>00995     fputs(<span class="stringliteral">&quot;Usage:\n&quot;</span>, stderr);
<a name="l00996"></a>00996     fputs(<span class="stringliteral">&quot;crefl [--verbose] [--1km|--500m] [--nearest] [--toa|--sealevel]\n&quot;</span>
<a name="l00997"></a>00997           <span class="stringliteral">&quot;      [--gzip] [--maxsolz=angle] [--range=min,max] [--overwrite|--append]\n&quot;</span>
<a name="l00998"></a>00998           <span class="stringliteral">&quot;      [--bands=&lt;band1,band2,band3,...&gt;] --of=&lt;output file&gt;\n&quot;</span>
<a name="l00999"></a>00999           <span class="stringliteral">&quot;      &lt;MOD021KM|MOD02CRS|MOD09CRS file&gt; [&lt;MOD02HKM file&gt;] [&lt;MOD02QKM file&gt;]\n&quot;</span>, stderr);
<a name="l01000"></a>01000 
<a name="l01001"></a>01001     fprintf(stderr, <span class="stringliteral">&quot;Version %s, compiled %s %s.\n&quot;</span>, <a class="code" href="crefl_8c.html#ae2ceec62d3c6999bcb8db8df4d44a6d0">PROCESS_VERSION_NUMBER</a>,
<a name="l01002"></a>01002             __DATE__, __TIME__);
<a name="l01003"></a>01003 }
<a name="l01004"></a>01004 
<a name="l01005"></a>01005 
<a name="l01006"></a>01006 <span class="comment">/**************************************************************************/</span>
<a name="l01014"></a><a class="code" href="crefl_8c.html#ace1410b6373bee65bb550f176eebb328">01014</a> <span class="keywordtype">int</span> <a class="code" href="crefl_8c.html#ace1410b6373bee65bb550f176eebb328">input_file_type</a>(<span class="keywordtype">char</span> *filename)
<a name="l01015"></a>01015 {
<a name="l01016"></a>01016     <span class="keywordtype">char</span> *ptr;
<a name="l01017"></a>01017     <span class="keywordtype">int</span> maxlen;
<a name="l01018"></a>01018 
<a name="l01019"></a>01019 
<a name="l01020"></a>01020     <span class="keywordflow">if</span> ( (ptr = strrchr(filename, <span class="charliteral">&#39;/&#39;</span>)) )
<a name="l01021"></a>01021         <span class="comment">/* move to first character after last forward slash */</span>
<a name="l01022"></a>01022         ptr++;
<a name="l01023"></a>01023     <span class="keywordflow">else</span>
<a name="l01024"></a>01024         <span class="comment">/* no slash in file name */</span>
<a name="l01025"></a>01025         ptr = filename;
<a name="l01026"></a>01026 
<a name="l01027"></a>01027 
<a name="l01028"></a>01028     <span class="comment">/* all prefixes we&#39;ll recognize have this length */</span>
<a name="l01029"></a>01029     maxlen = strlen(<span class="stringliteral">&quot;M?D0????.&quot;</span>);
<a name="l01030"></a>01030 
<a name="l01031"></a>01031     <span class="keywordflow">if</span> (strncmp(ptr, <span class="stringliteral">&quot;MOD021KM.&quot;</span>, maxlen) == 0) <span class="keywordflow">return</span> <a class="code" href="crefl_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a452c3898e38e3afd59ea4e5f301f93e4">INPUT_1KM</a>;
<a name="l01032"></a>01032     <span class="keywordflow">if</span> (strncmp(ptr, <span class="stringliteral">&quot;MYD021KM.&quot;</span>, maxlen) == 0) <span class="keywordflow">return</span> <a class="code" href="crefl_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a452c3898e38e3afd59ea4e5f301f93e4">INPUT_1KM</a>;
<a name="l01033"></a>01033 
<a name="l01034"></a>01034     <span class="keywordflow">if</span> (strncmp(ptr, <span class="stringliteral">&quot;MOD02HKM.&quot;</span>, maxlen) == 0) <span class="keywordflow">return</span> <a class="code" href="crefl_8c.html#adf764cbdea00d65edcd07bb9953ad2b7ac30114f16e63da819602bbff904da486">INPUT_500M</a>;
<a name="l01035"></a>01035     <span class="keywordflow">if</span> (strncmp(ptr, <span class="stringliteral">&quot;MYD02HKM.&quot;</span>, maxlen) == 0) <span class="keywordflow">return</span> <a class="code" href="crefl_8c.html#adf764cbdea00d65edcd07bb9953ad2b7ac30114f16e63da819602bbff904da486">INPUT_500M</a>;
<a name="l01036"></a>01036 
<a name="l01037"></a>01037     <span class="keywordflow">if</span> (strncmp(ptr, <span class="stringliteral">&quot;MOD02QKM.&quot;</span>, maxlen) == 0) <span class="keywordflow">return</span> <a class="code" href="crefl_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a471d277dddd138c78232bb6fef807a8e">INPUT_250M</a>;
<a name="l01038"></a>01038     <span class="keywordflow">if</span> (strncmp(ptr, <span class="stringliteral">&quot;MYD02QKM.&quot;</span>, maxlen) == 0) <span class="keywordflow">return</span> <a class="code" href="crefl_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a471d277dddd138c78232bb6fef807a8e">INPUT_250M</a>;
<a name="l01039"></a>01039 
<a name="l01040"></a>01040 
<a name="l01041"></a>01041     <span class="keywordflow">if</span> (strncmp(ptr, <span class="stringliteral">&quot;MOD02CRS.&quot;</span>, maxlen) == 0) <span class="keywordflow">return</span> <a class="code" href="crefl_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a452c3898e38e3afd59ea4e5f301f93e4">INPUT_1KM</a>;
<a name="l01042"></a>01042     <span class="keywordflow">if</span> (strncmp(ptr, <span class="stringliteral">&quot;MYD02CRS.&quot;</span>, maxlen) == 0) <span class="keywordflow">return</span> <a class="code" href="crefl_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a452c3898e38e3afd59ea4e5f301f93e4">INPUT_1KM</a>;
<a name="l01043"></a>01043     <span class="keywordflow">if</span> (strncmp(ptr, <span class="stringliteral">&quot;MOD09CRS.&quot;</span>, maxlen) == 0) <span class="keywordflow">return</span> <a class="code" href="crefl_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a452c3898e38e3afd59ea4e5f301f93e4">INPUT_1KM</a>;
<a name="l01044"></a>01044     <span class="keywordflow">if</span> (strncmp(ptr, <span class="stringliteral">&quot;MYD09CRS.&quot;</span>, maxlen) == 0) <span class="keywordflow">return</span> <a class="code" href="crefl_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a452c3898e38e3afd59ea4e5f301f93e4">INPUT_1KM</a>;
<a name="l01045"></a>01045 
<a name="l01046"></a>01046 
<a name="l01047"></a>01047     <span class="keywordflow">return</span> <a class="code" href="crefl_8c.html#adf764cbdea00d65edcd07bb9953ad2b7ab68b8c7682e25ef3e8811b477033ff71">INPUT_UNKNOWN</a>;
<a name="l01048"></a>01048 }
<a name="l01049"></a>01049 
<a name="l01050"></a>01050 
<a name="l01051"></a>01051 
<a name="l01052"></a>01052 <span class="comment">/**************************************************************************/</span>
<a name="l01062"></a><a class="code" href="crefl_8c.html#ac168e5666e1a7b5a0d8212db5d8ea2f2">01062</a> <span class="keywordtype">int</span> <a class="code" href="crefl_8c.html#ac168e5666e1a7b5a0d8212db5d8ea2f2">parse_bands</a>(<span class="keywordtype">char</span> *bandstr, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> process[<a class="code" href="crefl_8c.html#a4f9b6b07384112c4eb1ee3b543a08a62">Nbands</a>])
<a name="l01063"></a>01063 {
<a name="l01064"></a>01064     <span class="keywordtype">int</span> band, nb;
<a name="l01065"></a>01065     <span class="keywordtype">char</span> *ptr, *<a class="code" href="somfor_8c.html#ad62e712560f6344b96d4c080a2ba9c92">s</a>;
<a name="l01066"></a>01066 
<a name="l01067"></a>01067     nb = 0;
<a name="l01068"></a>01068     ptr = bandstr;
<a name="l01069"></a>01069     <span class="keywordflow">while</span> ( (s = strtok(ptr, <span class="stringliteral">&quot;,&quot;</span>)) ) {
<a name="l01070"></a>01070         band = atoi(s);
<a name="l01071"></a>01071 
<a name="l01072"></a>01072         <span class="keywordflow">if</span> ((band &gt; 0) &amp;&amp; (band &lt; Nbands))
<a name="l01073"></a>01073             process[band - 1] = <a class="code" href="gctp_8c.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01074"></a>01074         <span class="keywordflow">else</span>
<a name="l01075"></a>01075             <span class="keywordflow">return</span> -1;
<a name="l01076"></a>01076 
<a name="l01077"></a>01077         <span class="keywordflow">if</span> (++nb) ptr = (<span class="keywordtype">char</span> *) NULL;
<a name="l01078"></a>01078     }
<a name="l01079"></a>01079 
<a name="l01080"></a>01080     <span class="keywordflow">return</span> 0;
<a name="l01081"></a>01081 }
<a name="l01082"></a>01082 
<a name="l01083"></a>01083 <span class="comment">/**************************************************************************/</span>
<a name="l01096"></a><a class="code" href="crefl_8c.html#a6866fc1eecb97cefe4e1cc38c302f18a">01096</a> <span class="keywordtype">void</span> <a class="code" href="crefl_8c.html#a6866fc1eecb97cefe4e1cc38c302f18a">set_dimnames</a>(<span class="keywordtype">int</span> samples, <span class="keywordtype">char</span> **dimname1, <span class="keywordtype">char</span> **dimname2)
<a name="l01097"></a>01097 {
<a name="l01098"></a>01098     <span class="keywordflow">switch</span>(samples) {
<a name="l01099"></a>01099         <span class="keywordflow">case</span> <a class="code" href="crefl_8c.html#ac73cf6d49edeb864e94ba04a5917fa90">NUM1KMCOLPERSCAN</a>:
<a name="l01100"></a>01100             *dimname1 = <span class="stringliteral">&quot;lines_1km&quot;</span>;
<a name="l01101"></a>01101             *dimname2 = <span class="stringliteral">&quot;samples_1km&quot;</span>;
<a name="l01102"></a>01102             <span class="keywordflow">break</span>;
<a name="l01103"></a>01103 
<a name="l01104"></a>01104         <span class="keywordflow">case</span> 2708:
<a name="l01105"></a>01105             *dimname1 = <span class="stringliteral">&quot;lines_500m&quot;</span>;
<a name="l01106"></a>01106             *dimname2 = <span class="stringliteral">&quot;samples_500m&quot;</span>;
<a name="l01107"></a>01107             <span class="keywordflow">break</span>;
<a name="l01108"></a>01108 
<a name="l01109"></a>01109         <span class="keywordflow">case</span> 5416:
<a name="l01110"></a>01110             *dimname1 = <span class="stringliteral">&quot;lines_250m&quot;</span>;
<a name="l01111"></a>01111             *dimname2 = <span class="stringliteral">&quot;samples_250m&quot;</span>;
<a name="l01112"></a>01112             <span class="keywordflow">break</span>;
<a name="l01113"></a>01113 
<a name="l01114"></a>01114         <span class="keywordflow">default</span>:
<a name="l01115"></a>01115             *dimname1 = *dimname2 = (<span class="keywordtype">char</span> *) NULL;
<a name="l01116"></a>01116             <span class="keywordflow">break</span>;
<a name="l01117"></a>01117     }   
<a name="l01118"></a>01118 }
<a name="l01119"></a>01119 
<a name="l01120"></a>01120 
<a name="l01121"></a>01121 <span class="comment">/**************************************************************************/</span>
<a name="l01132"></a><a class="code" href="crefl_8c.html#a64cbe8c9b98670a4a456f0ff29fc3abe">01132</a> <span class="keywordtype">int</span> <a class="code" href="crefl_8c.html#a64cbe8c9b98670a4a456f0ff29fc3abe">interp_dem</a>(<span class="keywordtype">float</span> lat, <span class="keywordtype">float</span> lon, <a class="code" href="struct_s_d_s.html">SDS</a> *dem)
<a name="l01133"></a>01133 {
<a name="l01134"></a>01134     <span class="keywordtype">float</span> fractrow, fractcol, <a class="code" href="somfor_8c.html#a87accd1af8e0aff4b818d891374f7cec">t</a>, <a class="code" href="omerfor_8c.html#aed08c8478a62910aab06ba708a0e5b5f">u</a>;
<a name="l01135"></a>01135     <span class="keywordtype">int</span> demrow1, demcol1, demrow2, demcol2;
<a name="l01136"></a>01136     <span class="keywordtype">int</span> height11, height12, height21, height22;
<a name="l01137"></a>01137     <span class="keywordtype">int</span> height;
<a name="l01138"></a>01138 
<a name="l01139"></a>01139     fractrow = (90.0F - lat) * dem-&gt;<a class="code" href="struct_s_d_s.html#a5c6d246108e3d9140aa1d36727343589">Nl</a> / 180.0F;
<a name="l01140"></a>01140     demrow1 = (<span class="keywordtype">int</span>) floorf(fractrow);
<a name="l01141"></a>01141     demrow2 = demrow1 + 1;
<a name="l01142"></a>01142     <span class="keywordflow">if</span> (demrow1 &lt; 0) demrow1 = demrow2 + 1;
<a name="l01143"></a>01143     <span class="keywordflow">if</span> (demrow2 &gt; dem-&gt;<a class="code" href="struct_s_d_s.html#a5c6d246108e3d9140aa1d36727343589">Nl</a> - 1) demrow2 = demrow1 - 1;
<a name="l01144"></a>01144     t = (fractrow - demrow1) / (demrow2 - demrow1);
<a name="l01145"></a>01145 
<a name="l01146"></a>01146     fractcol = (lon + 180.0F) * dem-&gt;<a class="code" href="struct_s_d_s.html#a0ebeb3f80372d82ebedc44076e6b7809">Np</a> / 360.0F;
<a name="l01147"></a>01147     demcol1 = (<span class="keywordtype">int</span>) floorf(fractcol);
<a name="l01148"></a>01148     demcol2 = demcol1 + 1;
<a name="l01149"></a>01149     <span class="keywordflow">if</span> (demcol1 &lt; 0) demcol1 = demcol2 + 1;
<a name="l01150"></a>01150     <span class="keywordflow">if</span> (demcol2 &gt; dem-&gt;<a class="code" href="struct_s_d_s.html#a0ebeb3f80372d82ebedc44076e6b7809">Np</a> - 1) demcol2 = demcol1 - 1;
<a name="l01151"></a>01151     u = (fractcol - demcol1) / (demcol2 - demcol1);
<a name="l01152"></a>01152 
<a name="l01153"></a>01153     height11 = ((int16 *)dem-&gt;<a class="code" href="struct_s_d_s.html#a735984d41155bc1032e09bece8f8d66d">data</a>)[demrow1 * dem-&gt;<a class="code" href="struct_s_d_s.html#a0ebeb3f80372d82ebedc44076e6b7809">Np</a> + demcol1];
<a name="l01154"></a>01154     height12 = ((int16 *)dem-&gt;<a class="code" href="struct_s_d_s.html#a735984d41155bc1032e09bece8f8d66d">data</a>)[demrow1 * dem-&gt;<a class="code" href="struct_s_d_s.html#a0ebeb3f80372d82ebedc44076e6b7809">Np</a> + demcol2];
<a name="l01155"></a>01155     height21 = ((int16 *)dem-&gt;<a class="code" href="struct_s_d_s.html#a735984d41155bc1032e09bece8f8d66d">data</a>)[demrow2 * dem-&gt;<a class="code" href="struct_s_d_s.html#a0ebeb3f80372d82ebedc44076e6b7809">Np</a> + demcol1];
<a name="l01156"></a>01156     height22 = ((int16 *)dem-&gt;<a class="code" href="struct_s_d_s.html#a735984d41155bc1032e09bece8f8d66d">data</a>)[demrow2 * dem-&gt;<a class="code" href="struct_s_d_s.html#a0ebeb3f80372d82ebedc44076e6b7809">Np</a> + demcol2];
<a name="l01157"></a>01157     height = (int) (t * u * height22 + t * (1.0F - u) * height21 +
<a name="l01158"></a>01158                     (1.0F - <a class="code" href="somfor_8c.html#a87accd1af8e0aff4b818d891374f7cec">t</a>) * u * height12 + (1.0F - t) * (1.0F - <a class="code" href="omerfor_8c.html#aed08c8478a62910aab06ba708a0e5b5f">u</a>) * height11);
<a name="l01159"></a>01159 
<a name="l01160"></a>01160     <span class="keywordflow">if</span> (height &lt; 0) height = 0;
<a name="l01161"></a>01161     <span class="keywordflow">return</span> height;
<a name="l01162"></a>01162 }
<a name="l01163"></a>01163 
<a name="l01164"></a>01164 
<a name="l01165"></a>01165 
<a name="l01166"></a>01166 <span class="comment">/**************************************************************************/</span>
<a name="l01177"></a><a class="code" href="crefl_8c.html#a589b7cfecc8c4364dac950d290feaf78">01177</a> <span class="keywordtype">int</span> <a class="code" href="crefl_8c.html#a589b7cfecc8c4364dac950d290feaf78">write_scan</a>(<span class="keywordtype">int</span> iscan, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *process, <a class="code" href="struct_s_d_s.html">SDS</a> outsds[<a class="code" href="crefl_8c.html#a4f9b6b07384112c4eb1ee3b543a08a62">Nbands</a>])
<a name="l01178"></a>01178 {
<a name="l01179"></a>01179     <span class="keywordtype">int</span> ib;
<a name="l01180"></a>01180 
<a name="l01181"></a>01181     <span class="keywordflow">for</span> (ib = 0; ib &lt; <a class="code" href="crefl_8c.html#a4f9b6b07384112c4eb1ee3b543a08a62">Nbands</a>; ib++) {
<a name="l01182"></a>01182         <span class="keywordflow">if</span> (!process[ib]) <span class="keywordflow">continue</span>;
<a name="l01183"></a>01183 
<a name="l01184"></a>01184         outsds[ib].<a class="code" href="struct_s_d_s.html#af79d8d684d5badfef6d6a5e50c970c18">start</a>[0] = iscan * outsds[ib].<a class="code" href="struct_s_d_s.html#a94bb1507581010e63fe8f8d380a964dc">rowsperscan</a>;
<a name="l01185"></a>01185         <span class="keywordflow">if</span> (SDwritedata(outsds[ib].<span class="keywordtype">id</span>, outsds[ib].<a class="code" href="somfor_8c.html#a45314566a84a31f43e6435d1eb24d4ec">start</a>, NULL,
<a name="l01186"></a>01186                         outsds[ib].edges, outsds[ib].data) == -1) <span class="keywordflow">return</span> 1;
<a name="l01187"></a>01187     }
<a name="l01188"></a>01188 
<a name="l01189"></a>01189     <span class="keywordflow">return</span> 0;
<a name="l01190"></a>01190 }
<a name="l01191"></a>01191 
<a name="l01192"></a>01192 
<a name="l01193"></a>01193 <span class="comment">/**************************************************************************/</span>
<a name="l01205"></a><a class="code" href="crefl_8c.html#a643f58417a2090718c068e57aade5fec">01205</a> <span class="keywordtype">int</span> <a class="code" href="crefl_8c.html#a643f58417a2090718c068e57aade5fec">read_scan</a>(<span class="keywordtype">int</span> iscan, <a class="code" href="struct_s_d_s.html">SDS</a> sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba8b602b8b0906ba2c4717e163f1478c8f">Nitems</a>])
<a name="l01206"></a>01206 {
<a name="l01207"></a>01207     <span class="keywordtype">int</span> ib;
<a name="l01208"></a>01208 
<a name="l01209"></a>01209     <span class="keywordflow">for</span> (ib = 0; ib &lt; <a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba8b602b8b0906ba2c4717e163f1478c8f">Nitems</a>; ib++) {
<a name="l01210"></a>01210         <span class="keywordflow">if</span> (sds[ib].<span class="keywordtype">id</span> == -1) <span class="keywordflow">continue</span>;
<a name="l01211"></a>01211 
<a name="l01212"></a>01212         <span class="keywordflow">switch</span> (sds[ib].rank) {
<a name="l01213"></a>01213             <span class="keywordflow">case</span> 2: sds[ib].<a class="code" href="struct_s_d_s.html#af79d8d684d5badfef6d6a5e50c970c18">start</a>[0] = iscan * sds[ib].<a class="code" href="struct_s_d_s.html#a94bb1507581010e63fe8f8d380a964dc">rowsperscan</a>; <span class="keywordflow">break</span>;
<a name="l01214"></a>01214             <span class="keywordflow">case</span> 3: sds[ib].<a class="code" href="struct_s_d_s.html#af79d8d684d5badfef6d6a5e50c970c18">start</a>[1] = iscan * sds[ib].<a class="code" href="struct_s_d_s.html#a94bb1507581010e63fe8f8d380a964dc">rowsperscan</a>; <span class="keywordflow">break</span>;
<a name="l01215"></a>01215         }
<a name="l01216"></a>01216 
<a name="l01217"></a>01217         <span class="keywordflow">if</span> (SDreaddata(sds[ib].<span class="keywordtype">id</span>, sds[ib].<a class="code" href="somfor_8c.html#a45314566a84a31f43e6435d1eb24d4ec">start</a>, NULL, sds[ib].edges,
<a name="l01218"></a>01218                        sds[ib].data) == -1) {
<a name="l01219"></a>01219                            fprintf(stderr, <span class="stringliteral">&quot;  Can&#39;t read scan %d of SDS \&quot;%s\&quot;\n&quot;</span>, iscan, sds[ib].name);
<a name="l01220"></a>01220                            <span class="keywordflow">return</span> 1;
<a name="l01221"></a>01221                        }
<a name="l01222"></a>01222     }
<a name="l01223"></a>01223 
<a name="l01224"></a>01224     <span class="keywordflow">return</span> 0;
<a name="l01225"></a>01225 }
<a name="l01226"></a>01226 
<a name="l01227"></a>01227 <span class="comment">/**************************************************************************/</span>
<a name="l01234"></a><a class="code" href="crefl_8c.html#ab9705155ea4f0c46072efc3aa00b5dee">01234</a> <span class="keywordtype">float</span> <a class="code" href="crefl_8c.html#ab9705155ea4f0c46072efc3aa00b5dee">csalbr</a>(<span class="keywordtype">float</span> tau)
<a name="l01235"></a>01235 {
<a name="l01236"></a>01236     <span class="keywordflow">return</span> (3.0F * tau - <a class="code" href="crefl_8c.html#ac95fa41b280daf374c11feb460974857">fintexp3</a>(tau) * (4.0F + 2.0F * tau) + 2.0 * expf(-tau)) / (4.0F + 3.0F * tau);
<a name="l01237"></a>01237 }
<a name="l01238"></a>01238 
<a name="l01239"></a>01239 
<a name="l01240"></a>01240 <span class="comment">/**************************************************************************/</span>
<a name="l01245"></a><a class="code" href="crefl_8c.html#a01e2f31f276b24f9ee12213c491f5a0a">01245</a> <span class="keywordtype">double</span> <a class="code" href="crefl_8c.html#a01e2f31f276b24f9ee12213c491f5a0a">fintexp1</a>(<span class="keywordtype">float</span> tau)
<a name="l01246"></a>01246 {
<a name="l01247"></a>01247     <span class="keywordtype">double</span> xx, xftau;
<a name="l01248"></a>01248     <span class="keywordtype">int</span> i;
<a name="l01249"></a>01249     <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="somfor_8c.html#a1031d0e0a97a340abfe0a6ab9e831045">a</a>[6] = {-.57721566, 0.99999193,-0.24991055,
<a name="l01250"></a>01250         0.05519968,-0.00976004, 0.00107857};
<a name="l01251"></a>01251     xx = a[0];
<a name="l01252"></a>01252     xftau = 1.0;
<a name="l01253"></a>01253     <span class="keywordflow">for</span> (i=1; i&lt;6; i++) {
<a name="l01254"></a>01254         xftau *= tau;
<a name="l01255"></a>01255         xx += a[i] * xftau;
<a name="l01256"></a>01256     }
<a name="l01257"></a>01257 
<a name="l01258"></a>01258     <span class="keywordflow">return</span> xx - log(tau);
<a name="l01259"></a>01259 }
<a name="l01260"></a>01260 
<a name="l01261"></a>01261 
<a name="l01262"></a>01262 <span class="comment">/**************************************************************************/</span>
<a name="l01270"></a><a class="code" href="crefl_8c.html#ac95fa41b280daf374c11feb460974857">01270</a> <span class="keywordtype">double</span> <a class="code" href="crefl_8c.html#ac95fa41b280daf374c11feb460974857">fintexp3</a>(<span class="keywordtype">float</span> tau)
<a name="l01271"></a>01271 {
<a name="l01272"></a>01272     <span class="keywordflow">return</span> (expf(-tau) * (1.0F - tau) + tau * tau * <a class="code" href="crefl_8c.html#a01e2f31f276b24f9ee12213c491f5a0a">fintexp1</a>(tau)) / 2.0;
<a name="l01273"></a>01273 }
<a name="l01274"></a>01274 
<a name="l01275"></a>01275 
<a name="l01276"></a>01276 <span class="comment">/**************************************************************************/</span>
<a name="l01292"></a><a class="code" href="crefl_8c.html#abbfcb540f5fce9793ba5dba5999c2faa">01292</a> <span class="keywordtype">void</span> <a class="code" href="crefl_8c.html#abbfcb540f5fce9793ba5dba5999c2faa">chand</a>(<span class="keywordtype">float</span> phi,
<a name="l01293"></a>01293            <span class="keywordtype">float</span> muv,
<a name="l01294"></a>01294            <span class="keywordtype">float</span> mus,
<a name="l01295"></a>01295            <span class="keywordtype">float</span> *taur,
<a name="l01296"></a>01296            <span class="keywordtype">float</span> *rhoray,
<a name="l01297"></a>01297            <span class="keywordtype">float</span> *trup,
<a name="l01298"></a>01298            <span class="keywordtype">float</span> *trdown,
<a name="l01299"></a>01299            <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *process)
<a name="l01300"></a>01300 {
<a name="l01301"></a>01301 
<a name="l01302"></a>01302     <span class="keyword">const</span> <span class="keywordtype">double</span> xfd = 0.958725775;
<a name="l01303"></a>01303     <span class="keyword">const</span> <span class="keywordtype">float</span> xbeta2 = 0.5F;
<a name="l01304"></a>01304     <span class="keywordtype">float</span> pl[5];
<a name="l01305"></a>01305     <span class="keywordtype">double</span> fs01, fs02, fs0, fs1,fs2;
<a name="l01306"></a>01306     <span class="keyword">const</span> <span class="keywordtype">float</span> as0[10] = {0.33243832F, 0.16285370F, -0.30924818F, -0.10324388F,
<a name="l01307"></a>01307         0.11493334F, -6.777104e-02F, 1.577425e-03F, -1.240906e-02F,
<a name="l01308"></a>01308         3.241678e-02F, -3.503695e-02F};
<a name="l01309"></a>01309     <span class="keyword">const</span> <span class="keywordtype">float</span> as1[2] = {0.19666292F, -5.439061e-02F};
<a name="l01310"></a>01310     <span class="keyword">const</span> <span class="keywordtype">float</span> as2[2] = {0.14545937F,-2.910845e-02F};
<a name="l01311"></a>01311     <span class="keywordtype">float</span> phios, xcos1, xcos2, xcos3;
<a name="l01312"></a>01312     <span class="keywordtype">float</span> xph1, xph2, xph3, xitm1, xitm2;
<a name="l01313"></a>01313     <span class="keywordtype">float</span> xlntaur, xitot1, xitot2, xitot3;
<a name="l01314"></a>01314     <span class="keywordtype">int</span> i,ib;
<a name="l01315"></a>01315 
<a name="l01316"></a>01316     phios = phi + 180.0F;
<a name="l01317"></a>01317     xcos1 = 1.0F;
<a name="l01318"></a>01318     xcos2 = cos(phios * <a class="code" href="crefl_8c.html#af7e8592d0a634bd3642e9fd508ea8022">DEG2RAD</a>);
<a name="l01319"></a>01319     xcos3 = cos(2.0 * phios * DEG2RAD);
<a name="l01320"></a>01320     xph1 = 1.0 + (3.0F * mus * mus - 1.0F) * (3.0F * muv * muv - 1.0F) * xfd / 8.0;
<a name="l01321"></a>01321     xph2 = - xfd * xbeta2 * 1.5 * mus * muv * sqrtf(1.0F - mus * mus) * sqrtf(1.0F - muv * muv);
<a name="l01322"></a>01322     xph3 =   xfd * xbeta2 * 0.375 * (1.0F - mus * mus) * (1.0F - muv * muv);
<a name="l01323"></a>01323 
<a name="l01324"></a>01324     pl[0] = 1.0F;
<a name="l01325"></a>01325     pl[1] = mus + muv;
<a name="l01326"></a>01326     pl[2] = mus * muv;
<a name="l01327"></a>01327     pl[3] = mus * mus + muv * muv;
<a name="l01328"></a>01328     pl[4] = mus * mus * muv * muv;
<a name="l01329"></a>01329 
<a name="l01330"></a>01330     fs01 = fs02 = 0.0;
<a name="l01331"></a>01331     <span class="keywordflow">for</span> (i = 0; i &lt; 5; i++) {
<a name="l01332"></a>01332         fs01 += (double) (pl[i] * as0[i]);
<a name="l01333"></a>01333         fs02 += (double) (pl[i] * as0[5 + i]);
<a name="l01334"></a>01334     }
<a name="l01335"></a>01335 
<a name="l01336"></a>01336     <span class="keywordflow">for</span> (ib = 0; ib &lt; <a class="code" href="crefl_8c.html#a4f9b6b07384112c4eb1ee3b543a08a62">Nbands</a>; ib++) {
<a name="l01337"></a>01337         <span class="keywordflow">if</span> (process[ib]) {
<a name="l01338"></a>01338             xlntaur = logf(taur[ib]);
<a name="l01339"></a>01339             fs0 = fs01 + fs02 * xlntaur;
<a name="l01340"></a>01340             fs1 = as1[0] + xlntaur * as1[1];
<a name="l01341"></a>01341             fs2 = as2[0] + xlntaur * as2[1];
<a name="l01342"></a>01342             trdown[ib] = expf(-taur[ib]/mus);
<a name="l01343"></a>01343             trup[ib]   = expf(-taur[ib]/muv);
<a name="l01344"></a>01344             xitm1 = (1.0F - trdown[ib] * trup[ib]) / 4.0F / (mus + muv);
<a name="l01345"></a>01345             xitm2 = (1.0F - trdown[ib]) * (1.0F - trup[ib]);
<a name="l01346"></a>01346             xitot1 = xph1 * (xitm1 + xitm2 * fs0);
<a name="l01347"></a>01347             xitot2 = xph2 * (xitm1 + xitm2 * fs1);
<a name="l01348"></a>01348             xitot3 = xph3 * (xitm1 + xitm2 * fs2);
<a name="l01349"></a>01349             rhoray[ib] = xitot1 * xcos1 + xitot2 * xcos2 * 2.0F + xitot3 * xcos3 * 2.0F;
<a name="l01350"></a>01350         }
<a name="l01351"></a>01351     }
<a name="l01352"></a>01352 
<a name="l01353"></a>01353 }
<a name="l01354"></a>01354 
<a name="l01355"></a>01355 <span class="comment">/**************************************************************************/</span>
<a name="l01370"></a><a class="code" href="crefl_8c.html#a27b2413ebdde89ebd0754edb8876f760">01370</a> <span class="keywordtype">int</span> <a class="code" href="crefl_8c.html#a27b2413ebdde89ebd0754edb8876f760">getatmvariables</a>(<span class="keywordtype">float</span> mus,
<a name="l01371"></a>01371                     <span class="keywordtype">float</span> muv,
<a name="l01372"></a>01372                     <span class="keywordtype">float</span> phi,
<a name="l01373"></a>01373                     int16 height,
<a name="l01374"></a>01374                     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *process,
<a name="l01375"></a>01375                     <span class="keywordtype">float</span> *sphalb,
<a name="l01376"></a>01376                     <span class="keywordtype">float</span> *rhoray,
<a name="l01377"></a>01377                     <span class="keywordtype">float</span> *TtotraytH2O,
<a name="l01378"></a>01378                     <span class="keywordtype">float</span> *tOG)
<a name="l01379"></a>01379 {
<a name="l01380"></a>01380     <span class="keywordtype">double</span> m, Ttotrayu, Ttotrayd, tO3, tO2, tH2O;
<a name="l01381"></a>01381     <span class="keywordtype">float</span> psurfratio;
<a name="l01382"></a>01382     <span class="keywordtype">int</span> j, ib;
<a name="l01383"></a>01383     <span class="comment">/*</span>
<a name="l01384"></a>01384 <span class="comment">     Values for bands 9-16 below provided by B Murch and C Hu Univ South Florida</span>
<a name="l01385"></a>01385 <span class="comment">     IMaRS, obtained from SEADAS.</span>
<a name="l01386"></a>01386 <span class="comment">     For the moment I&#39;ve retained the Jacques values for 1-8 but show the differing</span>
<a name="l01387"></a>01387 <span class="comment">     SEADAS values in the commented out line.</span>
<a name="l01388"></a>01388 <span class="comment">     */</span>
<a name="l01389"></a>01389     <span class="keyword">const</span> <span class="keywordtype">float</span> aH2O[<a class="code" href="crefl_8c.html#a4f9b6b07384112c4eb1ee3b543a08a62">Nbands</a>]={ -5.60723, -5.25251, 0, 0, -6.29824, -7.70944, -3.91877, 0, 0, 0, 0, 0, 0, 0, 0, 0 };
<a name="l01390"></a>01390     <span class="keyword">const</span> <span class="keywordtype">float</span> bH2O[<a class="code" href="crefl_8c.html#a4f9b6b07384112c4eb1ee3b543a08a62">Nbands</a>]={ 0.820175, 0.725159, 0, 0, 0.865732, 0.966947, 0.745342, 0, 0, 0, 0, 0, 0, 0, 0, 0 };
<a name="l01391"></a>01391     <span class="comment">/*const float aO3[Nbands]={ 0.0711,    0.00313, 0.0104,     0.0930,   0, 0, 0, 0.00244, 0.00383, 0.0225, 0.0663, 0.0836, 0.0485, 0.0395, 0.0119, 0.00263};*/</span>
<a name="l01392"></a>01392     <span class="keyword">const</span> <span class="keywordtype">float</span> aO3[<a class="code" href="crefl_8c.html#a4f9b6b07384112c4eb1ee3b543a08a62">Nbands</a>]={ 0.0715289, 0,       0.00743232, 0.089691, 0, 0, 0, 0.001,   0.00383, 0.0225, 0.0663, 0.0836, 0.0485, 0.0395, 0.0119, 0.00263};
<a name="l01393"></a>01393     <span class="comment">/*const float taur0[Nbands] = { 0.0507,  0.0164,  0.1915,  0.0948,  0.0036,  0.0012,  0.0004,  0.3109, 0.2375, 0.1596, 0.1131, 0.0994, 0.0446, 0.0416, 0.0286, 0.0155};*/</span>
<a name="l01394"></a>01394     <span class="keyword">const</span> <span class="keywordtype">float</span> taur0[<a class="code" href="crefl_8c.html#a4f9b6b07384112c4eb1ee3b543a08a62">Nbands</a>] = { 0.05100, 0.01631, 0.19325, 0.09536, 0.00366, 0.00123, 0.00043, 0.3139, 0.2375, 0.1596, 0.1131, 0.0994, 0.0446, 0.0416, 0.0286, 0.0155};
<a name="l01395"></a>01395 
<a name="l01396"></a>01396     <span class="keywordtype">float</span> taur[<a class="code" href="crefl_8c.html#a4f9b6b07384112c4eb1ee3b543a08a62">Nbands</a>], trup[<a class="code" href="crefl_8c.html#a4f9b6b07384112c4eb1ee3b543a08a62">Nbands</a>], trdown[<a class="code" href="crefl_8c.html#a4f9b6b07384112c4eb1ee3b543a08a62">Nbands</a>];
<a name="l01397"></a>01397     <span class="keyword">static</span> <span class="keywordtype">float</span> sphalb0[<a class="code" href="crefl_8c.html#af6a2d2bec94fbd9fdb4cd1d2819e0c98">MAXNUMSPHALBVALUES</a>];
<a name="l01398"></a>01398     <span class="keyword">static</span> <span class="keywordtype">char</span> first_time = <a class="code" href="gctp_8c.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01399"></a>01399 
<a name="l01400"></a>01400 
<a name="l01401"></a>01401     <span class="keywordflow">if</span> (first_time) {
<a name="l01402"></a>01402         sphalb0[0] = 0.0F;
<a name="l01403"></a>01403         <span class="keywordflow">for</span>(j = 1; j &lt; <a class="code" href="crefl_8c.html#af6a2d2bec94fbd9fdb4cd1d2819e0c98">MAXNUMSPHALBVALUES</a>; j++)
<a name="l01404"></a>01404             sphalb0[j] = <a class="code" href="crefl_8c.html#ab9705155ea4f0c46072efc3aa00b5dee">csalbr</a>(j * <a class="code" href="crefl_8c.html#a5a1be37d2274dad16693d290ece9c4b3">TAUSTEP4SPHALB</a>);
<a name="l01405"></a>01405         first_time = <a class="code" href="gctp_8c.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01406"></a>01406     }
<a name="l01407"></a>01407 
<a name="l01408"></a>01408     m = 1.0 / mus + 1.0 / muv;
<a name="l01409"></a>01409     <span class="keywordflow">if</span> (m &gt; <a class="code" href="crefl_8c.html#aee905362b059f0c9d4466977c7a3407a">MAXAIRMASS</a>) <span class="keywordflow">return</span> -1;
<a name="l01410"></a>01410 
<a name="l01411"></a>01411     psurfratio = expf(-height / (<span class="keywordtype">float</span>) <a class="code" href="crefl_8c.html#a551b147394989bc98f19d35ce3a14717">SCALEHEIGHT</a>);
<a name="l01412"></a>01412     <span class="keywordflow">for</span> (ib = 0; ib &lt; <a class="code" href="crefl_8c.html#a4f9b6b07384112c4eb1ee3b543a08a62">Nbands</a>; ib++)
<a name="l01413"></a>01413         <span class="keywordflow">if</span> (process[ib]) taur[ib] = taur0[ib] * psurfratio;
<a name="l01414"></a>01414 
<a name="l01415"></a>01415     <a class="code" href="crefl_8c.html#abbfcb540f5fce9793ba5dba5999c2faa">chand</a>(phi, muv, mus, taur, rhoray, trup, trdown, process);
<a name="l01416"></a>01416 
<a name="l01417"></a>01417     <span class="keywordflow">for</span> (ib = 0; ib &lt; <a class="code" href="crefl_8c.html#a4f9b6b07384112c4eb1ee3b543a08a62">Nbands</a>; ib++) {
<a name="l01418"></a>01418         <span class="keywordflow">if</span> (!process[ib]) <span class="keywordflow">continue</span>;
<a name="l01419"></a>01419 
<a name="l01420"></a>01420         <span class="keywordflow">if</span> (taur[ib] / <a class="code" href="crefl_8c.html#a5a1be37d2274dad16693d290ece9c4b3">TAUSTEP4SPHALB</a> &gt;= <a class="code" href="crefl_8c.html#af6a2d2bec94fbd9fdb4cd1d2819e0c98">MAXNUMSPHALBVALUES</a>) {
<a name="l01421"></a>01421             sphalb[ib] = -1.0F;
<a name="l01422"></a>01422             <span class="comment">/* Use sphalb as flag to indicate atm variables are not computed successfully */</span>
<a name="l01423"></a>01423             <span class="keywordflow">continue</span>;
<a name="l01424"></a>01424         }
<a name="l01425"></a>01425 
<a name="l01426"></a>01426         sphalb[ib] = sphalb0[(int)(taur[ib] / <a class="code" href="crefl_8c.html#a5a1be37d2274dad16693d290ece9c4b3">TAUSTEP4SPHALB</a> + 0.5)];
<a name="l01427"></a>01427         Ttotrayu = ((2 / 3. + muv) + (2 / 3. - muv) * trup[ib])   / (4 / 3. + taur[ib]);
<a name="l01428"></a>01428         Ttotrayd = ((2 / 3. + mus) + (2 / 3. - mus) * trdown[ib]) / (4 / 3. + taur[ib]);
<a name="l01429"></a>01429         tO3 = tO2 = tH2O = 1.0;
<a name="l01430"></a>01430         <span class="keywordflow">if</span> (aO3[ib] != 0) tO3 = exp(-m * <a class="code" href="crefl_8c.html#a9f68c2ad43642fe98df91b43835d6f2e">UO3</a> * aO3[ib]);
<a name="l01431"></a>01431         <span class="keywordflow">if</span> (bH2O[ib] != 0) tH2O = exp(-exp(aH2O[ib] + bH2O[ib] * log(m * <a class="code" href="crefl_8c.html#abde039e8a3c3c7b0b6fc9764cc901470">UH2O</a>)));
<a name="l01432"></a>01432         <span class="comment">/*</span>
<a name="l01433"></a>01433 <span class="comment">         t02 = exp(-m * aO2);</span>
<a name="l01434"></a>01434 <span class="comment">         */</span>
<a name="l01435"></a>01435         TtotraytH2O[ib] = Ttotrayu * Ttotrayd * tH2O;
<a name="l01436"></a>01436         tOG[ib] = tO3 * tO2;
<a name="l01437"></a>01437     }
<a name="l01438"></a>01438 
<a name="l01439"></a>01439     <span class="keywordflow">return</span> 0;
<a name="l01440"></a>01440 
<a name="l01441"></a>01441 }
<a name="l01442"></a>01442 
<a name="l01443"></a>01443 
<a name="l01444"></a>01444 <span class="comment">/**************************************************************************/</span>
<a name="l01456"></a><a class="code" href="crefl_8c.html#aced7c98f03682fc136412cfea6a13d10">01456</a> <span class="keywordtype">float</span> <a class="code" href="crefl_8c.html#aced7c98f03682fc136412cfea6a13d10">correctedrefl</a>(<span class="keywordtype">float</span> refl,
<a name="l01457"></a>01457                     <span class="keywordtype">float</span> TtotraytH2O,
<a name="l01458"></a>01458                     <span class="keywordtype">float</span> tOG,
<a name="l01459"></a>01459                     <span class="keywordtype">float</span> rhoray,
<a name="l01460"></a>01460                     <span class="keywordtype">float</span> sphalb)
<a name="l01461"></a>01461 {
<a name="l01462"></a>01462     <span class="keywordtype">float</span> corr_refl;
<a name="l01463"></a>01463 
<a name="l01464"></a>01464     corr_refl = (refl / tOG - rhoray) / TtotraytH2O;
<a name="l01465"></a>01465     corr_refl /= (1.0F + corr_refl * sphalb);
<a name="l01466"></a>01466     <span class="keywordflow">return</span> corr_refl;
<a name="l01467"></a>01467 }
<a name="l01468"></a>01468 
<a name="l01469"></a>01469 <span class="comment">/**************************************************************************/</span>
<a name="l01483"></a><a class="code" href="crefl_8c.html#a0d5302aebefded49b66860d05d1724e5">01483</a> <span class="keywordtype">int</span> <a class="code" href="crefl_8c.html#a0d5302aebefded49b66860d05d1724e5">init_output_sds</a>(int32 sd_id,
<a name="l01484"></a>01484                     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *process,
<a name="l01485"></a>01485                     <a class="code" href="struct_s_d_s.html">SDS</a> outsds[<a class="code" href="crefl_8c.html#a4f9b6b07384112c4eb1ee3b543a08a62">Nbands</a>],
<a name="l01486"></a>01486                     <a class="code" href="struct_s_d_s.html">SDS</a> sds[<a class="code" href="crefl_8c.html#a06fc87d81c62e9abb8790b6e5713c55ba8b602b8b0906ba2c4717e163f1478c8f">Nitems</a>],
<a name="l01487"></a>01487                     <span class="keywordtype">int</span> gzip,
<a name="l01488"></a>01488                     <span class="keywordtype">int</span> verbose)
<a name="l01489"></a>01489 {
<a name="l01490"></a>01490     <span class="keywordtype">int</span> ib;
<a name="l01491"></a>01491     int32 dim_id;
<a name="l01492"></a>01492     <span class="keywordtype">char</span> *dimname1, *dimname2;
<a name="l01493"></a>01493 
<a name="l01494"></a>01494     HDF_CHUNK_DEF chunk_def;
<a name="l01495"></a>01495 
<a name="l01496"></a>01496 
<a name="l01497"></a>01497     <span class="comment">/* same fill value will be used for all output SDSs */</span>
<a name="l01498"></a>01498     <span class="keyword">static</span> int16 fillvalue = <a class="code" href="crefl_8c.html#a9f4ec3e2b6961eb728a0972dd558076c">FILL_INT16</a>;
<a name="l01499"></a>01499 
<a name="l01500"></a>01500     <span class="comment">/* band naming convention will be &quot;CorrRefl_XX&quot;</span>
<a name="l01501"></a>01501 <span class="comment">     (11 characters + terminating null) */</span>
<a name="l01502"></a>01502     <span class="keywordtype">char</span> name[16];
<a name="l01503"></a>01503 
<a name="l01504"></a>01504 
<a name="l01505"></a>01505     <span class="comment">/* write SDS-specific attributes and dimension names */</span>
<a name="l01506"></a>01506     <span class="keywordflow">for</span> (ib = 0; ib &lt; <a class="code" href="crefl_8c.html#a4f9b6b07384112c4eb1ee3b543a08a62">Nbands</a>; ib++) {
<a name="l01507"></a>01507         <span class="keywordflow">if</span> (!process[ib]) <span class="keywordflow">continue</span>;
<a name="l01508"></a>01508 
<a name="l01509"></a>01509         outsds[ib].<a class="code" href="struct_s_d_s.html#a0e5f7647ec94a04f8e306e7a5db2facd">num_type</a> = DFNT_INT16;
<a name="l01510"></a>01510         outsds[ib].<a class="code" href="struct_s_d_s.html#a807c87944de39fa4f4f27272ce63cd14">factor</a> = 0.0001;
<a name="l01511"></a>01511         outsds[ib].<a class="code" href="struct_s_d_s.html#aa24cece8b1c8bcc4268ed11c89fcda91">offset</a> = 0;
<a name="l01512"></a>01512         outsds[ib].<a class="code" href="struct_s_d_s.html#a06c075abcc246ce8cb3a327f90002328">rank</a> = 2;
<a name="l01513"></a>01513 
<a name="l01514"></a>01514         sprintf(name, <span class="stringliteral">&quot;CorrRefl_%2.2d&quot;</span>, ib + 1);
<a name="l01515"></a>01515         <span class="keywordflow">if</span> ( !(outsds[ib].name = strdup(name)) ) <span class="keywordflow">return</span> 1;
<a name="l01516"></a>01516 
<a name="l01517"></a>01517         outsds[ib].<a class="code" href="struct_s_d_s.html#a5c6d246108e3d9140aa1d36727343589">Nl</a> = outsds[ib].<a class="code" href="struct_s_d_s.html#a6adc2e571f8eea012d219d86ef529e3f">dim_sizes</a>[0] = sds[ib].<a class="code" href="struct_s_d_s.html#a5c6d246108e3d9140aa1d36727343589">Nl</a>;
<a name="l01518"></a>01518         outsds[ib].<a class="code" href="struct_s_d_s.html#a0ebeb3f80372d82ebedc44076e6b7809">Np</a> = outsds[ib].<a class="code" href="struct_s_d_s.html#a6adc2e571f8eea012d219d86ef529e3f">dim_sizes</a>[1] = sds[ib].<a class="code" href="struct_s_d_s.html#a0ebeb3f80372d82ebedc44076e6b7809">Np</a>;
<a name="l01519"></a>01519         outsds[ib].<a class="code" href="struct_s_d_s.html#a94bb1507581010e63fe8f8d380a964dc">rowsperscan</a> = sds[ib].<a class="code" href="struct_s_d_s.html#a94bb1507581010e63fe8f8d380a964dc">rowsperscan</a>;
<a name="l01520"></a>01520         <span class="keywordflow">if</span> (verbose)
<a name="l01521"></a>01521             printf(<span class="stringliteral">&quot;Creating SDS %s: %dx%d\n&quot;</span>, outsds[ib].name,
<a name="l01522"></a>01522                    outsds[ib].Np, outsds[ib].Nl);
<a name="l01523"></a>01523         <span class="keywordflow">if</span> ((outsds[ib].<span class="keywordtype">id</span> = SDcreate(sd_id, outsds[ib].name, outsds[ib].num_type, outsds[ib].rank,
<a name="l01524"></a>01524                                       outsds[ib].dim_sizes)) == -1) {
<a name="l01525"></a>01525                                           fprintf(stderr, <span class="stringliteral">&quot;Cannot create SDS %s\n&quot;</span>, outsds[ib].name);
<a name="l01526"></a>01526                                           <span class="keywordflow">return</span> 1;
<a name="l01527"></a>01527                                       }
<a name="l01528"></a>01528 
<a name="l01529"></a>01529         outsds[ib].<a class="code" href="struct_s_d_s.html#ac5abb67b2d2204c1dba5fd732876b853">fillvalue</a> = &amp;fillvalue;
<a name="l01530"></a>01530         <span class="keywordflow">if</span> ( SDsetfillvalue(outsds[ib].<span class="keywordtype">id</span>, outsds[ib].fillvalue) ) {
<a name="l01531"></a>01531             fprintf(stderr, <span class="stringliteral">&quot;Cannot write fill value of SDS %s\n&quot;</span>, outsds[ib].name);
<a name="l01532"></a>01532             <span class="keywordflow">return</span> 1;
<a name="l01533"></a>01533         }
<a name="l01534"></a>01534         <span class="keywordflow">if</span> ( SDsetattr(outsds[ib].<span class="keywordtype">id</span>, <span class="stringliteral">&quot;scale_factor&quot;</span>, DFNT_FLOAT64, 1, &amp;outsds[ib].factor) == -1  ||
<a name="l01535"></a>01535             SDsetattr(outsds[ib].<span class="keywordtype">id</span>, <span class="stringliteral">&quot;add_offset&quot;</span>,   DFNT_FLOAT64, 1, &amp;outsds[ib].offset) == -1 ) {
<a name="l01536"></a>01536                 fprintf(stderr, <span class="stringliteral">&quot;Cannot write scale factor and offset of SDS \&quot;%s\&quot;\n&quot;</span>,  outsds[ib].name);
<a name="l01537"></a>01537                 <span class="keywordflow">return</span> 1;
<a name="l01538"></a>01538             }
<a name="l01539"></a>01539         <span class="keywordflow">if</span> ( SDsetattr(outsds[ib].<span class="keywordtype">id</span>, <span class="stringliteral">&quot;units&quot;</span>, DFNT_CHAR8, 4, <span class="stringliteral">&quot;none&quot;</span>) == -1 ) {
<a name="l01540"></a>01540             fprintf(stderr, <span class="stringliteral">&quot;Cannot write units attribute of SDS \&quot;%s\&quot;\n&quot;</span>,  outsds[ib].name);
<a name="l01541"></a>01541             <span class="keywordflow">return</span> 1;
<a name="l01542"></a>01542         }
<a name="l01543"></a>01543 
<a name="l01544"></a>01544         <span class="comment">/* set dimensions */</span>
<a name="l01545"></a>01545         outsds[ib].<a class="code" href="struct_s_d_s.html#af79d8d684d5badfef6d6a5e50c970c18">start</a>[1] = 0;
<a name="l01546"></a>01546         outsds[ib].<a class="code" href="struct_s_d_s.html#ae4e2e1f4bcbc4bee7383f9bfb0c7efe4">edges</a>[0] = outsds[ib].<a class="code" href="struct_s_d_s.html#a94bb1507581010e63fe8f8d380a964dc">rowsperscan</a>;
<a name="l01547"></a>01547         outsds[ib].<a class="code" href="struct_s_d_s.html#ae4e2e1f4bcbc4bee7383f9bfb0c7efe4">edges</a>[1] = outsds[ib].<a class="code" href="struct_s_d_s.html#a0ebeb3f80372d82ebedc44076e6b7809">Np</a>;
<a name="l01548"></a>01548 
<a name="l01549"></a>01549         <span class="comment">/* allocate memory for band output data */</span>
<a name="l01550"></a>01550         outsds[ib].<a class="code" href="struct_s_d_s.html#a735984d41155bc1032e09bece8f8d66d">data</a> = malloc(outsds[ib].rowsperscan * outsds[ib].Np * DFKNTsize(outsds[ib].num_type));
<a name="l01551"></a>01551         <span class="keywordflow">if</span> (!outsds[ib].data) {
<a name="l01552"></a>01552             fputs(<span class="stringliteral">&quot;Error allocating memory.\n&quot;</span>, stderr);
<a name="l01553"></a>01553             <span class="keywordflow">return</span> 1;
<a name="l01554"></a>01554         }
<a name="l01555"></a>01555 
<a name="l01556"></a>01556         <span class="comment">/* set optional compression */</span>
<a name="l01557"></a>01557         <span class="keywordflow">if</span> (gzip) {
<a name="l01558"></a>01558             chunk_def.chunk_lengths[0] = chunk_def.comp.chunk_lengths[0] = outsds[ib].<a class="code" href="struct_s_d_s.html#ae4e2e1f4bcbc4bee7383f9bfb0c7efe4">edges</a>[0];
<a name="l01559"></a>01559             chunk_def.chunk_lengths[1] = chunk_def.comp.chunk_lengths[1] = outsds[ib].<a class="code" href="struct_s_d_s.html#ae4e2e1f4bcbc4bee7383f9bfb0c7efe4">edges</a>[1];
<a name="l01560"></a>01560             chunk_def.comp.comp_type = COMP_CODE_DEFLATE;
<a name="l01561"></a>01561             chunk_def.comp.cinfo.deflate.level = 4;
<a name="l01562"></a>01562             <span class="keywordflow">if</span> (SDsetchunk(outsds[ib].<span class="keywordtype">id</span>, chunk_def, HDF_CHUNK | HDF_COMP) == FAIL) {
<a name="l01563"></a>01563                 fprintf(stderr, <span class="stringliteral">&quot;Cannot set chunks for SDS %s\n&quot;</span>, outsds[ib].name);
<a name="l01564"></a>01564                 <span class="keywordflow">return</span> 1;
<a name="l01565"></a>01565             }
<a name="l01566"></a>01566         }
<a name="l01567"></a>01567 
<a name="l01568"></a>01568 
<a name="l01569"></a>01569         <a class="code" href="crefl_8c.html#a6866fc1eecb97cefe4e1cc38c302f18a">set_dimnames</a>(outsds[ib].Np, &amp;dimname1, &amp;dimname2);
<a name="l01570"></a>01570 
<a name="l01571"></a>01571         <span class="keywordflow">if</span> (verbose) printf(<span class="stringliteral">&quot;(%s x %s)\n&quot;</span>, dimname1, dimname2);
<a name="l01572"></a>01572 
<a name="l01573"></a>01573         <span class="comment">/* dimension names */</span>
<a name="l01574"></a>01574         <span class="keywordflow">if</span> ((dim_id = SDgetdimid(outsds[ib].<span class="keywordtype">id</span>, 0)) == -1) {
<a name="l01575"></a>01575             fputs(<span class="stringliteral">&quot;Error getting dimension ID1.\n&quot;</span>, stderr);
<a name="l01576"></a>01576             <span class="keywordflow">return</span> 1;
<a name="l01577"></a>01577         }
<a name="l01578"></a>01578         <span class="keywordflow">if</span> (SDsetdimname(dim_id, dimname1) == -1) {
<a name="l01579"></a>01579             fprintf(stderr, <span class="stringliteral">&quot;Cannot set first dimension name for SDS %s\n&quot;</span>, outsds[ib].name);
<a name="l01580"></a>01580             <span class="keywordflow">return</span> 1;
<a name="l01581"></a>01581         }
<a name="l01582"></a>01582         <span class="keywordflow">if</span> ((dim_id = SDgetdimid(outsds[ib].<span class="keywordtype">id</span>, 1)) == -1) {
<a name="l01583"></a>01583             fputs(<span class="stringliteral">&quot;Error getting dimension ID2.\n&quot;</span>, stderr);
<a name="l01584"></a>01584             <span class="keywordflow">return</span> 1;
<a name="l01585"></a>01585         }
<a name="l01586"></a>01586         <span class="keywordflow">if</span> (SDsetdimname(dim_id, dimname2) == -1) {
<a name="l01587"></a>01587             fprintf(stderr, <span class="stringliteral">&quot;Cannot set second dimension name for SDS %s\n&quot;</span>, outsds[ib].name);
<a name="l01588"></a>01588             <span class="keywordflow">return</span> 1;
<a name="l01589"></a>01589         }
<a name="l01590"></a>01590     }
<a name="l01591"></a>01591 
<a name="l01592"></a>01592     <span class="keywordflow">return</span> 0;
<a name="l01593"></a>01593 }
<a name="l01594"></a>01594 
<a name="l01595"></a>01595 
<a name="l01596"></a>01596 
<a name="l01597"></a>01597 <span class="comment">/**************************************************************************/</span>
<a name="l01613"></a><a class="code" href="crefl_8c.html#a3637dc4696007f69ab959a1389462340">01613</a> <span class="keywordtype">int</span> <a class="code" href="crefl_8c.html#a3637dc4696007f69ab959a1389462340">write_global_attributes</a>(int32 sd_id,
<a name="l01614"></a>01614                             <span class="keywordtype">char</span> *MOD021KMfile,
<a name="l01615"></a>01615                             <span class="keywordtype">char</span> *MOD02HKMfile,
<a name="l01616"></a>01616                             <span class="keywordtype">char</span> *MOD02QKMfile,
<a name="l01617"></a>01617                             <span class="keywordtype">float</span> maxsolz,
<a name="l01618"></a>01618                             <span class="keywordtype">int</span> sealevel,
<a name="l01619"></a>01619                             <span class="keywordtype">int</span> TOA,
<a name="l01620"></a>01620                             <span class="keywordtype">int</span> nearest)
<a name="l01621"></a>01621 {
<a name="l01622"></a>01622     <span class="keywordtype">char</span> *ptr;
<a name="l01623"></a>01623     <span class="keywordtype">int</span> j;
<a name="l01624"></a>01624     float32 f32;
<a name="l01625"></a>01625     uint8 u8;
<a name="l01626"></a>01626 
<a name="l01627"></a>01627     ptr = <a class="code" href="crefl_8c.html#ae2ceec62d3c6999bcb8db8df4d44a6d0">PROCESS_VERSION_NUMBER</a>;
<a name="l01628"></a>01628     j = strlen(ptr);
<a name="l01629"></a>01629     <span class="keywordflow">if</span> (SDsetattr(sd_id, <span class="stringliteral">&quot;ProcessVersionNumber&quot;</span>, DFNT_CHAR8, j, ptr)) <span class="keywordflow">return</span> 1;
<a name="l01630"></a>01630 
<a name="l01631"></a>01631     <span class="keywordflow">if</span> (MOD021KMfile) {
<a name="l01632"></a>01632         j = strlen(MOD021KMfile);
<a name="l01633"></a>01633         <span class="keywordflow">if</span> (SDsetattr(sd_id, <span class="stringliteral">&quot;1km_input_file&quot;</span>, DFNT_CHAR8, j, MOD021KMfile))
<a name="l01634"></a>01634             <span class="keywordflow">return</span> 1;
<a name="l01635"></a>01635     }
<a name="l01636"></a>01636 
<a name="l01637"></a>01637     <span class="keywordflow">if</span> (MOD02HKMfile) {
<a name="l01638"></a>01638         j = strlen(MOD02HKMfile);
<a name="l01639"></a>01639         <span class="keywordflow">if</span> (SDsetattr(sd_id, <span class="stringliteral">&quot;500m_input_file&quot;</span>, DFNT_CHAR8, j, MOD02HKMfile))
<a name="l01640"></a>01640             <span class="keywordflow">return</span> 1;
<a name="l01641"></a>01641     }
<a name="l01642"></a>01642 
<a name="l01643"></a>01643     <span class="keywordflow">if</span> (MOD02QKMfile) {
<a name="l01644"></a>01644         j = strlen(MOD02QKMfile);
<a name="l01645"></a>01645         <span class="keywordflow">if</span> (SDsetattr(sd_id, <span class="stringliteral">&quot;250m_input_file&quot;</span>, DFNT_CHAR8, j, MOD02QKMfile))
<a name="l01646"></a>01646             <span class="keywordflow">return</span> 1;
<a name="l01647"></a>01647     }
<a name="l01648"></a>01648 
<a name="l01649"></a>01649 
<a name="l01650"></a>01650     f32 = maxsolz;
<a name="l01651"></a>01651     <span class="keywordflow">if</span> (SDsetattr(sd_id, <span class="stringliteral">&quot;MaxSolarZenithAngle&quot;</span>, DFNT_FLOAT32, 1, &amp;f32))
<a name="l01652"></a>01652         <span class="keywordflow">return</span> 1;
<a name="l01653"></a>01653 
<a name="l01654"></a>01654     u8 = (uint8) sealevel;
<a name="l01655"></a>01655     <span class="keywordflow">if</span> (SDsetattr(sd_id, <span class="stringliteral">&quot;sealevel&quot;</span>, DFNT_UINT8, 1, &amp;u8)) <span class="keywordflow">return</span> 1;
<a name="l01656"></a>01656     u8 = (uint8) TOA;
<a name="l01657"></a>01657     <span class="keywordflow">if</span> (SDsetattr(sd_id, <span class="stringliteral">&quot;toa&quot;</span>, DFNT_UINT8, 1, &amp;u8)) <span class="keywordflow">return</span> 1;
<a name="l01658"></a>01658     u8 = (uint8) nearest;
<a name="l01659"></a>01659     <span class="keywordflow">if</span> (SDsetattr(sd_id, <span class="stringliteral">&quot;nearest&quot;</span>, DFNT_UINT8, 1, &amp;u8)) <span class="keywordflow">return</span> 1;
<a name="l01660"></a>01660 
<a name="l01661"></a>01661     <span class="keywordflow">return</span> 0;
<a name="l01662"></a>01662 }
<a name="l01663"></a>01663 
<a name="l01664"></a>01664 <span class="comment">/**************************************************************************/</span>
<a name="l01675"></a><a class="code" href="crefl_8c.html#afaf023b21ea740b2575e5d3bb2b84ccf">01675</a> <span class="keywordtype">int</span> <a class="code" href="crefl_8c.html#afaf023b21ea740b2575e5d3bb2b84ccf">range_check</a>(<span class="keywordtype">float</span> x,
<a name="l01676"></a>01676                 <span class="keywordtype">float</span> xmin,
<a name="l01677"></a>01677                 <span class="keywordtype">float</span> xmax)
<a name="l01678"></a>01678 {
<a name="l01679"></a>01679     <span class="keywordflow">return</span> (x &lt; xmin) || (x &gt; xmax);
<a name="l01680"></a>01680 }
</pre></div></div>
</div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr class="footer"/><address class="footer"><small>Generated on Sun Jun 5 2011 22:10:29 for dwh by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.2 </small></address>
</body>
</html>
